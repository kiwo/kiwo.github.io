<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.4" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">.NET, SQL and Javascript programmer</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                <li><a href="/">Blog</a></li>
                <li><a href="/about">About</a></li>
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="http://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Feb 17th, 2015</div>
    
    <h1><a href='/2015/02/how-i-fixed-a-bug-in-sql-server'>How I fixed a bug in SQL Server</a></h1>
    
    <div class="post-content">
        <p>Well, not really... I just reported it to Microsoft and then it got fixed. Anyway, here is the story.</p>
<p>Our production databases were migrated from SQL Server 2012 to SQL Server 2014. Among other improvements in the latter, <a href="http://blogs.msdn.com/b/psssql/archive/2014/04/01/sql-server-2014-s-new-cardinality-estimator-part-1.aspx">the new cardinality estimator was introduced</a>. In two words, cardinality estimator is a piece of SQL functionality which estimates how many rows the engine might get for a specific query or a query part. The new estimator is supposed to be smarter than the old one, of course. It takes more factors into account, and thus should give better results with some query plans. But &quot;new&quot; also means &quot;less tested&quot;...</p>
<p>Immediately after migration we found out that one of the stored procedures got much slower than before. That stored procedure was retrieving thousands of rows from a queue, and then did a series of transformations which took ages to complete. During the investigation we found that the query plan is far from being optimal, with massive scans of partitioned tables; and the reason was in ridiculously high estimations on one of the tables. That table was of moderate size (millions of rows), our query touched only some hundreds rows, while the estimate was... millions!</p>
<p>Here is a repro to show this issue on any test database (database must be in SQL Server 2014 compatibility mode):</p>
<pre class="highlight"><code class="hljs sql"><span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> [dbo].[Store](
    Id <span class="hljs-built_in">int</span> <span class="hljs-keyword">IDENTITY</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    City <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">Size</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    Name <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> [PK_Store] <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> CLUSTERED ([Id] <span class="hljs-keyword">ASC</span>)
 ) 

 <span class="hljs-keyword">GO</span>

 <span class="hljs-keyword">CREATE</span> NONCLUSTERED <span class="hljs-keyword">INDEX</span> [IX_Store] <span class="hljs-keyword">ON</span> [dbo].[Store]
(
    City <span class="hljs-keyword">ASC</span>,
    <span class="hljs-keyword">Size</span> <span class="hljs-keyword">ASC</span>
)

<span class="hljs-keyword">GO</span>
 <span class="hljs-keyword">TRUNCATE</span> <span class="hljs-keyword">TABLE</span> Store
<span class="hljs-keyword">INSERT</span> Store 
<span class="hljs-keyword">SELECT</span> i % <span class="hljs-number">101</span>, i % <span class="hljs-number">11</span>, <span class="hljs-string">'Store '</span> + <span class="hljs-keyword">CAST</span>(i <span class="hljs-keyword">AS</span> <span class="hljs-built_in">VARCHAR</span>)
  <span class="hljs-keyword">FROM</span> 
 (<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100000</span> ROW_NUMBER() OVER (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> s1.[object_id]) <span class="hljs-keyword">AS</span> i
  <span class="hljs-keyword">FROM</span> sys.all_objects  s1, sys.all_objects  s2) numbers
<span class="hljs-keyword">GO</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> StoreRequest (City <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>, <span class="hljs-keyword">Size</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>)

<span class="hljs-keyword">GO</span>
<span class="hljs-keyword">DELETE</span> StoreRequest
<span class="hljs-keyword">INSERT</span> StoreRequest <span class="hljs-keyword">values</span> (<span class="hljs-number">55</span>, <span class="hljs-number">1</span>)
<span class="hljs-keyword">INSERT</span> StoreRequest <span class="hljs-keyword">values</span> (<span class="hljs-number">66</span>, <span class="hljs-number">2</span>)

<span class="hljs-keyword">GO</span>

 <span class="hljs-keyword">SELECT</span> s.City
   <span class="hljs-keyword">FROM</span> StoreRequest <span class="hljs-keyword">AS</span> r
        <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Store <span class="hljs-keyword">AS</span> s  <span class="hljs-keyword">WITH</span>(<span class="hljs-keyword">INDEX</span>(IX_Store), FORCESEEK) 
                    <span class="hljs-keyword">ON</span> s.City = r.City <span class="hljs-keyword">AND</span> s.<span class="hljs-keyword">Size</span> = r.<span class="hljs-keyword">Size</span>
  <span class="hljs-keyword">WHERE</span> r.<span class="hljs-keyword">Size</span> &lt;&gt; <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> s.City &lt;&gt; <span class="hljs-number">55</span>
</span></code></pre><p>In this script I create two tables: Store with 100k rows and StoreRequest with 2 rows. And then I make a query where I join them on two columns. The WHERE clause contains two restrictions: one for each of the tables with OR clause in between. It sounds more complicated than it really is.</p>
<p>INDEX and FORCESEEK hints are there to force the engine to use this index to be able to see the statistics. Otherwise it considers the index to be too heavy to use. And that is why:</p>
<p><img src="/2015/02/how-i-fixed-a-bug-in-sql-server/2014estimates.png" alt="Execution plan in SQL Server 2014"></p>
<p>You see the significant error in Estimated Number of Rows vs Actual Number of Rows. The estimator actually thinks that the query is going to yield half of all rows in that table!</p>
<p>Good news: it&#39;s actually easy to fix that problem in this case. We should just change the WHERE clause to use same table for both sides of OR condition:</p>
<pre class="highlight"><code class="hljs stylus"> SELECT s<span class="hljs-class">.City</span>
   FROM StoreRequest AS r
        INNER JOIN Store AS s  <span class="hljs-function"><span class="hljs-title">WITH</span><span class="hljs-params">(INDEX(IX_Store)</span></span>, FORCESEEK) 
                    ON s<span class="hljs-class">.City</span> = r<span class="hljs-class">.City</span> AND s<span class="hljs-class">.Size</span> = r<span class="hljs-class">.Size</span>
  WHERE s<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">1</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">55</span>
</code></pre><p>Estimator is able to handle this situation correctly:</p>
<p><img src="/2015/02/how-i-fixed-a-bug-in-sql-server/2014estimates_good.png" alt="Execution plan in SQL Server 2014 as it should be"></p>
<p>Same fix worked for our production query. That query was much more complicated so it took more time to find the reason.</p>
<p>To prove that this bug is fresh for the new cardinality estimator, we can switch the original query to the legacy cardinality estimator with flag 9481:</p>
<pre class="highlight"><code class="hljs stylus"> SELECT s<span class="hljs-class">.City</span>
   FROM StoreRequest AS r
        INNER JOIN Store AS s  <span class="hljs-function"><span class="hljs-title">WITH</span><span class="hljs-params">(INDEX(IX_Store)</span></span>, FORCESEEK) 
                    ON s<span class="hljs-class">.City</span> = r<span class="hljs-class">.City</span> AND s<span class="hljs-class">.Size</span> = r<span class="hljs-class">.Size</span>
  WHERE r<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">1</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">55</span>
 <span class="hljs-function"><span class="hljs-title">OPTION</span><span class="hljs-params">(QUERYTRACEON <span class="hljs-number">9481</span>)</span></span> 
</code></pre><p>And then we get this:</p>
<p><img src="/2015/02/how-i-fixed-a-bug-in-sql-server/2012estimates.png" alt="Execution plan in SQL Server 2012"></p>
<p>Which is as good as the best attempt of SQL Server 2014 and much-much better than the worst one.</p>
<p>I posted this repro to <a href="https://connect.microsoft.com/SQLServer/feedback/details/1086125/cardinality-estimator-2014-is-off-with-or-in-where-clause">SQL Server forum</a>. Here is the comment that I got from Erland Sommarskog, SQL Server MVP:</p>
<blockquote>
<p>The estimate here is clearly incorrect. SQL Server knows the density of Size and City. It knows the cardinality of the temp table. The density information gives how many rows the join will produce. The WHERE clause will then remove a certain number of rows. With no statistics for the temp table, it does not know how many, but it will apply some standard guess.</p>
<p>50000 is a completely bogus number, because the join cannot produce that many rows, and SQL Server is able to compute the join with out the WHERE clause decently. (Well, it estimates 90, when the number is 180.) No, this is obviously a case of the cardinality estimator giving up completely.</p>
<p>It is worth noting that both these WHERE clauses gives reasonable estimates:</p>
<pre class="highlight"><code class="hljs stylus">WHERE r<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR r<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
WHERE s<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
</code></pre><p>Whereas these two gives the spooky 50000:</p>
<pre class="highlight"><code class="hljs stylus">WHERE s<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR r<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
WHERE r<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
</code></pre><ul>
<li>Erland Sommarskog</li>
</ul>
</blockquote>
<p>Then I also posted it to <a href="https://connect.microsoft.com/SQLServer/feedback/details/1086125/cardinality-estimator-2014-is-off-with-or-in-where-clause">SQL Server feedback issue tracker</a> and after a couple of weeks got a reply from Microsoft employee:</p>
<blockquote>
<p>Thank you for reporting this issue. I am happy to let you know that we have a fix for this problem, which will be available in one of the upcoming servicing releases for SQL Server 2014 (the details will be published in a KB).</p>
<ul>
<li>Thanks, Alexey, SQL Development</li>
</ul>
</blockquote>
<p>Thanks to Erlang and Alexey for their help. I look forward to the servicing release!
Happy coding!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/execution-plan/'>execution plan</a>, <a href='/tags/query-plan/'>query plan</a>, <a href='/tags/database/'>database</a>, <a href='/tags/repro/'>repro</a>, <a href='/tags/erland-sommarskog/'>Erland Sommarskog</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 5th, 2015</div>
    
    <h1><a href='/2015/02/how-we-do-message-processing'>How we do message processing</a></h1>
    
    <div class="post-content">
        <p>Our team develops a back-end system that processes messages from mobile devices. The devices collect information from complex machines and send messages to our data center. In this article I want to share our approaches to building such processing software. The ideas are quite general and can be applied to any system of the following architecture:
<img src="/2015/02/how-we-do-message-processing/architecture.jpg" alt="System architecture"></p>
<p>The devices use communication channels to send messages to our gateway - the input point of our application. The application&#39;s goal is to understand what came in, do the required actions and save the information into the database for further processing. Let&#39;s consider the database to be the end point of processing. Sounds easy, right? But some difficulties appear with the growth of amount and diversity of incoming messages; so let&#39;s look at some of them.</p>
<p>A few words on the target load level. Our system processes the messages from tens of thousands of devices, and we get from several hundreds to a thousand messages per second. If you numbers are different by orders of magnitude, it might be the case that your problems are going to look completely different and you&#39;ll need a different set of tools to solve them.</p>
<p>Apart from the number of messages itself, there is a problem of irregularity and peak times. The application must be ready for relatively short peaks which might be about ten times higher than the average expectation. To address this problem we organize the system as a sequence of queues and corresponding processors.</p>
<p>The input gateway doesn&#39;t do much of real job: it just receives a message from a client and puts it into the queue. This operation is very cheap, thus the gateway is capable of accepting a vast number of messages per second. Afterwards a separate process retrieves several messages - the amount it wants to get - from the queue and does the hard work. The processing happens asynchronously while the load on the system remains limited. Perhaps the time in the queue grows at peaks, but that&#39;s it.</p>
<p>Normally the message processing is non-trivial and consists of several actions. Here we get to the next logical step: we break down the job into several stages, each one having a separate queue and a dedicated processor. The queues and processors are independent and may reside on separate physical servers; and we can tune and scale them independently:
<img src="/2015/02/how-we-do-message-processing/sequence.jpg" alt="Sequence-based architecture"></p>
<p>The first queue contains the messages from devices as-is, without decoding or transforming them. The first processor decodes them and puts them into the second queue. The second processor could, for instance, call a third-party service and enrich the message with some relevant information, and the third processor could save that information into the database.</p>
<p>These are the basics, so what do we still need to consider?</p>
<h3 id="define-your-values">Define your values</h3>
<ol>
<li><p>Simplicity of creation, change and support</p>
<p> Asynchronous distributed message processing brings quite some extra complexity into the software product. You should constantly work on reducing this price. The code gets optimized to be, at first place, readable and straightforward for all the team members, cheap to be changed and supported. If nobody but the author can decrypt the code, no great architecture will make the team happy.</p>
<p> This statements looks obvious, but it might take quite some time and effort before the team starts to consistently implement this principle and not just declare it. Do the regular refactoring whenever you feel you can make the code a bit better and simpler. All the source code should get reviewed and the most critical parts are better to be developed in pair.</p>
</li>
<li><p>Fault tolerance</p>
<p> It makes sense to define your policies of hardware or subsystem failures handling from the very beginning. They will differ for different products. It might be the case that someone can throw away all the messages that come in during 5 minutes of a server reboot.</p>
<p> In our system we don&#39;t want to lose messages. If a particular service is not currently available, a database call times out, or there is a random processing error, it must not result in information loss. The affected messages must be saved inside the queue and will be processed right after the problem is fixed.</p>
<p> Suppose your code on one server calls a web service on another server in synchronous manner. If the second server is not available, the processing will fail, and you can&#39;t do anything but log the error. In case of asynchronous processing the message will wait for the second server to go live again.</p>
</li>
<li><p>Performance</p>
<p> Processing rate per second, latency, load on the servers - all these are important parameters of application performance. That&#39;s why we choose the architecture to be flexible.</p>
<p> Although, don&#39;t pay TOO much attention to optimization from the very beginning. Usually the majority of performance issues is created by relatively small pieces of code. Unfortunately people tend to be very bad at predicting where exactly those issues are going to appear. People write <a href="http://carlos.bueno.org/optimization/">books on pre-mature optimization</a>. So make sure that your architecture allows you to fine-tune the system and forget about optimization until the first load testing.</p>
<p> At the same time, and for this reason, start running the load tests early on, and then include them into your standard testing procedure. Start optimizing only when the tests reveal a specific performance problem.</p>
</li>
</ol>
<h3 id="fine-tune-your-mindset">Fine tune your mindset</h3>
<ol>
<li><p>Operate queues and asynchronous processors</p>
<p> I already described this above. Our main tools are queues and processors. While the classic approach is &quot;get request, call remote code, wait for response, return it back to the originator&quot;, now we should always use &quot;get a message from a queue, process it, send a message to another queue&quot;. The right mix of these two approaches should enable both scalability and ease of development.</p>
</li>
<li><p>Break the processing down into several stages</p>
<p> If message processing is complex enough to be split into several stages, do that by creating several queues and processors. Make sure that you don&#39;t make it too complex to understand by unneeded fragmentation: the right balance is important. Quite often you will see a split which feels natural for developers. If not, try thinking of possible failure points. If there are multiple reasons why a processor may fail, consider its breakdown.</p>
</li>
<li><p>Don&#39;t mix decoding and processing</p>
<p> Usually the messages arrive encoded with a protocol which can be binary, XML, JSON, etc. Decode them into your native format as soon as possible. This will help you solve two problems. First, you might need to support multiple protocols; and after decoding you unify the format of all further messages. Second, logging and debugging gets simpler.</p>
</li>
<li><p>Make the queues topology configurable</p>
<p> Structure your code in a way that allows you to change the configuration of queues relatively easy. Splitting a processor into two parts should not result in tons of refactoring. Don&#39;t make your code depend on a specific queue mechanism implementation: tomorrow you might want to change it.</p>
</li>
<li><p>Do batch processing</p>
<p> Normally it makes sense to receive messages from a queue in batches, not one by one. The services that you use might accept arrays for faster processing and in this case one call will always be faster than a handful of small ones. One insertion of 100 rows into database is faster than 100 remote insertions.</p>
</li>
</ol>
<h3 id="create-tooling">Create tooling</h3>
<ol>
<li><p>Implement total monitoring</p>
<p> Invest into monitoring tools. It should be easy to see the charts of throughput, average processing time, queue size and time since last message with breakdown by queue.
<img src="/2015/02/how-we-do-message-processing/monitoring.jpg" alt="Queue monitoring"></p>
<p> We use monitoring tools not only on production and staging environments but also on testing servers and even developer&#39;s machines. Carefully baked charts are helpful during debug and load testing procedures.</p>
</li>
<li><p>Test everything</p>
<p> Message processing systems are perfect fields to apply fully automated testing. Input data protocols are well-defined and there is no human interaction. Cover your code with unit tests. Make your queues pluggable so that you could mock your real queues out with test in-memory queues to run quick intercommunication tests. Finally, create full-blown integration tests which should be run on staging environment (and preferably also on production).</p>
</li>
<li><p>Store the failed messages</p>
<p> Usually you don&#39;t want one erroneous message to stop the complete queue processing. Being able to diagnose the problem is equally important. So put all the failed messages into a specialized storage and put a spotlight on it. Make a tool to move messages back to the relevant queue as soon as the failure reason is addressed.</p>
<p> Same or similar mechanism can be used to store the messages to be processed at some point of time in the future. Keep them in that special storage and check periodically if now is time to proceed.</p>
</li>
<li><p>Automate the deployment</p>
<p> Application setup and update must require just one or two clicks. Strive for frequent updates on production; ideally - automated deployment on every commit to the dedicated branch. Deployment scripts or tools will help developers maintain their personal and testing environments up-to-date.</p>
</li>
</ol>
<h3 id="wrapping-up">Wrapping up</h3>
<p>Clean and understandable architecture provides developers with a good means of communication, helps figure out the similar vision and concepts. Architecture metaphor expressed in form of a picture or short document will bring you closer to smart design, will help find errors or plan a refactoring.</p>
<p>Happy message processing!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/architecture/'>architecture</a>, <a href='/tags/design/'>design</a>, <a href='/tags/messages/'>messages</a>, <a href='/tags/message-processing/'>message processing</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Oct 16th, 2014</div>
    
    <h1><a href='/2014/10/16/nice-way-to-kill-your-sql-server'>Nice way to kill your SQL Server</a></h1>
    
    <div class="post-content">
        <p>Are you getting enormous amount of </p>
<pre class="highlight"><code class="hljs nimrod"><span class="hljs-type">The</span> activated <span class="hljs-keyword">proc</span> '...' running on queue '...' output the following:
'<span class="hljs-type">The</span> service queue <span class="hljs-string">"..."</span> <span class="hljs-keyword">is</span> currently disabled.
</code></pre><p>errors from SQL Server? Keep on reading!</p>
<p>Yesterday, when I came back from my lunch, I got a heads-up from Windows:
<img src="/2014/10/16/nice-way-to-kill-your-sql-server/low-disk-space.gif" alt="Low disk space"></p>
<p>And it was literally out of space: 0 (zero) bytes available on C: drive. Wow...</p>
<p>I cleaned up the binary files from my developments, which gave me 3 GB of free space and some time to do the investigation. A short time, because disk space was counting down at about 300 MB per minute.</p>
<p>It appeared that the SQL Server error log files grew up to 53 GB and were still growing. Here is the default folder where you can find them:</p>
<p><img src="/2014/10/16/nice-way-to-kill-your-sql-server/errorlog.png" alt="SQL Server error log"></p>
<p>To gain more time, I executed the command</p>
<pre class="highlight"><code class="hljs bash"><span class="hljs-keyword">exec</span> sp_cycle_error
</code></pre><p>is Management Studio. It renames current ERRORLOG file to ERRORLOG.1 and starts the new current. So now it was safe to delete all .1/.2/etc files and get those 53 GB back. Huh...</p>
<p>Now it&#39;s time to figure out the actual issue. Go to Management Studio -&gt; your server -&gt; Management -&gt; SQL Server Logs -&gt; Current -&gt; (right click) -&gt; View SQL Server Log</p>
<p>I saw millions of the following messages there (let&#39;s say my queue is named XQueue for simplicity):</p>
<pre class="highlight"><code class="hljs nimrod"><span class="hljs-type">The</span> activated <span class="hljs-keyword">proc</span> '[dbo].[<span class="hljs-type">XQueueProcessor</span>]' running 
on queue 'dbo.<span class="hljs-type">XQueue</span>' output the following:
'<span class="hljs-type">The</span> service queue <span class="hljs-string">"XQueue"</span> <span class="hljs-keyword">is</span> currently disabled.
</code></pre><p>So, it looks like there is a problem with SQL Server Service Broker, which is constantly trying to read something from disabled queue. Isn&#39;t it supposed to stop after 5 attempts (a.k.a. poison messages)? Ok, keep on troubleshooting.</p>
<p>First, let check if the queue is actually disabled</p>
<pre class="highlight"><code class="hljs oxygene"><span class="hljs-keyword">SELECT</span> Name, is_receive_enabled, is_enqueue_enabled
  <span class="hljs-keyword">FROM</span> sys.service_queues 
 <span class="hljs-keyword">WHERE</span> Name = <span class="hljs-string">'XQueue'</span>  
</code></pre><p>Yep, it&#39;s disabled:
<img src="/2014/10/16/nice-way-to-kill-your-sql-server/qdisabled.png" alt="XQueue disabled"></p>
<p>Do we have anything queued?</p>
<pre class="highlight"><code class="hljs oxygene"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> *
  <span class="hljs-keyword">FROM</span> [XQueue] <span class="hljs-keyword">WITH</span>(NOLOCK) 
</code></pre><p>I got 9 rows back. This means we got some messages en-queued, and one of them failed to process, the message was considered as poison and the queue was disabled (which is good), but the processor still seems to be running in eternal loop.</p>
<p>So, let&#39;s have a look at the processor. We had something like that:</p>
<pre class="highlight"><code class="hljs oxygene"><span class="hljs-keyword">CREATE</span> <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> [<span class="hljs-title">dbo</span>].[<span class="hljs-title">XQueueProcessor</span>]
<span class="hljs-title">AS</span>
<span class="hljs-title">BEGIN</span>
    <span class="hljs-title">DECLARE</span> 
        @<span class="hljs-title">queuing_order</span> <span class="hljs-title">BIGINT</span>
        ,@<span class="hljs-title">conversation_handle</span> <span class="hljs-title">UNIQUEIDENTIFIER</span>
        ,@<span class="hljs-title">message_enqueue_time</span> <span class="hljs-title">DATETIME</span>
        ,@<span class="hljs-title">message_type_name</span> <span class="hljs-title">VARCHAR</span><span class="hljs-params">(156)</span>
        ,@<span class="hljs-title">message_body</span> <span class="hljs-title">VARBINARY</span><span class="hljs-params">(MAX)</span>;</span>

    <span class="hljs-keyword">WHILE</span>(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>) -- MAIN <span class="hljs-keyword">WHILE</span> <span class="hljs-keyword">LOOP</span> RECEIVING THE MESSAGE BATCHES
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">BEGIN</span> TRANSACTION
        <span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">TRY</span>
            WAITFOR(RECEIVE TOP(<span class="hljs-number">1</span>)
                        @queuing_order = [queuing_order],
                        @conversation_handle = [conversation_handle],
                        @message_enqueue_time = message_enqueue_time,
                        @message_type_name = message_type_name,
                        @message_body = message_body
                    <span class="hljs-keyword">FROM</span> [dbo].[XQueue]), TIMEOUT <span class="hljs-number">10</span>

            <span class="hljs-keyword">IF</span> (@@ROWCOUNT = <span class="hljs-number">0</span>)
            <span class="hljs-keyword">BEGIN</span>
                ROLLBACK TRANSACTION
                <span class="hljs-keyword">BREAK</span>
            <span class="hljs-keyword">END</span>    

            -- SOME CRUD OPERATIONS HAPPEN HERE        

            COMMIT TRANSACTION
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">TRY</span>
        <span class="hljs-keyword">BEGIN</span> CATCH            
            DECLARE @Error varchar(<span class="hljs-number">4000</span>) = ERROR_MESSAGE()
            PRINT @Error
            ROLLBACK TRANSACTION
        <span class="hljs-keyword">END</span> CATCH        
    <span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>
</code></pre><p>A-ha! So, what happens when an error occurs during the message processing? Control goes to CATCH block, error message is printed out (when we are in Service Broker, print goes directly to ERRORLOG file which we saw already), the transaction is rolled back... But we still are inside eternal loop, no BREAK or RETURN statement there, so the processor will try again to get the same message from the queue. After 5th attempt, the message will be marked as poison, the queue will get disabled, but the loop will keep running! The exception will change to &quot;The service queue is currently disabled&quot; and voila, CPU is busy and error logs are floating the disk.</p>
<p>The fix is pretty trivial, just change the CATCH block to</p>
<pre class="highlight"><code class="hljs monkey">BEGIN <span class="hljs-keyword">CATCH</span>            
    DECLARE @<span class="hljs-built_in">Error</span> varchar(<span class="hljs-number">4000</span>) = ERROR_MESSAGE()
    <span class="hljs-built_in">PRINT</span> @<span class="hljs-built_in">Error</span>
    ROLLBACK TRANSACTION
    <span class="hljs-keyword">RETURN</span>
<span class="hljs-keyword">END</span> <span class="hljs-keyword">CATCH</span>        
</code></pre><p>Be careful!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/bugs/'>Bugs</a>, <a href='/tags/error-log/'>Error log</a>, <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/sql-server-service broker/'>SQL Server Service Broker</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jun 3rd, 2014</div>
    
    <h1><a href='/2014/06/03/sql-produce-resultset-with-n-rows'>SQL: produce resultset with N rows</a></h1>
    
    <div class="post-content">
        <p>Let&#39;s talk about T-SQL today.</p>
<p>Sometimes you need to produce a result set, which would contain N rows with numbers 1...N in each row. For example, I needed to calculate some statistics per week for N weeks starting from today and going back to the past.</p>
<p>Here is a table funtion which does the enumeration:</p>
<pre class="highlight"><code class="hljs sql"><span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> dbo.fnEnumerateNumbers(@<span class="hljs-keyword">max</span> <span class="hljs-built_in">int</span>) 
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span> 
<span class="hljs-keyword">RETURN</span> 
<span class="hljs-keyword">WITH</span>
 E1(N) <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
           <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
           <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
           <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>),                 <span class="hljs-comment">--10E1  or 10 rows</span>
 E2(N) <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> E1 a, E1 b), <span class="hljs-comment">--10E2  or 100 rows</span>
 E4(N) <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> E2 a, E2 b), <span class="hljs-comment">--10E4  or 10000 rows</span>
 E8(N) <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> E4 a, E4 b)  <span class="hljs-comment">--10E8  or 100000000 rows</span>
<span class="hljs-keyword">SELECT</span> TOP (@<span class="hljs-keyword">max</span>) N = ROW_NUMBER() OVER (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span>)) 
  <span class="hljs-keyword">FROM</span> E8
</span></code></pre><p>Usage is trivial:</p>
<pre class="highlight"><code class="hljs stylus">SELECT N
  FROM dbo.<span class="hljs-function"><span class="hljs-title">fnEnumerateNumbers</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span></span>
</code></pre><p>And here is how I solved the task of enumerating weeks:</p>
<pre class="highlight"><code class="hljs stylus">SELECT <span class="hljs-function"><span class="hljs-title">dateadd</span><span class="hljs-params">(week, <span class="hljs-number">1</span> - N, getutcdate()</span></span>) 
  FROM dbo.<span class="hljs-function"><span class="hljs-title">fnEnumerateNumbers</span><span class="hljs-params">(<span class="hljs-number">100</span>)</span></span>
</code></pre><p>There are multiple possibilities to implement similar function, but I believe this way is the best one in terms of performance. No temporary tables, no table reads, no dependencies on table existance, and you can define your maximum yourself.</p>
<p>Happy coding!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/performance/'>performance</a>, <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/t-sql/'>T-SQL</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">May 21st, 2014</div>
    
    <h1><a href='/2014/05/21/sgen-to-precompile-classes-for-xmpserializer'>Sgen to precompile classes for XmlSerializer</a></h1>
    
    <div class="post-content">
        <p>During my investigation of our ASP.NET application performance issue, I&#39;ve found out that XmlSerializer may require a long warm-up. The first time, when it&#39;s used for a specific class (de-)serialization, can take up to 500 ms om my machine! We use XmlSerializer to encode/decode user preferences. Having 40 different classes being deserialized at user login lead to a massive delay of 14 seconds. This is only for the first user login after the application start-up, but you do quite a lot of &#39;first times&#39; every day while developing the application.</p>
<p>These delays are caused by the runtime which prepares and compiles the strongly typed classes for serialization in runtime. Not sure why it&#39;s SO slow, but probably things might go wrong.</p>
<p>There is a simple solution for this problem: create those helper classes at build time, pack it into an assembly and ship it as part of your .NET application. The tool that does this is called Sgen.exe, and it is a part of .NET SDK. So, we just need to use it in our project.</p>
<p>The easiest way is to add a post-build event in your CS project properties. The event would look like</p>
<p>sgen.exe /force /assembly:&quot;$(TargetPath)&quot;
After re-compiling the project, you should see a new assembly in Bin directory, which has the name ending with XmlSerializers.dll. That&#39;s the new assembly which will save you several seconds on each application start-up. It will be automatically copied to Bin directory of the projects which reference the original assembly with your serializable classes, so no other actions needed.</p>
<p>However, this command might fail. Sgen tool will try to prepare the helper classes for each class in your assembly, which might not be possible. Then you&#39;ll get some error messages in Visual Studio. In this case, you might want to add a &quot;/types&quot; parameter, explicitly listing the class names to precompile. But I have a better solution for you.</p>
<p>It&#39;s quite possible that you use MSBuild for regular automated builds of your project. We do. In this case a post-build event in the project properties won&#39;t work during those build. Then, do not add any post-build events, but instead open your .csproj file in plain text editor, and search for the following commented section:</p>
<pre class="highlight"><code class="hljs xml"><span class="hljs-comment">&lt;!-- To modify your build process, add your task inside one of the targets below and uncomment it. 
   Other similar extension points exist, see Microsoft.Common.targets.
&lt;Target Name="BeforeBuild"&gt;
&lt;/Target&gt;
&lt;Target Name="AfterBuild"&gt;
&lt;/Target&gt;
--&gt;</span>
</code></pre><p>Uncomment the second XML node and substitute it with something like this:</p>
<pre class="highlight"><code class="hljs nix">&lt;Target <span class="hljs-variable">Name=</span><span class="hljs-string">"AfterBuild"</span> <span class="hljs-variable">DependsOnTargets=</span><span class="hljs-string">"AssignTargetPaths;Compile;ResolveKeySource"</span> <span class="hljs-variable">Inputs=</span><span class="hljs-string">"$(MSBuildAllProjects);@(IntermediateAssembly)"</span> <span class="hljs-variable">Outputs=</span><span class="hljs-string">"$(OutputPath)$(_SGenDllName)"</span>&gt;
    &lt;ItemGroup&gt;
      &lt;SgenTypes <span class="hljs-variable">Include=</span><span class="hljs-string">"MyNamespace.MySerializableClass1"</span> /&gt;
      &lt;SgenTypes <span class="hljs-variable">Include=</span><span class="hljs-string">"MyNamespace.MySerializableClass2"</span> /&gt;
      &lt;SgenTypes <span class="hljs-variable">Include=</span><span class="hljs-string">"MyNamespace.MySerializableClassN"</span> /&gt;
    &lt;/ItemGroup&gt;
    &lt;Delete <span class="hljs-variable">Files=</span><span class="hljs-string">"$(TargetDir)$(TargetName).XmlSerializers.dll"</span> <span class="hljs-variable">ContinueOnError=</span><span class="hljs-string">"true"</span> /&gt;
    &lt;SGen <span class="hljs-variable">BuildAssemblyName=</span><span class="hljs-string">"$(TargetFileName)"</span> <span class="hljs-variable">BuildAssemblyPath=</span><span class="hljs-string">"$(OutputPath)"</span> <span class="hljs-variable">References=</span><span class="hljs-string">"@(ReferencePath)"</span> <span class="hljs-variable">ShouldGenerateSerializer=</span><span class="hljs-string">"true"</span> <span class="hljs-variable">UseProxyTypes=</span><span class="hljs-string">"false"</span> <span class="hljs-variable">KeyContainer=</span><span class="hljs-string">"$(KeyContainerName)"</span> <span class="hljs-variable">KeyFile=</span><span class="hljs-string">"$(KeyOriginatorFile)"</span> <span class="hljs-variable">DelaySign=</span><span class="hljs-string">"$(DelaySign)"</span> <span class="hljs-variable">ToolPath=</span><span class="hljs-string">"$(SGenToolPath)"</span> <span class="hljs-variable">Types=</span><span class="hljs-string">"@(SgenTypes)"</span>&gt;
      &lt;Output <span class="hljs-variable">TaskParameter=</span><span class="hljs-string">"SerializationAssembly"</span> <span class="hljs-variable">ItemName=</span><span class="hljs-string">"SerializationAssembly"</span> /&gt;
    &lt;/SGen&gt;
&lt;/Target&gt;
</code></pre><p>The ItemGroup lists all the classes that you need to precompile. You can omit this section and Types attribute of SGen node if you want to compile all classes in assembly.
Have a nice application start-up boost!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/-net/'>.NET</a>, <a href='/tags/asp-net/'>ASP.NET</a>, <a href='/tags/c#/'>C#</a>, <a href='/tags/debugging/'>debugging</a>, <a href='/tags/msbuild/'>MSBuild</a>, <a href='/tags/performance/'>performance</a>, <a href='/tags/sgen/'>Sgen</a>, <a href='/tags/xmlserializer/'>XmlSerializer</a>
    </div>
    
</article>


<div class="page-nav">
    
    <a class="page-nav-newer" href="/5"><span class="icon icon-arrow-left-2"></span> Next page</a>
    
    
    <a class="page-nav-older" href="/7">Previous page <span class="icon icon-arrow-right-2"></span></a>
    
</div>

<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy C#, Javascript and SQL development and I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="http://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="http://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2016 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>