<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.4" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">F#, C#, JS, SQL, Azure programmer</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                <li><a href="/">Blog</a></li>
                <li><a href="/about">About</a></li>
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="http://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Apr 8th, 2015</div>
    
    <h1><a href='/2015/04/unit-testing-null-parameter-checks'>Unit testing null parameter checks</a></h1>
    
    <div class="post-content">
        <p>We use constructor dependency injection throughout our application. This means that most service classes have constructors, which accept all dependencies in form of interfaces. They are then saved to private fields to be used while class methods are executed. Here is an example (all examples below are in C#):</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VeryUsefulClass</span> : <span class="hljs-title">IVeryUsefulClass</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ISomething something;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ISomethingElse somethingElse;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">VeryUsefulClass</span><span class="hljs-params">(ISomething something, ISomethingElse somethingElse)</span>
    </span>{
        <span class="hljs-keyword">this</span>.something = something;
        <span class="hljs-keyword">this</span>.somethingElse = somethingElse;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> AwesomeResponse <span class="hljs-title">DoUsefullStaff</span><span class="hljs-params">(ImportantRequest request)</span>
    </span>{
        <span class="hljs-keyword">this</span>.something.DoSomething();
        <span class="hljs-keyword">this</span>.somethingElse.DoSomethingElse();
        <span class="hljs-keyword">return</span> ...;
    }
}
</code></pre><p>We also use TDD, which means we must write unit tests for every aspect of our code. So I want to discuss one specific aspect: guarding the constructor parameters from null values and testing this guard. Here is one possible way to write such tests (with NUnit and Moq):</p>
<pre class="highlight"><code class="hljs cs">[TestFixture]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VeryUsefulClassTests</span>
{
    [Test]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WhenSomethingIsNullConstructorThrowsNullException</span><span class="hljs-params">()</span>
    </span>{
        Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; 
            <span class="hljs-keyword">new</span> VeryUsefulClass(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Mock&lt;ISomethingElse&gt;.Object));
    }

    [Test]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WhenSomethingElseIsNullConstructorThrowsNullException</span><span class="hljs-params">()</span>
    </span>{
        Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; 
            <span class="hljs-keyword">new</span> VeryUsefulClass(<span class="hljs-keyword">new</span> Mock&lt;ISomething&gt;.Object, <span class="hljs-keyword">null</span>));
    }

    [Test]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ImportantRequestProducesAwesomeResponse</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">var</span> target = <span class="hljs-keyword">new</span> VeryUsefulClass(<span class="hljs-keyword">new</span> Mock&lt;ISomething&gt;.Object, 
            <span class="hljs-keyword">new</span> Mock&lt;ISomethingElse&gt;.Object);
        ...
    }

    ...
}
</code></pre><p>The tests are small and each one tests just one thing. But it looks like we have a bit too much duplication and &quot;noise&quot;: too much service code around real code under test. </p>
<h2 id="make-it-better">Make it better</h2>
<p>Now let&#39;s say we need to introduce another dependency into our useful class: ISomethingNew. The constructor signature will change to</p>
<pre class="highlight"><code class="hljs r">public VeryUsefulClass(ISomething something, 
    ISomethingElse somethingElse, 
    ISomethingNew somethingNew)
{
    <span class="hljs-keyword">...</span>
}
</code></pre><p>So, how many places do we have to change in our test class? One per each test, which includes one per each constructor parameter. Quite a lot! If we have a class with many dependencies, we are in trouble. So, before introducing the new dependency, let&#39;s refactor the tests. First, let&#39;s declare all mocks as private fields and create them in set-up method:</p>
<pre class="highlight"><code class="hljs cs">[TestFixture]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VeryUsefulClassTests</span>
{
    <span class="hljs-keyword">private</span> Mock&lt;ISomething&gt; something;
    <span class="hljs-keyword">private</span> Mock&lt;ISomethingElse&gt; somethingElse;

    [SetUp]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetUp</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">this</span>.something = <span class="hljs-keyword">new</span> Mock&lt;ISomething&gt;();
        <span class="hljs-keyword">this</span>.somethingElse = <span class="hljs-keyword">new</span> Mock&lt;ISomethingElse&gt;();
    }
...
</code></pre><p>This way the same clean mocks will be available for each and every test. To make use of them, let&#39;s create GetTarget method which will create an instance of class under test</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">private</span> VeryUsefulClass <span class="hljs-title">GetTarget</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">VeryUsefulClass</span><span class="hljs-params">(<span class="hljs-keyword">this</span>.something.Object, <span class="hljs-keyword">this</span>.somethingElse.Object)</span></span>;
}
</code></pre><p>Now we are ready to rewrite our test methods with less duplication</p>
<pre class="highlight"><code class="hljs cs">[Test]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WhenSomethingIsNullConstructorThrowsNullException</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">this</span>.something = <span class="hljs-keyword">null</span>;
    Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; <span class="hljs-keyword">this</span>.GetTarget());
}

[Test]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WhenSomethingElseIsNullConstructorThrowsNullException</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">this</span>.somethingElse = <span class="hljs-keyword">null</span>;
    Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; <span class="hljs-keyword">this</span>.GetTarget());
}

[Test]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ImportantRequestProducesAwesomeResponse</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">var</span> target = <span class="hljs-keyword">this</span>.GetTarget();
    ...
}
</code></pre><p>So, how many constructor calls do we have to change when we introduce a new dependency now? Just one for the complete test class!</p>
<p>I strongly believe that readability of your test classes is very important. If you make your tests short, expressive and easy to read, your tests will have much higher value: not only the safety net for classes, but also nice documentation which is easy to use and support.</p>
<h2 id="make-it-shine">Make it shine</h2>
<p>I&#39;m still not quite satisfied with the amount of code we have to write for such a simple thing as the validation of ArgumentNullException being thrown from constructors. Imagine this: we have hundreds or thousands of classes which follow this same pattern, and we end up writing thousands tests which look almost exactly the same... </p>
<p>I solved it with a simple helper method:</p>
<pre class="highlight"><code class="hljs undefined">public void ConstructorMustThrowArgumentNullException(Type type)
{
    foreach (var constructor in type.GetConstructors())
    {
        var parameters = constructor.GetParameters();
        var mocks = parameters.Select(
            p =&gt;
                {
                    Type mockType = typeof(Mock&lt;&gt;).MakeGenericType(
                        new[] { p.ParameterType });
                    return (Mock)Activator.CreateInstance(mockType);
                }).ToArray();

        for (int i = 0; i &lt; parameters.Length; i++)
        {
            var mocksCopy = mocks.Select(m =&gt; m.Object).ToArray();
            mocksCopy[i] = null;
            try
            {
                constructor.Invoke(mocksCopy);
                Assert.Fail("ArgumentNullException expected for parameter {0} of 
                             constructor, but no exception was thrown", 
                             parameters[i].Name);
            }
            catch (TargetInvocationException ex)
            {
                Assert.AreEqual(typeof(ArgumentNullException), 
                    ex.InnerException.GetType(), 
                    string.Format("ArgumentNullException expected for parameter {0} of 
                        constructor, but exception of type {1} was thrown", 
                        parameters[i].Name, ex.InnerException.GetType()));
            }
        }
    }
}
</code></pre>
<p>It accepts a type as its only input parameter (obviously, it&#39;s easy to make it generic or an extension method). Then, using the reflection, it iterates through the input parameters of a constructor, and passes one null value and mocks all other parameters. It expects ArgumentNullException to be thrown on each call.</p>
<p>You could write one test for all classes in a namespace or in assembly, if the pattern is applied consistently there! And it will let you know when one of your new classes violates the common rule, with zero extra effort.</p>
<p>Does anyone know the library which would do that without me inventing the bicycle myself?</p>
<p>Happy coding!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/unit-testing/'>unit testing</a>, <a href='/tags/dependency-injection/'>dependency injection</a>, <a href='/tags/guard/'>guard</a>, <a href='/tags/clean-code/'>clean code</a>, <a href='/tags/best-practices/'>best practices</a>, <a href='/tags/reflection/'>reflection</a>, <a href='/tags/c#/'>C#</a>, <a href='/tags/code-samples/'>code samples</a>, <a href='/tags/tdd/'>TDD</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 15th, 2015</div>
    
    <h1><a href='/2015/03/the-green-hackfest-my-first-hackathon'>The Green Hackfest - my first hackathon</a></h1>
    
    <div class="post-content">
        <p>In this post I&#39;d like to share my experience about the first hackathon that I took part in. It was called <a href="http://the-hackfest.com/past-hacks/green-hackfest-utrecht-2014.html">The Green Hackfest</a> and took place in Utrecht, the Netherlands on 10-12 October 2014.</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/hackfest_banner.jpg" alt="Green Hackfest"></p>
<p>A brief introduction on what hackathon is. A hackathon, or a hackfest in this case (people used these words interchangeably), is an event for programmers, engineers, designers and entrepreneurs where they can get together, form teams and work on solving problems in creative way. The time is very limited, usually from 12 to 24 hours, but in this case we had a &#39;marathon&#39; of 48 hours. At the start, teams get the challenge definitions and in the end they must pitch their ideas, prototypes and mock-ups to the judges to win the prizes. The participants are traditionally called hackers, which does not mean that they hack bank networks and that kind of stuff, but they rather strive to overcome the usual limitation in whatever area they are competing.</p>
<p>I will start with the most useful part - I&#39;ll give several pieces of advice for those who are preparing to their first hackathon. And then I&#39;ll get to the description of what was happening this time, so expect quite some photos.</p>
<h2 id="what-i-learnt">What I learnt</h2>
<p>So, in case you are going to take part in one of those hackathons, here is what I can advise you:</p>
<ul>
<li><p>Definitely go. It will be quite a new experience for you, well worth the time.</p>
</li>
<li><p>Take a laptop with your favourite working environment and any other devices that might be useful. Apart from this and some small personal things, you won&#39;t probably need anything else.</p>
</li>
<li><p>Don&#39;t be late. Otherwise you may miss the important parts: briefs and team formation.</p>
</li>
<li><p>Don&#39;t worry if you don&#39;t have a team before the event, that&#39;s normal.</p>
</li>
<li><p>Always compete for a prize. Even if it&#39;s not particularly important for you, it will help you align your actions and get more drive and fun.</p>
</li>
<li><p>Don&#39;t be shy, talk to people. If you don&#39;t know how to start, just join some other discussion by saying hello and your name. Ask what people think about briefs, what their background is, what are they going to do next and so on. Don&#39;t be afraid to get out of comfort zone.</p>
</li>
<li><p>Be nice, smile, make jokes, be open and willing to help others, listen to them.</p>
</li>
<li><p>Try to join someone who has complementing background for your skills, not someone with the same skill set. If you are a software developer, search for designers, entrepreneurs and pitch speakers.</p>
</li>
<li><p>Don&#39;t come with anything done in advance. You are welcome to bring relevant ideas, but don&#39;t bring implementations. The briefs will be too specific for you to fit. And, in any case, it will be transparent to everyone whether you did your prototype on-site or beforehand. You won&#39;t have fun if you start cheating.</p>
</li>
<li><p>Focus on pitch preparation quite early. Think through your demo, and focus on making it shiny and impressive, and don&#39;t spend much time on anything else. During last hour, practice your speech and check that you fit into time limit.</p>
</li>
<li><p>If you are suggested to use a specific technology, use it, you might then compete for two prizes instead of one, which double your chances.</p>
</li>
<li><p>If you stay overnight, have some sleep. Take a sleeping bag or a mat with you.</p>
</li>
<li><p>Keep your prototype focused. You only need one impressive idea, not 10 boring ideas.</p>
</li>
<li><p>There will be someone from sponsors and technology partners to support you. Reach to them and take advice from people who are willing to help you.</p>
</li>
<li><p>Have fun!</p>
</li>
</ul>
<h2 id="how-we-scored-at-green-hackfest">How we scored at Green Hackfest</h2>
<p>So we gathered together on Friday evening, and stayed in the hackspace until Sunday night. Participants are provided with all the infrastructure during this time: power plugs, Wi-Fi, tables &amp; chairs, food, drinks and sleeping room. All free of charge.</p>
<p>The whole story starts with introduction from hosts and then with briefs from sponsors. Here is Richard Kastelein, the event organizer, giving his kick-off speech:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Richard_Kastelein.jpg" alt="Richard Kastelein"></p>
<p>This way we got the tasks for these 2 days. There were several tasks, so everyone could choose which one suits them the best. Some folks were late, so they were having troubles afterwards to get the idea of what&#39;s expected from them.</p>
<p>I think there were about 70 participants in beginning, and about 50 of them made it to the end. Most people came alone or in pair; and I think there were two pre-formed teams of several people. </p>
<p>Most people were Dutch, but a lot were not. Many international students, scientists and entrepreneurs live in the Netherlands these days, and they were all welcome. So, while some teams were speaking Dutch within the group, English was the default language for other communication all the time, which is very handy. Some participants came to the Netherlands specifically to take part in this event: I remember guys from UK, Belgium and even Serbia.</p>
<p>I am the software developer and I expected the majority of hackers to be developers too, mostly on experienced side. But I was quite wrong. Many people were from entrepreneurial background, coming from ventures on early stage, or research environments. Many folks were students with no career set yet. In result, I was the only person who was able to write code in our team, and one of the most experienced programmers overall (my guess).</p>
<p>So the first task for everyone was to build a team for yourself. There was no formal procedure for that. You just meet people, ask what they think about the challenges and try to start the discussion, then go to someone else, and repeat. Sooner or later, you should find someone with whom you are ready to spend the next 45 hours working on a project. The normal team is of 2 to 5 people, and you should ideally join diverse skills. So if you are a developer, search for entrepreneurs or other idea generators, and also someone with design skills.</p>
<p>This time we had the following briefs, all of them were more or less related to green tech:</p>
<ul>
<li><p>Crowdfunding challenge: find new applications for an existing crowdfunding platform</p>
</li>
<li><p>Optimize manufacturing line based on monitoring data to use less energy without compromising the production schedule</p>
</li>
<li><p>Make people in Utrecht use more bicycles instead of cars (tough task, as Utrecht is one of the cities were pretty much everyone is already using bicycles)</p>
</li>
<li><p>Visualize the sustainability of electric car stations</p>
</li>
<li><p>Show off anything with IBM BlueMix platform</p>
</li>
</ul>
<p>And there was the main prize for the best overall Hack Green.</p>
<p>Here is the prize structure:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Prize_structure.jpg" alt="Prize structure"></p>
<p>(the student award was eventually transformed to IBM technology award)</p>
<p>Quite quickly I decided that Ebbits brief looks the most promising. First, it provided some test data and API to play with, so we had at least something to start with. Second, it did not sound as romantic as some other topics, so I hoped that not many teams would pick it. And last but not least, there were 3 prizes for this same brief, so any of the top 3 teams were going to cash!</p>
<p>Here is the manager from Ebbits presenting his manufacturing brief:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Manufacturing_brief.jpg" alt="Manufacturing brief"></p>
<p>So I joined several discussions until I found folks who were thinking more or less on the same page, and were equally enthusiastic about smart factory challenge.</p>
<p>The hackspace was available for the whole 48 hours of the hackfest. There was one big open space containing many open cabins with tables, couches and chairs inside:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Hackspace_cabin.jpg" alt="Hackspace four guys 2"></p>
<p>So usually one team could fit into one cabin:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Hackspace_one_team.jpg" alt="Hackspace three guys"></p>
<p>Not too much space, but enough to put two or three laptops + cups or beers aside:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Hackspace_tables.jpg" alt="Hackspace one guy"></p>
<p>The gathering area was located in the centre of this room. People got together for all briefs, intermediate meet-ups, final pitches and prizes.</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Hackspace_hall.jpg" alt="Hackspace"></p>
<p>These guys had won the previous hackfest of same series, and I think they didn&#39;t speak to anyone, so nobody knew what they were doing:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Last_winners.jpg" alt="Hackspace four guys"></p>
<p>We took the large space behind the scene, and also got a big white board for brainstorming:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Hackfest_our_team.jpg" alt="Hackspace our team"></p>
<p>Wi-Fi was free and fast enough for the participants. Power plugs were everywhere, sometimes hanging from the ceiling:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Hackspace_wires.jpg" alt="Hackspace our team 2"></p>
<p>Food and beverages (including beer) were also provided in effectively unlimited quantities. Breakfasts, lunches, dinners plus night snacks - all for free for hackers. Biological green food for green hack fest:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Food.jpg" alt="Food"></p>
<p>There were two sleeping areas as well. I don&#39;t have any photos of those, but they were really basic: just separate empty rooms where you could put a sleeping bag and take a nap. I&#39;m not sure how many teams slayed late in the night, but we were lazy and went to sleep at midnight or so :)</p>
<p>In terms of prize winning odds, the most important part of the whole process is the final pitch. Each team had just 2 minutes to make a demo and do the speech. The demo doesn&#39;t need to show off a finished product, but everyone had to prepare prototypes, some pieces of working UI. Powerpoint slides were not enough. After the demo, the jury had 3 to 5 minutes to ask questions, and then the next team takes over. There was a training on how to pitch effectively, but I skipped that one.</p>
<p>So, you should leave quite some time before the pitch starts to actually prepare your demo. Focus on what you will say, and implement only the features that will be demoed, don&#39;t waste your time on anything else. Try showing something relatively small, specific and easy to understand, but also give a short overview of how you can see this can be expanded. Highlight the strengths of your team and why you are good candidates to do the job that you started.</p>
<p>During the pitch, the team is standing next to a big screen. One member is showing the demo on his laptop, while another member explains the whole story behind. Here is how it looked like:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Pitch.jpg" alt="Pitch"></p>
<p>There were four Judges in the jury, consisting of sponsor representatives and serial entrepreneurs. Here are those smart powerful guys:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Judges.jpg" alt="Judges"></p>
<p>We ended up taking the second place in our category. As we chose to participate in a category with 3 prizes, we scored 1000 euros! This is our photo with the sponsor and our prize:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Our_prize.jpg" alt="Our prize"></p>
<p>And this is the best overall hack team, congratulations to them:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/Winners.jpg" alt="Winners"></p>
<p>Here are all the hackers who stayed at the fest until the very end:</p>
<p><img src="/2015/03/the-green-hackfest-my-first-hackathon/All_hackers.jpg" alt="All hackers"></p>
<p>Enjoyable experience, thanks everyone for sharing it.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/hackathon/'>hackathon</a>, <a href='/tags/hackfest/'>hackfest</a>, <a href='/tags/challenge/'>challenge</a>, <a href='/tags/green-hackfest/'>Green Hackfest</a>, <a href='/tags/green-technologies/'>green technologies</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 17th, 2015</div>
    
    <h1><a href='/2015/02/how-i-fixed-a-bug-in-sql-server'>How I fixed a bug in SQL Server</a></h1>
    
    <div class="post-content">
        <p>Well, not really... I just reported it to Microsoft and then it got fixed. Anyway, here is the story.</p>
<p>Our production databases were migrated from SQL Server 2012 to SQL Server 2014. Among other improvements in the latter, <a href="http://blogs.msdn.com/b/psssql/archive/2014/04/01/sql-server-2014-s-new-cardinality-estimator-part-1.aspx">the new cardinality estimator was introduced</a>. In two words, cardinality estimator is a piece of SQL functionality which estimates how many rows the engine might get for a specific query or a query part. The new estimator is supposed to be smarter than the old one, of course. It takes more factors into account, and thus should give better results with some query plans. But &quot;new&quot; also means &quot;less tested&quot;...</p>
<p>Immediately after migration we found out that one of the stored procedures got much slower than before. That stored procedure was retrieving thousands of rows from a queue, and then did a series of transformations which took ages to complete. During the investigation we found that the query plan is far from being optimal, with massive scans of partitioned tables; and the reason was in ridiculously high estimations on one of the tables. That table was of moderate size (millions of rows), our query touched only some hundreds rows, while the estimate was... millions!</p>
<p>Here is a repro to show this issue on any test database (database must be in SQL Server 2014 compatibility mode):</p>
<pre class="highlight"><code class="hljs sql"><span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> [dbo].[Store](
    Id <span class="hljs-built_in">int</span> <span class="hljs-keyword">IDENTITY</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    City <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">Size</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    Name <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">CONSTRAINT</span> [PK_Store] <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span> CLUSTERED ([Id] <span class="hljs-keyword">ASC</span>)
 ) 

 <span class="hljs-keyword">GO</span>

 <span class="hljs-keyword">CREATE</span> NONCLUSTERED <span class="hljs-keyword">INDEX</span> [IX_Store] <span class="hljs-keyword">ON</span> [dbo].[Store]
(
    City <span class="hljs-keyword">ASC</span>,
    <span class="hljs-keyword">Size</span> <span class="hljs-keyword">ASC</span>
)

<span class="hljs-keyword">GO</span>
 <span class="hljs-keyword">TRUNCATE</span> <span class="hljs-keyword">TABLE</span> Store
<span class="hljs-keyword">INSERT</span> Store 
<span class="hljs-keyword">SELECT</span> i % <span class="hljs-number">101</span>, i % <span class="hljs-number">11</span>, <span class="hljs-string">'Store '</span> + <span class="hljs-keyword">CAST</span>(i <span class="hljs-keyword">AS</span> <span class="hljs-built_in">VARCHAR</span>)
  <span class="hljs-keyword">FROM</span> 
 (<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">100000</span> ROW_NUMBER() OVER (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> s1.[object_id]) <span class="hljs-keyword">AS</span> i
  <span class="hljs-keyword">FROM</span> sys.all_objects  s1, sys.all_objects  s2) numbers
<span class="hljs-keyword">GO</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> StoreRequest (City <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>, <span class="hljs-keyword">Size</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>)

<span class="hljs-keyword">GO</span>
<span class="hljs-keyword">DELETE</span> StoreRequest
<span class="hljs-keyword">INSERT</span> StoreRequest <span class="hljs-keyword">values</span> (<span class="hljs-number">55</span>, <span class="hljs-number">1</span>)
<span class="hljs-keyword">INSERT</span> StoreRequest <span class="hljs-keyword">values</span> (<span class="hljs-number">66</span>, <span class="hljs-number">2</span>)

<span class="hljs-keyword">GO</span>

 <span class="hljs-keyword">SELECT</span> s.City
   <span class="hljs-keyword">FROM</span> StoreRequest <span class="hljs-keyword">AS</span> r
        <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Store <span class="hljs-keyword">AS</span> s  <span class="hljs-keyword">WITH</span>(<span class="hljs-keyword">INDEX</span>(IX_Store), FORCESEEK) 
                    <span class="hljs-keyword">ON</span> s.City = r.City <span class="hljs-keyword">AND</span> s.<span class="hljs-keyword">Size</span> = r.<span class="hljs-keyword">Size</span>
  <span class="hljs-keyword">WHERE</span> r.<span class="hljs-keyword">Size</span> &lt;&gt; <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> s.City &lt;&gt; <span class="hljs-number">55</span>
</span></code></pre><p>In this script I create two tables: Store with 100k rows and StoreRequest with 2 rows. And then I make a query where I join them on two columns. The WHERE clause contains two restrictions: one for each of the tables with OR clause in between. It sounds more complicated than it really is.</p>
<p>INDEX and FORCESEEK hints are there to force the engine to use this index to be able to see the statistics. Otherwise it considers the index to be too heavy to use. And that is why:</p>
<p><img src="/2015/02/how-i-fixed-a-bug-in-sql-server/2014estimates.png" alt="Execution plan in SQL Server 2014"></p>
<p>You see the significant error in Estimated Number of Rows vs Actual Number of Rows. The estimator actually thinks that the query is going to yield half of all rows in that table!</p>
<p>Good news: it&#39;s actually easy to fix that problem in this case. We should just change the WHERE clause to use same table for both sides of OR condition:</p>
<pre class="highlight"><code class="hljs stylus"> SELECT s<span class="hljs-class">.City</span>
   FROM StoreRequest AS r
        INNER JOIN Store AS s  <span class="hljs-function"><span class="hljs-title">WITH</span><span class="hljs-params">(INDEX(IX_Store)</span></span>, FORCESEEK) 
                    ON s<span class="hljs-class">.City</span> = r<span class="hljs-class">.City</span> AND s<span class="hljs-class">.Size</span> = r<span class="hljs-class">.Size</span>
  WHERE s<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">1</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">55</span>
</code></pre><p>Estimator is able to handle this situation correctly:</p>
<p><img src="/2015/02/how-i-fixed-a-bug-in-sql-server/2014estimates_good.png" alt="Execution plan in SQL Server 2014 as it should be"></p>
<p>Same fix worked for our production query. That query was much more complicated so it took more time to find the reason.</p>
<p>To prove that this bug is fresh for the new cardinality estimator, we can switch the original query to the legacy cardinality estimator with flag 9481:</p>
<pre class="highlight"><code class="hljs stylus"> SELECT s<span class="hljs-class">.City</span>
   FROM StoreRequest AS r
        INNER JOIN Store AS s  <span class="hljs-function"><span class="hljs-title">WITH</span><span class="hljs-params">(INDEX(IX_Store)</span></span>, FORCESEEK) 
                    ON s<span class="hljs-class">.City</span> = r<span class="hljs-class">.City</span> AND s<span class="hljs-class">.Size</span> = r<span class="hljs-class">.Size</span>
  WHERE r<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">1</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">55</span>
 <span class="hljs-function"><span class="hljs-title">OPTION</span><span class="hljs-params">(QUERYTRACEON <span class="hljs-number">9481</span>)</span></span> 
</code></pre><p>And then we get this:</p>
<p><img src="/2015/02/how-i-fixed-a-bug-in-sql-server/2012estimates.png" alt="Execution plan in SQL Server 2012"></p>
<p>Which is as good as the best attempt of SQL Server 2014 and much-much better than the worst one.</p>
<p>I posted this repro to <a href="https://connect.microsoft.com/SQLServer/feedback/details/1086125/cardinality-estimator-2014-is-off-with-or-in-where-clause">SQL Server forum</a>. Here is the comment that I got from Erland Sommarskog, SQL Server MVP:</p>
<blockquote>
<p>The estimate here is clearly incorrect. SQL Server knows the density of Size and City. It knows the cardinality of the temp table. The density information gives how many rows the join will produce. The WHERE clause will then remove a certain number of rows. With no statistics for the temp table, it does not know how many, but it will apply some standard guess.</p>
<p>50000 is a completely bogus number, because the join cannot produce that many rows, and SQL Server is able to compute the join with out the WHERE clause decently. (Well, it estimates 90, when the number is 180.) No, this is obviously a case of the cardinality estimator giving up completely.</p>
<p>It is worth noting that both these WHERE clauses gives reasonable estimates:</p>
<pre class="highlight"><code class="hljs stylus">WHERE r<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR r<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
WHERE s<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
</code></pre><p>Whereas these two gives the spooky 50000:</p>
<pre class="highlight"><code class="hljs stylus">WHERE s<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR r<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
WHERE r<span class="hljs-class">.Size</span> &lt;&gt; <span class="hljs-number">11</span> OR s<span class="hljs-class">.City</span> &lt;&gt; <span class="hljs-number">550</span>
</code></pre><ul>
<li>Erland Sommarskog</li>
</ul>
</blockquote>
<p>Then I also posted it to <a href="https://connect.microsoft.com/SQLServer/feedback/details/1086125/cardinality-estimator-2014-is-off-with-or-in-where-clause">SQL Server feedback issue tracker</a> and after a couple of weeks got a reply from Microsoft employee:</p>
<blockquote>
<p>Thank you for reporting this issue. I am happy to let you know that we have a fix for this problem, which will be available in one of the upcoming servicing releases for SQL Server 2014 (the details will be published in a KB).</p>
<ul>
<li>Thanks, Alexey, SQL Development</li>
</ul>
</blockquote>
<p>Thanks to Erlang and Alexey for their help. I look forward to the servicing release!
Happy coding!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/execution-plan/'>execution plan</a>, <a href='/tags/query-plan/'>query plan</a>, <a href='/tags/database/'>database</a>, <a href='/tags/repro/'>repro</a>, <a href='/tags/erland-sommarskog/'>Erland Sommarskog</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 5th, 2015</div>
    
    <h1><a href='/2015/02/how-we-do-message-processing'>How we do message processing</a></h1>
    
    <div class="post-content">
        <p>Our team develops a back-end system that processes messages from mobile devices. The devices collect information from complex machines and send messages to our data center. In this article I want to share our approaches to building such processing software. The ideas are quite general and can be applied to any system of the following architecture:
<img src="/2015/02/how-we-do-message-processing/architecture.jpg" alt="System architecture"></p>
<p>The devices use communication channels to send messages to our gateway - the input point of our application. The application&#39;s goal is to understand what came in, do the required actions and save the information into the database for further processing. Let&#39;s consider the database to be the end point of processing. Sounds easy, right? But some difficulties appear with the growth of amount and diversity of incoming messages; so let&#39;s look at some of them.</p>
<p>A few words on the target load level. Our system processes the messages from tens of thousands of devices, and we get from several hundreds to a thousand messages per second. If you numbers are different by orders of magnitude, it might be the case that your problems are going to look completely different and you&#39;ll need a different set of tools to solve them.</p>
<p>Apart from the number of messages itself, there is a problem of irregularity and peak times. The application must be ready for relatively short peaks which might be about ten times higher than the average expectation. To address this problem we organize the system as a sequence of queues and corresponding processors.</p>
<p>The input gateway doesn&#39;t do much of real job: it just receives a message from a client and puts it into the queue. This operation is very cheap, thus the gateway is capable of accepting a vast number of messages per second. Afterwards a separate process retrieves several messages - the amount it wants to get - from the queue and does the hard work. The processing happens asynchronously while the load on the system remains limited. Perhaps the time in the queue grows at peaks, but that&#39;s it.</p>
<p>Normally the message processing is non-trivial and consists of several actions. Here we get to the next logical step: we break down the job into several stages, each one having a separate queue and a dedicated processor. The queues and processors are independent and may reside on separate physical servers; and we can tune and scale them independently:
<img src="/2015/02/how-we-do-message-processing/sequence.jpg" alt="Sequence-based architecture"></p>
<p>The first queue contains the messages from devices as-is, without decoding or transforming them. The first processor decodes them and puts them into the second queue. The second processor could, for instance, call a third-party service and enrich the message with some relevant information, and the third processor could save that information into the database.</p>
<p>These are the basics, so what do we still need to consider?</p>
<h3 id="define-your-values">Define your values</h3>
<ol>
<li><p>Simplicity of creation, change and support</p>
<p> Asynchronous distributed message processing brings quite some extra complexity into the software product. You should constantly work on reducing this price. The code gets optimized to be, at first place, readable and straightforward for all the team members, cheap to be changed and supported. If nobody but the author can decrypt the code, no great architecture will make the team happy.</p>
<p> This statements looks obvious, but it might take quite some time and effort before the team starts to consistently implement this principle and not just declare it. Do the regular refactoring whenever you feel you can make the code a bit better and simpler. All the source code should get reviewed and the most critical parts are better to be developed in pair.</p>
</li>
<li><p>Fault tolerance</p>
<p> It makes sense to define your policies of hardware or subsystem failures handling from the very beginning. They will differ for different products. It might be the case that someone can throw away all the messages that come in during 5 minutes of a server reboot.</p>
<p> In our system we don&#39;t want to lose messages. If a particular service is not currently available, a database call times out, or there is a random processing error, it must not result in information loss. The affected messages must be saved inside the queue and will be processed right after the problem is fixed.</p>
<p> Suppose your code on one server calls a web service on another server in synchronous manner. If the second server is not available, the processing will fail, and you can&#39;t do anything but log the error. In case of asynchronous processing the message will wait for the second server to go live again.</p>
</li>
<li><p>Performance</p>
<p> Processing rate per second, latency, load on the servers - all these are important parameters of application performance. That&#39;s why we choose the architecture to be flexible.</p>
<p> Although, don&#39;t pay TOO much attention to optimization from the very beginning. Usually the majority of performance issues is created by relatively small pieces of code. Unfortunately people tend to be very bad at predicting where exactly those issues are going to appear. People write <a href="http://carlos.bueno.org/optimization/">books on pre-mature optimization</a>. So make sure that your architecture allows you to fine-tune the system and forget about optimization until the first load testing.</p>
<p> At the same time, and for this reason, start running the load tests early on, and then include them into your standard testing procedure. Start optimizing only when the tests reveal a specific performance problem.</p>
</li>
</ol>
<h3 id="fine-tune-your-mindset">Fine tune your mindset</h3>
<ol>
<li><p>Operate queues and asynchronous processors</p>
<p> I already described this above. Our main tools are queues and processors. While the classic approach is &quot;get request, call remote code, wait for response, return it back to the originator&quot;, now we should always use &quot;get a message from a queue, process it, send a message to another queue&quot;. The right mix of these two approaches should enable both scalability and ease of development.</p>
</li>
<li><p>Break the processing down into several stages</p>
<p> If message processing is complex enough to be split into several stages, do that by creating several queues and processors. Make sure that you don&#39;t make it too complex to understand by unneeded fragmentation: the right balance is important. Quite often you will see a split which feels natural for developers. If not, try thinking of possible failure points. If there are multiple reasons why a processor may fail, consider its breakdown.</p>
</li>
<li><p>Don&#39;t mix decoding and processing</p>
<p> Usually the messages arrive encoded with a protocol which can be binary, XML, JSON, etc. Decode them into your native format as soon as possible. This will help you solve two problems. First, you might need to support multiple protocols; and after decoding you unify the format of all further messages. Second, logging and debugging gets simpler.</p>
</li>
<li><p>Make the queues topology configurable</p>
<p> Structure your code in a way that allows you to change the configuration of queues relatively easy. Splitting a processor into two parts should not result in tons of refactoring. Don&#39;t make your code depend on a specific queue mechanism implementation: tomorrow you might want to change it.</p>
</li>
<li><p>Do batch processing</p>
<p> Normally it makes sense to receive messages from a queue in batches, not one by one. The services that you use might accept arrays for faster processing and in this case one call will always be faster than a handful of small ones. One insertion of 100 rows into database is faster than 100 remote insertions.</p>
</li>
</ol>
<h3 id="create-tooling">Create tooling</h3>
<ol>
<li><p>Implement total monitoring</p>
<p> Invest into monitoring tools. It should be easy to see the charts of throughput, average processing time, queue size and time since last message with breakdown by queue.
<img src="/2015/02/how-we-do-message-processing/monitoring.jpg" alt="Queue monitoring"></p>
<p> We use monitoring tools not only on production and staging environments but also on testing servers and even developer&#39;s machines. Carefully baked charts are helpful during debug and load testing procedures.</p>
</li>
<li><p>Test everything</p>
<p> Message processing systems are perfect fields to apply fully automated testing. Input data protocols are well-defined and there is no human interaction. Cover your code with unit tests. Make your queues pluggable so that you could mock your real queues out with test in-memory queues to run quick intercommunication tests. Finally, create full-blown integration tests which should be run on staging environment (and preferably also on production).</p>
</li>
<li><p>Store the failed messages</p>
<p> Usually you don&#39;t want one erroneous message to stop the complete queue processing. Being able to diagnose the problem is equally important. So put all the failed messages into a specialized storage and put a spotlight on it. Make a tool to move messages back to the relevant queue as soon as the failure reason is addressed.</p>
<p> Same or similar mechanism can be used to store the messages to be processed at some point of time in the future. Keep them in that special storage and check periodically if now is time to proceed.</p>
</li>
<li><p>Automate the deployment</p>
<p> Application setup and update must require just one or two clicks. Strive for frequent updates on production; ideally - automated deployment on every commit to the dedicated branch. Deployment scripts or tools will help developers maintain their personal and testing environments up-to-date.</p>
</li>
</ol>
<h3 id="wrapping-up">Wrapping up</h3>
<p>Clean and understandable architecture provides developers with a good means of communication, helps figure out the similar vision and concepts. Architecture metaphor expressed in form of a picture or short document will bring you closer to smart design, will help find errors or plan a refactoring.</p>
<p>Happy message processing!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/architecture/'>architecture</a>, <a href='/tags/design/'>design</a>, <a href='/tags/messages/'>messages</a>, <a href='/tags/message-processing/'>message processing</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Oct 16th, 2014</div>
    
    <h1><a href='/2014/10/16/nice-way-to-kill-your-sql-server'>Nice way to kill your SQL Server</a></h1>
    
    <div class="post-content">
        <p>Are you getting enormous amount of </p>
<pre class="highlight"><code class="hljs nimrod"><span class="hljs-type">The</span> activated <span class="hljs-keyword">proc</span> '...' running on queue '...' output the following:
'<span class="hljs-type">The</span> service queue <span class="hljs-string">"..."</span> <span class="hljs-keyword">is</span> currently disabled.
</code></pre><p>errors from SQL Server? Keep on reading!</p>
<p>Yesterday, when I came back from my lunch, I got a heads-up from Windows:
<img src="/2014/10/16/nice-way-to-kill-your-sql-server/low-disk-space.gif" alt="Low disk space"></p>
<p>And it was literally out of space: 0 (zero) bytes available on C: drive. Wow...</p>
<p>I cleaned up the binary files from my developments, which gave me 3 GB of free space and some time to do the investigation. A short time, because disk space was counting down at about 300 MB per minute.</p>
<p>It appeared that the SQL Server error log files grew up to 53 GB and were still growing. Here is the default folder where you can find them:</p>
<p><img src="/2014/10/16/nice-way-to-kill-your-sql-server/errorlog.png" alt="SQL Server error log"></p>
<p>To gain more time, I executed the command</p>
<pre class="highlight"><code class="hljs bash"><span class="hljs-keyword">exec</span> sp_cycle_error
</code></pre><p>is Management Studio. It renames current ERRORLOG file to ERRORLOG.1 and starts the new current. So now it was safe to delete all .1/.2/etc files and get those 53 GB back. Huh...</p>
<p>Now it&#39;s time to figure out the actual issue. Go to Management Studio -&gt; your server -&gt; Management -&gt; SQL Server Logs -&gt; Current -&gt; (right click) -&gt; View SQL Server Log</p>
<p>I saw millions of the following messages there (let&#39;s say my queue is named XQueue for simplicity):</p>
<pre class="highlight"><code class="hljs nimrod"><span class="hljs-type">The</span> activated <span class="hljs-keyword">proc</span> '[dbo].[<span class="hljs-type">XQueueProcessor</span>]' running 
on queue 'dbo.<span class="hljs-type">XQueue</span>' output the following:
'<span class="hljs-type">The</span> service queue <span class="hljs-string">"XQueue"</span> <span class="hljs-keyword">is</span> currently disabled.
</code></pre><p>So, it looks like there is a problem with SQL Server Service Broker, which is constantly trying to read something from disabled queue. Isn&#39;t it supposed to stop after 5 attempts (a.k.a. poison messages)? Ok, keep on troubleshooting.</p>
<p>First, let check if the queue is actually disabled</p>
<pre class="highlight"><code class="hljs oxygene"><span class="hljs-keyword">SELECT</span> Name, is_receive_enabled, is_enqueue_enabled
  <span class="hljs-keyword">FROM</span> sys.service_queues 
 <span class="hljs-keyword">WHERE</span> Name = <span class="hljs-string">'XQueue'</span>  
</code></pre><p>Yep, it&#39;s disabled:
<img src="/2014/10/16/nice-way-to-kill-your-sql-server/qdisabled.png" alt="XQueue disabled"></p>
<p>Do we have anything queued?</p>
<pre class="highlight"><code class="hljs oxygene"><span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1000</span> *
  <span class="hljs-keyword">FROM</span> [XQueue] <span class="hljs-keyword">WITH</span>(NOLOCK) 
</code></pre><p>I got 9 rows back. This means we got some messages en-queued, and one of them failed to process, the message was considered as poison and the queue was disabled (which is good), but the processor still seems to be running in eternal loop.</p>
<p>So, let&#39;s have a look at the processor. We had something like that:</p>
<pre class="highlight"><code class="hljs oxygene"><span class="hljs-keyword">CREATE</span> <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> [<span class="hljs-title">dbo</span>].[<span class="hljs-title">XQueueProcessor</span>]
<span class="hljs-title">AS</span>
<span class="hljs-title">BEGIN</span>
    <span class="hljs-title">DECLARE</span> 
        @<span class="hljs-title">queuing_order</span> <span class="hljs-title">BIGINT</span>
        ,@<span class="hljs-title">conversation_handle</span> <span class="hljs-title">UNIQUEIDENTIFIER</span>
        ,@<span class="hljs-title">message_enqueue_time</span> <span class="hljs-title">DATETIME</span>
        ,@<span class="hljs-title">message_type_name</span> <span class="hljs-title">VARCHAR</span><span class="hljs-params">(156)</span>
        ,@<span class="hljs-title">message_body</span> <span class="hljs-title">VARBINARY</span><span class="hljs-params">(MAX)</span>;</span>

    <span class="hljs-keyword">WHILE</span>(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>) -- MAIN <span class="hljs-keyword">WHILE</span> <span class="hljs-keyword">LOOP</span> RECEIVING THE MESSAGE BATCHES
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">BEGIN</span> TRANSACTION
        <span class="hljs-keyword">BEGIN</span> <span class="hljs-keyword">TRY</span>
            WAITFOR(RECEIVE TOP(<span class="hljs-number">1</span>)
                        @queuing_order = [queuing_order],
                        @conversation_handle = [conversation_handle],
                        @message_enqueue_time = message_enqueue_time,
                        @message_type_name = message_type_name,
                        @message_body = message_body
                    <span class="hljs-keyword">FROM</span> [dbo].[XQueue]), TIMEOUT <span class="hljs-number">10</span>

            <span class="hljs-keyword">IF</span> (@@ROWCOUNT = <span class="hljs-number">0</span>)
            <span class="hljs-keyword">BEGIN</span>
                ROLLBACK TRANSACTION
                <span class="hljs-keyword">BREAK</span>
            <span class="hljs-keyword">END</span>    

            -- SOME CRUD OPERATIONS HAPPEN HERE        

            COMMIT TRANSACTION
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">TRY</span>
        <span class="hljs-keyword">BEGIN</span> CATCH            
            DECLARE @Error varchar(<span class="hljs-number">4000</span>) = ERROR_MESSAGE()
            PRINT @Error
            ROLLBACK TRANSACTION
        <span class="hljs-keyword">END</span> CATCH        
    <span class="hljs-keyword">END</span>
<span class="hljs-keyword">END</span>
</code></pre><p>A-ha! So, what happens when an error occurs during the message processing? Control goes to CATCH block, error message is printed out (when we are in Service Broker, print goes directly to ERRORLOG file which we saw already), the transaction is rolled back... But we still are inside eternal loop, no BREAK or RETURN statement there, so the processor will try again to get the same message from the queue. After 5th attempt, the message will be marked as poison, the queue will get disabled, but the loop will keep running! The exception will change to &quot;The service queue is currently disabled&quot; and voila, CPU is busy and error logs are floating the disk.</p>
<p>The fix is pretty trivial, just change the CATCH block to</p>
<pre class="highlight"><code class="hljs monkey">BEGIN <span class="hljs-keyword">CATCH</span>            
    DECLARE @<span class="hljs-built_in">Error</span> varchar(<span class="hljs-number">4000</span>) = ERROR_MESSAGE()
    <span class="hljs-built_in">PRINT</span> @<span class="hljs-built_in">Error</span>
    ROLLBACK TRANSACTION
    <span class="hljs-keyword">RETURN</span>
<span class="hljs-keyword">END</span> <span class="hljs-keyword">CATCH</span>        
</code></pre><p>Be careful!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/bugs/'>Bugs</a>, <a href='/tags/error-log/'>Error log</a>, <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/sql-server-service broker/'>SQL Server Service Broker</a>
    </div>
    
</article>


<div class="page-nav">
    
    <a class="page-nav-newer" href="/6"><span class="icon icon-arrow-left-2"></span> Next page</a>
    
    
    <a class="page-nav-older" href="/8">Previous page <span class="icon icon-arrow-right-2"></span></a>
    
</div>

<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy F#, C#, Javascript and SQL development, reasoning about distributed systems, data processing pipelines, cloud and web apps. I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="http://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="http://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2016 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>