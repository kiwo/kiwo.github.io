<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="twitter:card" content="summary"></meta>
    <meta name="twitter:creator" content="@MikhailShilkov"></meta>

    <meta property="og:type" content="article" />
    <meta property="og:title" content="Mikhail Shilkov" />
    <meta property="og:url" content="https://mikhail.io/12/" />



    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">
    <link href="/vendor/prism.css" rel="stylesheet" media="screen">

    <meta name="generator" content="DocPad v6.80.6" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">Serverless, Azure, FP, F# and more</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                    <li><a href="/tags/">Topics</a></li>
                
                    <li><a href="/archives/">Archives</a></li>
                
                    <li><a href="/talks/">Talks</a></li>
                
                    <li><a href="/about/">About</a></li>
                
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="https://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="https://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Nov 24th, 2015</div>
    
    <h1><a href='/2015/11/review-of-jspm-course/'>Review of the course &quot;Modern, Modular JavaScript with SystemJS and jspm&quot;</a></h1>
    
    <div class="post-content">
        <p>Recently I was playing with <a href="http://aurelia.io">Aurelia</a> SPA framework, which makes heavy use of jspm and SystemJS for modules/packaging. This package manager is new to me, and it looked a bit like magic sometimes. So when I saw a jspm course on Pluralsight, I decided to give it a try. And I did not regret: the course is great. It&#39;s so good, that I decided to write a review for it, even though I have never done that before. </p>
<p>So, the full course name is &quot;<a href="https://www.pluralsight.com/courses/javascript-systemjs-jspm">Modern, Modular JavaScript with SystemJS and jspm</a>&quot; by Wes Higbee. The topic sounds pretty narrow (compare to something like &quot;Building a Web App with ASP.NET 5, MVC 6, EF7 and AngularJS&quot;), but the video track is surprisingly long: 7.5 hours. And every hour is packed with well structured in-depth material which lays the topic out from A to Z.</p>
<p>The majority of online courses are focusing on just explaining the <em>What</em>&#39;s of a technology: where you get it, how you start quickly, how you solve typical tasks. Wes does not stop there: he is really focusing on <em>Why</em>&#39;s: not only why we should use ES2015 modules and jspm, but the complete logical flow from the best practices in other programming environments to the module patterns to the tools that enable us use the modern approaches in javascript today. The understanding of this reasoning chain sets the solid ground, and you actually start getting the What&#39;s deeper. </p>
<p>But Wes goes even further: he mixes the <em>How</em>&#39;s in. I love watching him breaking the stuff to show why it fails and how to fix it. The references to module dependency graphs and internals of the tools are insightful; that&#39;s how &quot;the magic&quot; transforms into the comprehension of modern open source tools and libraries. </p>
<p>Of course, just watching the course won&#39;t make me an expert in the topic. Now I need to put the knowledge into practice, ask more questions and find answers myself. But I will hopefully save hours of debugging and frustration and will maybe produce better products in the end. Wes and Pluralsight, I definitely need more of courses like this - focused, deep and engaging! </p>
<p>P.S. It was a bit awkward to watch the course in the office because of solitaire cards being shown on my screen. Not sure what my colleagues thought I was doing ;)</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/pluralsight/'>Pluralsight</a>, <a href='/tags/course/'>Course</a>, <a href='/tags/learning/'>Learning</a>, <a href='/tags/javascript/'>Javascript</a>, <a href='/tags/jspm/'>JSPM</a>, <a href='/tags/systemjs/'>SystemJS</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Aug 11th, 2015</div>
    
    <h1><a href='/2015/08/units-of-measurement-in-domain-design/'>Units of measurement in domain design</a></h1>
    
    <div class="post-content">
        <p>If you have business application of any decent size, your most important code probably resides in domain logic.
When working with 3rd party code, you can always find an answer on stack overflow or official documentation, but your domain is all yours. Try to make it as simple and readable as possible, and it will always pay you back.</p>
<p>Today I want to discuss one aspect of writing clean domain code: units of measurement. It is important for any domain (or sub-domain) where you operate some physical measurements.</p>
<h2 id="problem-statement">Problem statement</h2>
<p>Our toy example will be about cars and fuel consumption. You receive some data about the trip of your car, e.g. an instance of</p>
<pre><code class="language-csharp">public interface ITrip
{
    double FuelUsed { get; }
    double Distance { get; }
}</code></pre>
<p>Now you want to calculate the fuel consumption rate of your trip. You write</p>
<pre><code class="language-csharp">var fuelRate = trip.FuelUsed / trip.Distance;</code></pre>
<p>You get the value, but what is it? Let&#39;s say you want a value of liters per 100 kilometers. You can assume that <code>FuelUsed</code> is in liters, and <code>Distance</code> is in kilometers. To be more explicit you refactor your code</p>
<pre><code class="language-csharp">public interface ITrip
{
    double FuelUsedInLiters { get; }
    double DistanceInKilometers { get; }
}

var fuelRateLitersPer100Kilometers = trip.FuelUsedInLiters * 100.0 / trip.DistanceInKilometers;</code></pre>
<p>Now it&#39;s much more explicit, and probably good enough for such a small code example. For larger code bases, you will inevitably get into more problems:</p>
<ol>
<li><p>You will start measuring same things in different units. E.g. you will store the distance in meters in the database, so you&#39;ll have to multiply by 1000 somewhere in persistence layer.</p>
</li>
<li><p>If you need to convert metric to imperial and back, you will get lots of constants here and there.</p>
</li>
<li><p>String formatting will become a tedious task. Be sure to call a right formatter for each implicit unit.</p>
</li>
</ol>
<p>This does not work well. The code smell is called <a href="http://blog.ploeh.dk/2011/05/25/DesignSmellPrimitiveObsession/">Primitive Obsession</a> and we should avoid this in production-grade code. Instead, we want the succinctness of first example in combination with strong compile-time checks and well-defined operations.</p>
<h2 id="defining-the-units">Defining the units</h2>
<p>I tried several options like generic classes for units, but I ended up having a struct per measurement. The code is very boring and repetitive, but it provides me with the strongest compile-time checks and nice readability. If you are too bored with typing, you can do some code generation or just use 3rd party that suits you.
So, my end result looks like</p>
<pre><code class="language-csharp">public interface ITrip
{
    Volume FuelUsed { get; }
    Distance Distance { get; }
}</code></pre>
<p>Let&#39;s see how Distance is defined (Volume will be almost exactly same):</p>
<pre><code class="language-csharp">public struct Distance
{
    private Distance(double kilometers)
    {
        this.Kilometers = kilometers;
    }

    public double Kilometers { get; }

    public double Meters =&gt; this.Kilometers / 1000.0;

    public static readonly Distance Zero = new Distance(0.0);

    ...
}</code></pre>
<p>Several important things to notice here:</p>
<ol>
<li><p>It&#39;s a struct.</p>
</li>
<li><p>It&#39;s immutable. Once an instance is created, its properties can&#39;t be changed anymore.</p>
</li>
<li><p>Constructor is private. I don&#39;t actually want people to create instances directly: <code>new Distance(123)</code> reads pretty horribly, keep reading to see better options.
Of course, default constructor is still public, but you can only create a zero value with it.</p>
</li>
<li><p>Better way of creating zero distance is to call Zero static field.</p>
</li>
</ol>
<h2 id="instantiation">Instantiation</h2>
<p>So, how do we create measurement objects?</p>
<h3 id="factory-method">Factory method</h3>
<p>The classic way is a set of static factory methods:</p>
<pre><code class="language-cs">public static Distance FromKilometers(double kilometers)
{
    return new Distance(kilometers);
}

public static Distance FromMeters(double meters)
{
    return new Distance(meters / 1000.0);
}</code></pre>
<p>Usage is as simple as <code>var distance = Distance.FromMeters(234);</code></p>
<h3 id="extension-method">Extension method</h3>
<p>Imagine you have the following code which converts an integer value of a database result into our units</p>
<pre><code class="language-cs">trip.Distance = Distance.FromMeters(database.ReadInt32(&quot;TotalDistance&quot;)
                        .GetDefaultOrEmpty());</code></pre>
<p>Such a long expression reads better with a fluent interface like</p>
<pre><code class="language-cs">trip.Distance = database.ReadInt32(&quot;TotalDistance&quot;)
                        .GetDefaultOrEmpty()
                        .MetersToDistance();</code></pre>
<p><code>MetersToDistance</code> in this case is an extension method:</p>
<pre><code class="language-cs">public static class DistanceExtensions
{
    public static Distance MetersToDistance(this double meters)
    {
        return Distance.FromMeters(meters);
    }
}</code></pre>
<h3 id="operator-with-static-class-using">Operator with static class using</h3>
<p>C# 6 brings us a new language construct. Now we can import a static helper class</p>
<pre><code class="language-cs">using static Units.Constants;</code></pre>
<p>And then we can write something like</p>
<pre><code>var distance = 10.0 * km;</code></pre><p>where <code>km</code> is defined in that static class:</p>
<pre><code class="language-cs">public static class Constants
{
    public static readonly Distance km = Distance.FromKilometers(1.0);
}</code></pre>
<p>This may not look like idiomatic C#, but I think it&#39;s very good at least for writing unit tests:</p>
<pre><code class="language-cs">var target = new Trip
{
    DistanceOnFoot = 5 * km,
    DistanceOnBicycle = 10 * km,
    DistanceOnCar = 30 * km
};
target.TotalDistance.Should().Be((30 + 10 + 5) * km);</code></pre>
<p>For this to compile you just need to define the operator overload:</p>
<pre><code class="language-cs">public static Distance operator*(int value, Distance distance)
{
    return Distance.FromKilometers(value * distance.Kilometers);
}</code></pre>
<h2 id="conversion-and-printing">Conversion and printing</h2>
<p>More advanced unit conversions are easy with unit classes. A common use case would be to convert metric units to imperial system. All you need to do is to add another calculated property</p>
<pre><code class="language-cs">// Distance class
private const double MilesInKilometer = 0.621371192;
private const double FeetInMeter = = 3.2808399;

public double Miles =&gt; this.Kilometers * MilesInKilometer;

public double Feet =&gt; this.Meters * FeetInMeter;</code></pre>
<p>Another common task is printing (formatting) unit values into string. While you can (and should) implement some basic version of it in <code>ToString()</code> method, I advise against doing all the formatting inside the unit class. The formatting scenarios can be quite complex:</p>
<ul>
<li>Format based on user preferences (metric/imperial)</li>
<li>Pick units based on the value (e.g. 30 m but 1.2 km, not 1200 m)</li>
<li>Localization to different languages</li>
<li>Rounding to some closest value</li>
</ul>
<p>If you do all that in the unit class, it&#39;s going to violate the single responsibility principle. Just create a separate class for formatting and put all those rules there.</p>
<h2 id="unit-derivation">Unit derivation</h2>
<p>Once you write more unit classes, you will definitely want to derive the calculation result of two units into the third one. In our example, we want to divide <code>Volume</code> of fuel used by <code>Distance</code> to get fuel <code>ConsumptionRate</code>.</p>
<p>There&#39;s no magic that you could do here. You will have to define <code>ConsumptionRate</code> class the same way you defined the other two, and then just overload the operation</p>
<pre><code class="language-cs">public static ConsumptionRate operator/(Volume volume, Distance distance)
{
    return ConsumptionRate
        .FromLitersPer100Kilometers(volume.Liters * 100.0 / distance.Kilometers);
}</code></pre>
<p>Of course, you&#39;ll have to define all the required combinations explicitly.</p>
<p>If you defined Constants as described above, you&#39;ll be able to instantiate values in your tests in the following way:</p>
<pre><code class="language-cs">var fuelRate = 7.5 * lit / (100 * km);</code></pre>
<h2 id="should-i-use-3rd-party-libraries-for-that-">Should I use 3rd party libraries for that?</h2>
<p>It depends. Of course, people implemented all this functionality about 1 million times before you, so there are numerous libraries on GitHub.</p>
<p>I would say, if you start a new project and you don&#39;t have a strong opinion about the unit code, just go grab the library and try to use it.</p>
<p>At the same time, for existing code base, it might be easier to introduce your own implementation which would resemble something that you already use.</p>
<p>Also, I have another reason for my own implementation. I&#39;m using units all over the code base of domain logic, the very heart of the software, the exact place where I want full control. I find it a bit awkward to introduce a 3rd party dependency in domain layer.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/units-of-measurement/'>Units of Measurement</a>, <a href='/tags/domain-design/'>Domain Design</a>, <a href='/tags/ddd/'>DDD</a>, <a href='/tags/clean-code/'>Clean Code</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jul 28th, 2015</div>
    
    <h1><a href='/2015/07/aurelia-element-animation-with-custom-attribute/'>Aurelia element animation with custom attribute</a></h1>
    
    <div class="post-content">
        <p>I&#39;ve been exploring <a href="http://aurelia.io">Aurelia</a> javascript UI framework recently to get some experience needed
for our next big project. One thing that I couldn&#39;t implement out of the box was a kind 
of animation.</p>
<p>I have a grid of values bound to View Model. View Model communicates to server, receives
any updates of data and the grid got immediately updated, all that works great with Aurelia.
Now I want to highlight the cell which has just received an updated value with a small
background animation, like this:</p>
<p><img src="/2015/07/aurelia-element-animation-with-custom-attribute//animation.gif" alt="Updated cell animation"></p>
<p>Aurelia has a library called <a href="https://github.com/aurelia/animator-css">aurelia-animator-css</a> with a helper
class to run CSS animation. If you use it directly in your View Model, you will end up with the code like</p>
<pre><code class="language-js">this.newMessageReceived =
    msg =&gt; {
        this.data.filter(i =&gt; i.id === msg.id).forEach(t =&gt; {
            let editedItemIdx = this.data.indexOf(i);
            var elem = this.element.querySelectorAll(&#39;tbody tr&#39;)[editedItemIdx + 1]
                                   .querySelectorAll(&#39;td&#39;)[3];

            this.animator.addClass(elem, &#39;background-animation&#39;).then(() =&gt; {
                this.animator.removeClass(elem, &#39;background-animation&#39;);
            });
        });
    };</code></pre>
<p>So we get a new message, find the related item in our data, then find the index of that data. Then we use this
index in query selector to get the exact row that needs animation, find the cell by hard coded index, and 
finally use animator to highlight the background.</p>
<p>Ouch... That smells. We spoiled our view model with view details, and all this code is very ugly and fragile.</p>
<p>Good news: we can improve the solution with the Aurelia&#39;s feature called Custom Attributes. Let&#39;s create a new
javascript file and call it <code>animateonchange.js</code>:</p>
<pre><code class="language-js">import {customAttribute} from &#39;aurelia-framework&#39;;

@customAttribute(&#39;animateonchange&#39;)
export class AnimateOnChangeCustomAttribute {

}</code></pre>
<p>I declared a class for our new attribute, so far it&#39;s empty. I imported customAttribute decorator from
Aurelia framework: that the way we can define a name for our custom attribute. This can be avoided: if I
change the name to <code>AnimateonchangeCustomAttribute</code>, Aurelia will infer the name from class name, but I want
to stay explicit and keep the class name readable. Note that capital letters are not allowed in attribute name.</p>
<p>Now, let&#39;s declare the constructor of the new class and inject all the dependencies:</p>
<pre><code class="language-js">import {inject, customAttribute} from &#39;aurelia-framework&#39;;
import {CssAnimator} from &#39;aurelia-animator-css&#39;;

@customAttribute(&#39;animateonchange&#39;)
@inject(Element, CssAnimator)
export class AnimateOnChangeCustomAttribute {

    constructor(element, animator) {
        this.element = element;
        this.animator = animator;
    }

}</code></pre>
<p>I used dependency injection to get attribute&#39;s element and CSS animator and save them into class fields.
Here&#39;s how to use them:</p>
<pre><code class="language-js">import {inject, customAttribute} from &#39;aurelia-framework&#39;;
import {CssAnimator} from &#39;aurelia-animator-css&#39;;

@customAttribute(&#39;animateonchange&#39;)
@inject(Element, CssAnimator)
export class AnimateOnChangeCustomAttribute {
    constructor(element, animator) {
        this.element = element;
        this.animator = animator;
        this.initialValueSet = false;
    }

    valueChanged(newValue){
        if (this.initialValueSet) {
            this.animator.addClass(this.element, &#39;background-animation&#39;).then(() =&gt; {
                this.animator.removeClass(this.element, &#39;background-animation&#39;);
            });
        }
        this.initialValueSet = true;
    }
}</code></pre>
<p>The new method <code>valueChanged</code> will be called every time the bound value changes. I want to ignore the
first value (it&#39;s not an update yet), so I did that with <code>initialValueSet</code> flag. Then I just run CSS 
animator. No DOM-related queries!</p>
<p>Here is how we use the custom attribute from a view:</p>
<pre><code class="language-html">&lt;template&gt;

    &lt;require from=&quot;./animateonchange&quot;&gt;&lt;/require&gt;

    &lt;table class=&quot;table&quot;&gt;
        &lt;tr repeat.for=&quot;item of data&quot;&gt;
            &lt;td&gt;${item.value1}&lt;/td&gt;
            &lt;td&gt;${item.value2}&lt;/td&gt;
            &lt;td animateonchange.bind=&quot;item.value3ToUpdate&quot;&gt;${item.value3ToUpdate}&lt;/td&gt;
            &lt;td&gt;${item.value4}&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;

&lt;/template&gt;</code></pre>
<p>First, we use <code>require</code> element to import custom attribute definition (make sure the path is correct
and no <code>.js</code> extension is present).</p>
<p>Second, we use <code>animateonchange.bind</code> to bind the value to the custom attributes. And it works!</p>
<p>Of course, you need to define the CSS class, e.g.</p>
<pre><code class="language-css">.background-animation-add {
    -webkit-animation: changeBack 0.5s;
    animation: changeBack 0.5s;
}
.background-animation-remove {
    -webkit-animation: fadeIn 0.5s;
    animation: fadeIn 0.5s;
}
@-webkit-keyframes changeBack {
    0% { background-color: white; }
    50% { background-color: lightgreen; }
    100% { background-color: white; }
}
@keyframes changeBack {
    0% { background-color: white; }
    50% { background-color: lightgreen; }
    100% { background-color: white; }
}</code></pre>
<p>Here is a <a href="http://plnkr.co/edit/oa0Kb1hf6D9M2jl22vWD">plunkr link to a complete example</a></p>
<p>Happy coding!</p>
<p>Useful links:</p>
<ul>
<li><p><a href="http://aurelia.io/docs.html#custom-attributes">Aurelia Custom Attributes documentation</a></p>
</li>
<li><p><a href="http://blog.durandal.io/2015/07/17/animating-apps-with-aurelia-part-1/">Animating Apps with Aurelia - Part 1 by Rob Eisenberg</a></p>
</li>
</ul>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/javascript/'>Javascript</a>, <a href='/tags/aurelia/'>Aurelia</a>, <a href='/tags/animation/'>Animation</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">May 27th, 2015</div>
    
    <h1><a href='/2015/05/peer-code-review-whys-hows-and-whats/'>Peer code review Why's, How's and What's</a></h1>
    
    <div class="post-content">
        <p>This post is a short summary on why do code reviews, what the steps are and what should actually be reviewed. The text was created to set some common ground for my team, which was just starting to conduct code reviews in a consistent way. By any means, this text is not a complete guide but rather a checklist and a starting point for discussion.</p>
<h2 id="why-s">WHY&#39;s</h2>
<p>So, why spend time on code reviews at all? The most important reasons are listed below:</p>
<p><strong>To find bugs</strong>, to spot and fix defects early in the process;</p>
<p><strong>To spread knowledge</strong>, to share understanding of the code base as team members learn from each other and increase team cohesiveness;</p>
<p><strong>To agree on rules</strong>, to maintain a level of consistency in design and implementation;</p>
<p><strong>To improve as the team</strong>, to identify common defects across the team thus reduce rework;</p>
<p><strong>To get second opinion</strong>, to add a different perspective, &quot;another set of eyes&quot; adds objectivity.</p>
<h2 id="how-s">HOW&#39;s</h2>
<p>Which steps should I take during code reviews? This depends a lot on the tools being used, of course. We use the following set of tools: task management tool (<em>Atlassian JIRA</em>), IDE (<em>Visual Studio</em>), source control log (Git log viewer of taste) and code review tool (<em>Atlassian Crucible/FishEye</em>). 
You should do the following during your code review process:</p>
<p><strong>Understand the scope</strong>, read the task description, user story, commit or pull request message;</p>
<p><strong>Get the code</strong>, pull the latest code to your hard drive and in your IDE, create a review item in code review tool, make sure that all changes are included;</p>
<p><strong>Read and understand</strong> all the changes by navigating them in your tools;</p>
<p><strong>Ask the author</strong> if something is unclear;</p>
<p><strong>Go through the checklist</strong> (below) and make your peer judgement;</p>
<p><strong>Put your comments</strong> to code review tool, as written comments are usually preferred over verbal;</p>
<p><strong>Merge the code</strong> into main repository or integration branch, if you agree with the proposed changes;</p>
<p><strong>Report the result back</strong> to the team by moving the task to rejected or accepted state, according to your team&#39;s workflow.</p>
<h2 id="what-s">WHAT&#39;s</h2>
<p>Here is the approximate checklist of what should be reviewed during the code review. Start at the top and go down to the bottom.</p>
<p><strong>Readiness</strong>: Is the change under review submitted correctly, are all tests green?</p>
<p><strong>Functionality</strong>: Does the code work? Does it perform its intended function, is the logic correct etc. You don&#39;t have to test all scenarios, but you should at least think of possible scenarios and whether the code addresses all of them in your opinion.</p>
<p><strong>Readability</strong>: Is all the code easy to understand? When you read the code, is it easy to understand every detail of it without spending a lot of time and effort?</p>
<p><strong>Testabity</strong>: Is the code testable? I.e. not too many dependencies, unable to initialize objects with stubs or mocks, test frameworks can use methods etc.</p>
<p><strong>No duplication</strong>: Is there any redundant or duplicate code? Do you see some possibility to refactor it to reduce duplication? </p>
<p><strong>Reuse</strong>: Did the author reuse existing classes and libraries for solving common tasks? Is the naming and code structure consistent with similar existing blocks of solution? Can any of the code be replaced with library functions?</p>
<p><strong>Design</strong>: Do you agree with the design and structure of code blocks? Think of coupling and cohesion, SOLID principles, dependency chains etc.</p>
<p><strong>Unit tests</strong>: Do tests exist and are they comprehensive? Are all the changes covered by unit tests? Do they conform to unit testing guidelines? Can you think of more tests which are missing?</p>
<p><strong>Readability of tests</strong>: Are tests short and readable? Do they reveal any design problems?</p>
<p><strong>Error handling</strong>: Is exception handling and logging consistent? Are they tested?</p>
<p><strong>Public contracts</strong>: Could the code violate backwards compatibility when we have to keep it?</p>
<p><strong>No leftovers</strong>: Do you see any code which is commented out or any TODOs? Can any logging or debugging code be removed without loosing functionality?</p>
<p><strong>Code style</strong>: Does it conform to your agreed programming practices and coding style? Do ReSharper and static code analysis tools give no errors and warnings?</p>
<p><strong>Documentation</strong>: Was the documentation updated in case the change touches public API?</p>
<p><strong>Comments</strong>: Are all comments valid? Do you see any dummy comments which are unreadable and were created just to make ReSharper happy?</p>
<p><strong>Performance</strong>: Do you see any potential performance problems that have to be solved before the first version of this code is accepted? When applicable, measure the CPU load, memory, or traffic consumption caused by new code.</p>
<p><strong>High level tests</strong>: When applicable, are integration and/or end-to-end tests created?</p>
<p><strong>Data migration</strong>: When applicable, was database migration script updated?</p>
<p>Am I missing anything important? Probably yes, so please share your suggestions in the comments. 
Happy reviews!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/code-review/'>Code Review</a>, <a href='/tags/best-practices/'>Best Practices</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Apr 8th, 2015</div>
    
    <h1><a href='/2015/04/unit-testing-null-parameter-checks/'>Unit testing null parameter checks</a></h1>
    
    <div class="post-content">
        <p>We use constructor dependency injection throughout our application. This means that most service classes have constructors, which accept all dependencies in form of interfaces. They are then saved to private fields to be used while class methods are executed. Here is an example (all examples below are in C#):</p>
<pre><code>public class VeryUsefulClass : IVeryUsefulClass
{
    private readonly ISomething something;
    private readonly ISomethingElse somethingElse;

    public VeryUsefulClass(ISomething something, ISomethingElse somethingElse)
    {
        this.something = something;
        this.somethingElse = somethingElse;
    }

    public AwesomeResponse DoUsefullStaff(ImportantRequest request)
    {
        this.something.DoSomething();
        this.somethingElse.DoSomethingElse();
        return ...;
    }
}</code></pre><p>We also use TDD, which means we must write unit tests for every aspect of our code. So I want to discuss one specific aspect: guarding the constructor parameters from null values and testing this guard. Here is one possible way to write such tests (with NUnit and Moq):</p>
<pre><code>[TestFixture]
public class VeryUsefulClassTests
{
    [Test]
    public void WhenSomethingIsNullConstructorThrowsNullException()
    {
        Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; 
            new VeryUsefulClass(null, new Mock&lt;ISomethingElse&gt;.Object));
    }

    [Test]
    public void WhenSomethingElseIsNullConstructorThrowsNullException()
    {
        Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; 
            new VeryUsefulClass(new Mock&lt;ISomething&gt;.Object, null));
    }

    [Test]
    public void ImportantRequestProducesAwesomeResponse()
    {
        var target = new VeryUsefulClass(new Mock&lt;ISomething&gt;.Object, 
            new Mock&lt;ISomethingElse&gt;.Object);
        ...
    }

    ...
}</code></pre><p>The tests are small and each one tests just one thing. But it looks like we have a bit too much duplication and &quot;noise&quot;: too much service code around real code under test. </p>
<h2 id="make-it-better">Make it better</h2>
<p>Now let&#39;s say we need to introduce another dependency into our useful class: ISomethingNew. The constructor signature will change to</p>
<pre><code>public VeryUsefulClass(ISomething something, 
    ISomethingElse somethingElse, 
    ISomethingNew somethingNew)
{
    ...
}</code></pre><p>So, how many places do we have to change in our test class? One per each test, which includes one per each constructor parameter. Quite a lot! If we have a class with many dependencies, we are in trouble. So, before introducing the new dependency, let&#39;s refactor the tests. First, let&#39;s declare all mocks as private fields and create them in set-up method:</p>
<pre><code>[TestFixture]
public class VeryUsefulClassTests
{
    private Mock&lt;ISomething&gt; something;
    private Mock&lt;ISomethingElse&gt; somethingElse;

    [SetUp]
    public void SetUp()
    {
        this.something = new Mock&lt;ISomething&gt;();
        this.somethingElse = new Mock&lt;ISomethingElse&gt;();
    }
...</code></pre><p>This way the same clean mocks will be available for each and every test. To make use of them, let&#39;s create GetTarget method which will create an instance of class under test</p>
<pre><code>private VeryUsefulClass GetTarget()
{
    return new VeryUsefulClass(this.something.Object, this.somethingElse.Object);
}</code></pre><p>Now we are ready to rewrite our test methods with less duplication</p>
<pre><code>[Test]
public void WhenSomethingIsNullConstructorThrowsNullException()
{
    this.something = null;
    Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; this.GetTarget());
}

[Test]
public void WhenSomethingElseIsNullConstructorThrowsNullException()
{
    this.somethingElse = null;
    Assert.ThrowsException&lt;ArgumentNullException&gt;(() =&gt; this.GetTarget());
}

[Test]
public void ImportantRequestProducesAwesomeResponse()
{
    var target = this.GetTarget();
    ...
}</code></pre><p>So, how many constructor calls do we have to change when we introduce a new dependency now? Just one for the complete test class!</p>
<p>I strongly believe that readability of your test classes is very important. If you make your tests short, expressive and easy to read, your tests will have much higher value: not only the safety net for classes, but also nice documentation which is easy to use and support.</p>
<h2 id="make-it-shine">Make it shine</h2>
<p>I&#39;m still not quite satisfied with the amount of code we have to write for such a simple thing as the validation of ArgumentNullException being thrown from constructors. Imagine this: we have hundreds or thousands of classes which follow this same pattern, and we end up writing thousands tests which look almost exactly the same... </p>
<p>I solved it with a simple helper method:</p>
<pre><code class="language-csharp">public void ConstructorMustThrowArgumentNullException(Type type)
{
    foreach (var constructor in type.GetConstructors())
    {
        var parameters = constructor.GetParameters();
        var mocks = parameters.Select(
            p =&gt;
                {
                    Type mockType = typeof(Mock&lt;&gt;).MakeGenericType(
                        new[] { p.ParameterType });
                    return (Mock)Activator.CreateInstance(mockType);
                }).ToArray();

        for (int i = 0; i &lt; parameters.Length; i++)
        {
            var mocksCopy = mocks.Select(m =&gt; m.Object).ToArray();
            mocksCopy[i] = null;
            try
            {
                constructor.Invoke(mocksCopy);
                Assert.Fail(&quot;ArgumentNullException expected for parameter {0} of 
                             constructor, but no exception was thrown&quot;, 
                             parameters[i].Name);
            }
            catch (TargetInvocationException ex)
            {
                Assert.AreEqual(typeof(ArgumentNullException), 
                    ex.InnerException.GetType(), 
                    string.Format(&quot;ArgumentNullException expected for parameter {0} of 
                        constructor, but exception of type {1} was thrown&quot;, 
                        parameters[i].Name, ex.InnerException.GetType()));
            }
        }
    }
}</code></pre>
<p>It accepts a type as its only input parameter (obviously, it&#39;s easy to make it generic or an extension method). Then, using the reflection, it iterates through the input parameters of a constructor, and passes one null value and mocks all other parameters. It expects ArgumentNullException to be thrown on each call.</p>
<p>You could write one test for all classes in a namespace or in assembly, if the pattern is applied consistently there! And it will let you know when one of your new classes violates the common rule, with zero extra effort.</p>
<p>Does anyone know the library which would do that without me inventing the bicycle myself?</p>
<p>Happy coding!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/unit-testing/'>Unit Testing</a>, <a href='/tags/dependency-injection/'>Dependency Injection</a>, <a href='/tags/guard/'>Guard</a>, <a href='/tags/clean-code/'>Clean Code</a>, <a href='/tags/best-practices/'>Best Practices</a>, <a href='/tags/reflection/'>Reflection</a>, <a href='/tags/c#/'>C#</a>, <a href='/tags/tdd/'>TDD</a>
    </div>
    
</article>


<div class="page-nav">
    
    <a class="page-nav-newer" href="/11/">&lt;&lt; Previous page</a>
    
    
    <a class="page-nav-older" href="/13/">Next page &gt;&gt;</span></a>
    
</div>

<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy F#, C#, Javascript and SQL development, reasoning about distributed systems, data processing pipelines, cloud and web apps. I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="https://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="https://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>
</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2018 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/prism.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>