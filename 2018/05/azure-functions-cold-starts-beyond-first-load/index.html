<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Cold Starts Beyond First Request in Azure Functions | Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="twitter:card" content="summary"></meta>
    <meta name="twitter:creator" content="@MikhailShilkov"></meta>

    <meta property="og:type" content="article" />
    <meta property="og:title" content="Cold Starts Beyond First Request in Azure Functions" />
    <meta property="og:url" content="https://mikhail.io/2018/05/azure-functions-cold-starts-beyond-first-load/" />

    <meta property="og:image" content="https://mikhail.io/2018/05/azure-functions-cold-starts-beyond-first-load/teaser.jpg" />


    <meta property="og:description" content="Can we avoid cold starts by keeping Functions warm, and will cold starts occur on scale out? Let's try!" />


    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.6" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">Serverless, Azure, FP, F# and more</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                    <li><a href="/tags/">Topics</a></li>
                
                    <li><a href="/archives/">Archives</a></li>
                
                    <li><a href="/talks/">Talks</a></li>
                
                    <li><a href="/about/">About</a></li>
                
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="https://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="https://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    <article class="post">
    <div class="post-date">May 18th, 2018</div>
    
    <h1>Cold Starts Beyond First Request in Azure Functions</h1>
    
    <div class="post-content">
        <p>In my <a href="https://mikhail.io/2018/04/azure-functions-cold-starts-in-numbers/">previous article</a>
I&#39;ve explored the topic of Cold Starts in Azure Functions. Particularly, I&#39;ve measured the
cold start delays per language and runtime version.</p>
<p>I received some follow-up questions that I&#39;d like to explore in today&#39;s post:</p>
<ul>
<li>Can we avoid cold starts except the very first one by keeping the instance warm?</li>
<li>Given one warm instance, if two requests come at the same time, will one request hit 
a cold start because existing instance is busy with the other?</li>
<li>In general, does a cold start happen at scale-out when a new extra instance is provisioned?</li>
</ul>
<p>Again, we are only talking Consumption Plan here.</p>
<h2 id="theory">Theory</h2>
<p>Azure Functions are running on instances provided by Azure App Service. Each instance is
able to process several requests concurrently, which is different comparing to AWS Lambda.</p>
<p>Thus, the following <em>could</em> be true:</p>
<ul>
<li>If we issue at least 1 request every 20 minutes, the first instance should stay warm for
long time</li>
<li>Simultaneous requests don&#39;t cause cold start unless the existing instance gets too busy</li>
<li>When runtime decides to scale out and spin up a new instance, it could do so in the background,
still forwarding incoming requests to the existing warm instance(s). Once the new instance
is ready, it could be added to the pool without causing cold starts</li>
<li>If so, cold starts are mitigated beyond the very first execution</li>
</ul>
<p>Let&#39;s put this theory under test!</p>
<h2 id="keeping-always-warm">Keeping Always Warm</h2>
<p>I&#39;ve tested a Function App which consists of two Functions:</p>
<ul>
<li>HTTP Function under test</li>
<li>Timer Function which runs every 10 minutes and does nothing but logging 1 line of text</li>
</ul>
<p>I then measured the cold start statistics similar to all the tests from my previous article.</p>
<p>During 2 days I was issuing infrequent requests to the same app, most of them would normally
lead to a cold start. Interestingly, even though I was regularly firing the timer, Azure 
switched instances to serve my application 2 times during the test period:</p>
<p><img src="/2018/05/azure-functions-cold-starts-beyond-first-load//cold-starts-keep-warm.png" alt="Infrequent Requests to Azure Functions with &quot;Keep It Warm&quot; Timer"></p>
<p>I can see that most responses are fast, so timer &quot;warmer&quot; definitely helps.</p>
<p>The first request(s) to a new instance are slower than subsequent ones. Still, they are faster
than normal full cold start time, so it could be related to HTTP stack loading.</p>
<p>Anyway, keeping Functions warm seems a viable strategy.</p>
<h2 id="parallel-requests">Parallel Requests</h2>
<p>What happens when there is a warm instance, but it&#39;s already busy with processing another
request? Will the parallel request be delayed, or will it be processed by the same
warm instance?</p>
<p>I tested with a very lightweight function, which nevertheless takes some time to complete:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="hljs-title">Delay500</span>(<span class="hljs-params">[HttpTrigger] HttpRequestMessage req</span>)
</span>{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">500</span>);
    <span class="hljs-keyword">return</span> req.CreateResponse(HttpStatusCode.OK, <span class="hljs-string">"Done"</span>);
}
</code></pre>
<p>I believe it&#39;s an OK approximation for an IO-bound function.</p>
<p>The test client then issued 2 to 10 parallel requests to this function and measured the
response time for all requests.</p>
<p>It&#39;s not the easiest chart to understand in full, but note the following:</p>
<ul>
<li><p>Each group of bars are for requests sent at the same time. Then there goes a pause about
20 seconds before the next group of requests gets sent</p>
</li>
<li><p>The bars are colored by the instance which processed that request: same instance - same
color</p>
</li>
</ul>
<p><img src="/2018/05/azure-functions-cold-starts-beyond-first-load//cold-starts-during-simultaneous-requests.png" alt="Azure Functions Response Time to Batches of Simultaneous Requests"></p>
<p>Here are some observations from this experiment:</p>
<ul>
<li><p>Out of 64 requests, there were 11 cold starts</p>
</li>
<li><p>Same instance <em>can</em> process multiple simultaneous requests, e.g. one instance processed
7 out of 10 requests in the last batch</p>
</li>
<li><p>Nonetheless, Azure is eager to spin up new instances for multiple requests. In total
12 instances were created, which is even more than max amount of requests in any single
batch</p>
</li>
<li><p>Some of those instances were actually never reused (gray-ish bars in batched x2 and x3,
brown bar in x10)</p>
</li>
<li><p>The first request to each new instance pays the full cold start price. Runtime doesn&#39;t
provision them in background while reusing existing instances for received requests</p>
</li>
<li><p>If an instance handled more than one request at a time, response time invariably suffers,
even though the function is super lightweight (<code>Task.Delay</code>)</p>
</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Getting back to the experiment goals, there are several things that we learned.</p>
<p>For low-traffic apps with sporadic requests it makes sense to setup a &quot;warmer&quot; timer
function firing every 10 minutes or so to prevent the only instance from being recycled.</p>
<p>However, scale-out cold starts are real and I don&#39;t see any way to prevent them from
happening.</p>
<p>When multiple requests come in at the same time, we might expect some of them to hit
a new instance and get slowed down. The exact algorithm of instance reuse is not
entirely clear.</p>
<p>Same instance is capable of processing multiple requests in parallel, so there are
possibilities for optimization in terms of routing to warm instances during the
provisioning of cold ones. </p>
<p>If such optimizations happen, I&#39;ll be glad to re-run my tests and report any noticeable
improvements.</p>
<p>Stay tuned for more serverless perf goodness!</p>

    </div>

    
    <p>
      Like this post? Please share it!<br />
      <table>
        <tr>
          <td>
            <a href="https://twitter.com/share" class="twitter-share-button" data-via="MikhailShilkov">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
          </td>
          <td>
            <a href="http://news.ycombinator.com/submit" class="hn-share-button" style="height: 28px">Vote on HN</a>
            <script src="//hnbutton.appspot.com/static/hn.min.js" async defer></script>
          </td>
          <td style="vertical-align: top; padding-top: 3px">
            <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false"> <img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" width="75" /> </a>
          </td>
        </tr>
      </table>
    </p>

    See a mistake? <a href="https://github.com/mikhailshilkov/mikhailio-docpad/edit/master/src/documents/2018/05/azure-functions-cold-starts-beyond-first-load//index.html.md">Edit this post!</a><br />
    

    
    <div class="post-tags">
        Posted In: <a href='/tags/azure/'>Azure</a>, <a href='/tags/azure-functions/'>Azure Functions</a>, <a href='/tags/serverless/'>Serverless</a>, <a href='/tags/performance/'>Performance</a>, <a href='/tags/cold-start/'>Cold Start</a>
    </div>
    
</article>
    <div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy F#, C#, Javascript and SQL development, reasoning about distributed systems, data processing pipelines, cloud and web apps. I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="https://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="https://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

    <div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript></div>
<script type="text/javascript">
    var disqus_shortname = 'mikhailio';
    var disqus_url = 'https://mikhail.io/2018/05/azure-functions-cold-starts-beyond-first-load/';
    var disqus_identifier = disqus_url;
    var disqus_title = 'Cold Starts Beyond First Request in Azure Functions';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2018 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>