<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Building a Poker Bot with Akka.NET Actors | Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.4" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">.NET, SQL and Javascript programmer</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                <li><a href="/">Blog</a></li>
                <li><a href="/about">About</a></li>
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="http://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-sm-12 col-md-10">
            <article class="post">
    <div class="post-date">Feb 25th, 2016</div>
    
    <h1>Building a Poker Bot with Akka.NET Actors</h1>
    
    <div class="post-content">
        <p><em>This is the fourth part of <strong>Building a Poker Bot</strong> series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here are the previous parts:</em></p>
<ul>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/"><em>Building a Poker Bot: Card Recognition</em></a></li>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/"><em>Building a Poker Bot: String and Number Recognition</em></a></li>
<li><a href="http://mikhail.io/2016/03/building-a-poker-bot-mouse-movements/"><em>Building a Poker Bot: Mouse Movements</em></a></li>
</ul>
<p>This post lays out the most exciting part of the bot. I&#39;ll compose recognition, flow, decision and mouse clicking
parts together into the bot application. The application is a console executable interacting with multiple 
windows of poker room software.</p>
<h2 id="flow">Flow</h2>
<p>The following picture shows the outline of the application flow:</p>
<p>(Find tables) -&gt; (Recognize each screen) -&gt; (Understand what happened) -&gt; (Make decision) -&gt; (Click the button)</p>
<p>Find tables - Every half a second or so we scan the all windows and search for open poker tables among them.
For each poker table we make a screenshot and send those to recognition.</p>
<p>Recognize a screen - Parse the data from the screenshot. Check whether it&#39;s our turn to make a play now, what
the <a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">cards</a> and 
<a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/">stacks</a> are, etc.</p>
<p>Understand what happened - Understand if that&#39;s a new hand or there was a past history before. See
what your villains did and which new cards we got. Obviously, the history of current hand state should be 
preserved here.</p>
<p>Make decision - Here the secret sauce comes to play and produces a move to be made. This is actually the meat
that makes the whole application useful, but I won&#39;t discuss it in details in this post.</p>
<p>Click the button - Based on the decision made, click the right buttons. It should be done with proper delays
and <a href="http://mikhail.io/2016/03/building-a-poker-bot-mouse-movements/">human-like movements</a> so that the villain
and poker room don&#39;t understand that it&#39;s bot that is playing.</p>
<h2 id="let-the-actors-play">Let the Actors Play</h2>
<p>Because of the multi-tabling that I mentioned, the application is intinsically multi-threaded. At the same time,
the different parts of the flow are executed at different cadence:</p>
<ul>
<li>Finding tables is triggered by time and is single-threaded</li>
<li>Screen recognition, history detection and decision making run in sequence and can be executed parallely
for multiple tables</li>
<li>Clicking the buttons is again single-threaded, and it must syncronize the outputs from the previous steps,
put them in sequence with appropriate delays</li>
</ul>
<p>Here are the other threats of the flow:</p>
<ul>
<li>It is reactive and event based</li>
<li>The flow is unidirectional, the output of one step goes to the input of the next step</li>
<li>Most steps are stateless, but the history state needs to be preserved and, ideally, isolated from the other
steps</li>
</ul>
<p>This list of features made me pick the Actor-based <a href="http://getakka.net">Akka.NET</a> framework to implement the flow.
For sure, the application could be done with a bunch of procedural code instead. But I found actors to be
a useful modeling tecnique to be employed. Also, I was curious how F# and Akka.NET would work together.</p>
<h2 id="supervision-hierachy">Supervision Hierachy</h2>
<p>In Akka.NET each actor has a supervisor actor who is managing its lifecycle. All actors together form a
supervision tree. Here is the tree shown for the Player application:</p>
<p>(TODO)</p>
<p>There is just one copy of both Table Finder and Button Clicker actors and they are supervised by the root
User actor. For each poker table a Recognition actor gets created. These actors are managed by Table 
Finder. Each Recognizer actor creates an instance of History actors to track the hand history, and each
History actor creates an instance of Decision actor to make decisions for a given hand history. Finally,
all decisions are sent to one centralized Clicker actor whose job is to click all the tables with proper
delays and in order.</p>
<h2 id="implementation-pattern">Implementation Pattern</h2>
<p>All actors are implementation using one pattern. Here is the definition of this structure:</p>
<pre class="highlight"><code class="hljs rust"><span class="hljs-keyword">type</span> <span class="hljs-title">ThisActorMessage</span> = { <span class="hljs-comment">/* fields of the message */</span> }

<span class="hljs-keyword">let</span> actor messageProcessingFunction knownReferences =
  <span class="hljs-comment">// define mutable actor state here</span>
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">let</span> imp (mailbox : Actor&lt;'a&gt;) (msg : ThisActorMessage) =    
    <span class="hljs-keyword">let</span> outputMsg = messageProcessingFunction msg
    <span class="hljs-comment">// send output message to another actor from known references or internal state</span>
    <span class="hljs-comment">// ...</span>
imp
</code></pre><p>Let&#39;s look at some examples to understand this structure better.</p>
<h2 id="clicker-actor">Clicker Actor</h2>
<p>Clicker actor has the simplest implementation beacause it does not send messages to other actors:</p>
<pre class="highlight"><code class="hljs ocaml"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ClickTarget</span> </span>= (<span class="hljs-built_in">int</span> * <span class="hljs-built_in">int</span> * <span class="hljs-built_in">int</span> * <span class="hljs-built_in">int</span>)
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ClickerMessage</span> </span>= {
  WindowTitle: <span class="hljs-built_in">string</span>
  Clicks: ClickTarget[]
}

<span class="hljs-keyword">let</span> clickerActor click =
  <span class="hljs-keyword">let</span> imp _ (msg: ClickerMessage) = click msg
  imp
</code></pre><p>Basically, there are just 3 parts here:</p>
<ol>
<li>Clicker Message with window information and targets to be clicked.</li>
<li>A <code>click</code> function of type <code>ClickerMessage -&gt; unit</code> which executes button clicks with proper
delays etc.</li>
<li>The actor implementation <code>imp</code>, which is an adapter function between the type of <code>click</code> and the type 
that is expected by Akka.NET. The <code>mailbox</code> parameter is ignored.</li>
</ol>
<p>Here is how the actor is created:</p>
<pre class="highlight"><code class="hljs 1c">let clickerRef = 
  clickerActor click'
  <span class="hljs-string">|&gt; actorOf2 </span>
  <span class="hljs-string">|&gt; spawn system "</span>clicker-actor<span class="hljs-string">"</span>
</code></pre><p>Actor goes under supervision by actor system with <code>click&#39;</code> as message handler.</p>
<h2 id="recognizer-actor">Recognizer Actor</h2>
<pre class="highlight"><code class="hljs nimrod"><span class="hljs-keyword">let</span> actor recognize decider =
  <span class="hljs-keyword">let</span> mutable decideRef = null
  <span class="hljs-keyword">let</span> imp (mailbox : <span class="hljs-type">Actor</span>&lt;'a&gt;) (window : <span class="hljs-type">WindowInfo</span>) =
    <span class="hljs-keyword">let</span> <span class="hljs-literal">result</span> = recognize window.<span class="hljs-type">Bitmap</span>
    <span class="hljs-keyword">if</span> decideRef = null then decideRef &lt;- spawn mailbox.<span class="hljs-type">Context</span> <span class="hljs-string">"decide-actor"</span> (actorOf2 &lt;| decider)
    decideRef &lt;! { <span class="hljs-type">WindowTitle</span> = window.<span class="hljs-type">Title</span>; <span class="hljs-type">TableName</span> = window.<span class="hljs-type">TableName</span>; <span class="hljs-type">Screen</span> = <span class="hljs-literal">result</span>; <span class="hljs-type">Bitmap</span> = window.<span class="hljs-type">Bitmap</span> }
  imp
</code></pre>
    </div>

    
    <p>
      Like this post? Please share it!<br />
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="MikhailShilkov" data-size="large" data-count="none">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </p>

    See a mistake? <a href="https://github.com/mikhailshilkov/mikhailio-docpad/edit/master/src/documents/draftindex.html.md">Edit this post!</a><br />
    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>poker bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/akka.net/'>akka.net</a>, <a href='/tags/actors/'>actors</a>
    </div>
    
</article>
            <div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy C#, Javascript and SQL development and I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="http://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="http://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

            <div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a></noscript></div>
<script type="text/javascript">
    var disqus_shortname = 'mikhailio';
    var disqus_url = 'http://mikhail.io/draft';
    var disqus_identifier = disqus_url;
    var disqus_title = 'Building a Poker Bot with Akka.NET Actors';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

        </div>
    </div>
</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2015 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>