<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="twitter:card" content="summary_large_image"></meta>
    <meta name="twitter:creator" content="@MikhailShilkov"></meta>
    <meta name="twitter:title" content="Mikhail Shilkov"></meta>

    <meta property="og:type" content="article" />
    <meta property="og:title" content="Mikhail Shilkov" />
    <meta property="og:url" content="https://mikhail.io/10/index.html" />



    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">
    <link href="/vendor/prism.css" rel="stylesheet" media="screen">

    <meta name="generator" content="DocPad v6.80.6" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">Serverless, Azure, FP, F# and more</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                    <li><a href="/tags/">Topics</a></li>
                
                    <li><a href="/archives/">Archives</a></li>
                
                    <li><a href="/talks/">Talks</a></li>
                
                    <li><a href="/about/">About</a></li>
                
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="https://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="https://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Mar 21st, 2016</div>
    
    <h1><a href='/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/'>Functional Actor Patterns with Akka.NET and F#</a></h1>
    
    <div class="post-content">
        <p>My exploration of Actor model started with <a href="http://getakka.net">Akka.NET</a> framework - a .NET port of
JVM-based <a href="http://akka.io">Akka</a>. Actor programming model made a lot of sense to me, but once
I started playing with it, some questions arose. Most of those questions were related to the
following <a href="http://doc.akka.io/docs/akka/2.4.2/general/actors.html">definition</a>:</p>
<blockquote>
<p>An actor is a container for <code>State</code>, <code>Behavior</code>, a <code>Mailbox</code>, <code>Children</code> and a <code>Supervisor Strategy</code>.</p>
</blockquote>
<p>So, based on the <a href="https://github.com/petabridge/akka-bootcamp">Akka.NET Bootcamp</a> course I understood that
an Actor</p>
<ul>
<li>knows what kind of messages it can accept</li>
<li>does some processing of each message</li>
<li>holds some state which is changed during message processing</li>
<li>potentially changes its behavior based on the current state</li>
<li>creates and stores references to child actors</li>
<li>obtains references to other actors</li>
<li>sends messages to children and other actors</li>
</ul>
<p>While it&#39;s nice that the framework enables us to develop for different aspects of actor 
behavior, it might also be dangerous in case you do all the things in one place. Ball of spaghetti mud
was where I ended up during my first attempt. My actors were doing all the things from 
the above list and the code got messy very quick. So, the following questions popped up
in my head:</p>
<p><em>How do I avoid mixing several concerns in one piece of code?</em></p>
<p><em>How do I make the code easily testable?</em></p>
<p><em>How do I minimize the usage of mutable state?</em></p>
<p><em>How do I avoid boilerplate code when it&#39;s not needed?</em></p>
<h2 id="functional-actors">Functional Actors</h2>
<p>I am now developing the actor-based application in F#, the functional first
language. Functions are easy to reason about, reusable and testable. But the
actors are usually defined in terms of objects and classes. F# supports classes
but that&#39;s not the path that I&#39;m willing to go.</p>
<p>How do we make actors out of functions? Well, most of the time actors don&#39;t 
need all the features of the framework. In this case we can define the required actor
behavior in terms of a minimal function and then use creational patterns to
spawn actor instances out of it.</p>
<p>Let&#39;s look at some common patterns that I identified. For each pattern, I will
define </p>
<ul>
<li>an example of a core function which implements the business logic</li>
<li>a generic function to create actors with behavior of a core function</li>
<li>an example of actor instantiation using the two functions above</li>
</ul>
<hr>
<p><a name="MessageSink" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/undefined"></a></p>
<h2 id="message-sink">Message Sink</h2>
<p>Stateless Message Sink is the simplest type of actor.</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//messagesink.png" alt="Message Sink actor"></p>
<p>It receives a message and executes some action on it. The action is not related
to any other actors, and there is no state, so the processing of each message
is always the same. Obviously, it&#39;s related to some kind of side effects:
logging the message, saving the data to the external storage and so on.</p>
<p>So, we don&#39;t need the majority of actor features in this case. The whole actor
processing could be represented by a function of type <code>&#39;a -&gt; unit</code>. Here 
is an example of a core function:</p>
<pre><code class="language-fsharp">let print msg =
  printn &quot;Message received: %A&quot; msg</code></pre>
<p>So how do we make an actor out of this function? Well, it&#39;s already implemented
as <code>actorOf</code> helper function in Akka.NET F# extensions:</p>
<pre><code class="language-fsharp">let actorOfSink (f : &#39;a -&gt; unit) = actorOf f</code></pre>
<p>And here is how we spawn an actor instance:</p>
<pre><code class="language-fsharp">let printActorRef = 
  actorOfSink print 
  |&gt; spawn system &quot;print-actor&quot;

printActorRef &lt;! 3
// &quot;Message received: 3&quot; is printed</code></pre>
<p>That&#39;s the simplicity that I&#39;m searching for. Let&#39;s look at a slightly more
complex example.</p>
<hr>
<p><a name="Converter" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/undefined"></a></p>
<h2 id="converter">Converter</h2>
<p>Stateless Converter maps the incoming message into another message and sends
it to another predefined actor.</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//converter.png" alt="Converter actor"></p>
<p>The core of this actor is a classic function with one input and one output
parameter (type <code>&#39;a - &#39;b</code>):</p>
<pre><code class="language-fsharp">let square msg =
  msg * msg</code></pre>
<p>The actor function is similar to the one of Message Sink, but it also accepts
a reference to the output actor and knows how to send messages to it:</p>
<pre><code class="language-fsharp">let actorOfConvert f outputRef =
  actorOf2 (fun _ msg -&gt; outputRef &lt;! f msg)</code></pre>
<p>Here is how we spawn an instance of a Converter using our <code>print-actor</code> as the
output:</p>
<pre><code class="language-fsharp">let squareActorRef = 
  actorOfConvert square printActorRef 
  |&gt; spawn system &quot;square-actor&quot;

squareActorRef &lt;! 3
// &quot;Message received: 9&quot; is printed</code></pre>
<p>Both actor patterns had no notion of state so far. Let&#39;s see how we can 
treat the statefulness in a functional way.</p>
<hr>
<h2 id="stateful-sink">Stateful Sink</h2>
<p>Let&#39;s get back to our Message Sink actor with side-effects, and make it
dependent on its internal state. The state is affected by the incoming 
messages and is preserved until the next message comes in.</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//statefulsink.png" alt="Stateful Sink actor"></p>
<p>Does not look very functional, right? But this impression is wrong in fact.
We can represent the state before a message came in - as an extra input parameter, 
and  the state after the message got processed - as an output parameter. 
We start with an initial state and the output of the
first message becomes the input state of the second message:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//statefulsinkfunctional.png" alt="Stateful Sink functional actor"></p>
<p>Here is an example of a function which prints out the index of a message together
with the message contents:</p>
<pre><code class="language-fsharp">let printIndex index msg =
  printn &quot;Message [%i] received: %A&quot; index msg
  index + 1</code></pre>
<p>For the actor implementation we need a recursive function so we can&#39;t use 
<code>actorOf2</code> anymore. Actor workflow is a bit more lines but still very simple:</p>
<pre><code class="language-fsharp">let actorOfStatefulSink f initialState (mailbox : Actor&lt;&#39;a&gt;) =

  let rec imp lastState =
    actor {
      let! msg = mailbox.Receive()
      let newState = f msg lastState
      return! imp newState
    }

  imp initialState</code></pre>
<p>And here is a usage example:</p>
<pre><code class="language-fsharp">let printIndexActorRef = 
  actorOfSink printIndex 1
  |&gt; spawn system &quot;print-ix-actor&quot;

printActorRef &lt;! 3
// &quot;Message [1] received: 3&quot; is printed

printActorRef &lt;! 4
// &quot;Message [2] received: 4&quot; is printed</code></pre>
<hr>
<p><a name="StatefulConverter" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/undefined"></a></p>
<h2 id="stateful-converter">Stateful Converter</h2>
<p>By now, the core function of the Stateful Converter actor should be a no-brainer for you. The actor
would have two input parameters and two outputs (in a tuple). One of the outputs
is a message and goes to another actor, the other output becomes an input for the
next actor:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//statefulconverter.png" alt="Stateful Converter actor"></p>
<p>Here is a function which squares the messaged number, then calculates the running total
and sends it forward:</p>
<pre><code class="language-fsharp">let squareAndSum sum msg =
  let result = sum + msg*msg
  (result, result)</code></pre>
<p>In this particular case the output message and state are equal, but they don&#39;t
have to be. Here is the actor implementation:</p>
<pre><code class="language-fsharp">let actorOfStatefulConvert f initialState outputRef (mailbox : Actor&lt;&#39;a&gt;) =

  let rec imp lastState =
    actor {
      let! msg = mailbox.Receive()
      let (result, newState) = f msg lastState
      outputRef &lt;! result
      return! imp newState
    }

  imp initialState</code></pre>
<p>And a usage example:</p>
<pre><code class="language-fsharp">let squareAndSumActorRef = 
  actorOfConvert square 0 printIndexActorRef 
  |&gt; spawn system &quot;square-sum-actor&quot;

squareAndSumActorRef &lt;! 3
// &quot;Message [1] received: 9&quot; is printed

squareAndSumActorRef &lt;! 4
// &quot;Message [2] received: 25&quot; is printed</code></pre>
<hr>
<p><a name="ConverterSupervisor" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/undefined"></a></p>
<h2 id="converter-supervisor">Converter-Supervisor</h2>
<p>In the previous patterns the Converter actors were sending messages 
to predefined actor references which were not managed (or supervised in Akka terms)
by those actors. Now, let&#39;s say that the actor needs to create a child
to send converted messages to it afterwards: </p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//supervisedchild.png" alt="Supervised Child actor"></p>
<p>We can treat such child reference as the state and instantiate it when the first message
comes in. (We can&#39;t spawn it before the first message because the
<code>mailbox</code> object is required.) The message goes to the actor
reference that we store in the state, something like this:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//childasstate.png" alt="Supervised Child as State"></p>
<p>Here is the generic actor implementation:</p>
<pre><code class="language-fsharp">let actorOfConvertToChild f spawnChild (mailbox : Actor&lt;&#39;a&gt;) =

  let rec imp state =
    actor {
      let newstate =
        match state with
        | Some s -&gt; s
        | None -&gt; spawnChild mailbox

      let! msg = mailbox.Receive()
      newstate &lt;! f msg
      return! imp (Some newstate)
    }

  imp None</code></pre>
<p>The only difference is that we accept a <code>spawnChild</code> function instead of
pre-baked actor reference. Here is the first calculator example refactored
to Print actor being a child of Square actor.</p>
<pre><code class="language-fsharp">let squareWithChildRef = 
  actorOfConvertToChild print (spawnChild square &quot;print-actor&quot;)
  |&gt; spawn system &quot;square-with-child-actor&quot;</code></pre>
<p>Notice that the <code>square</code> and <code>print</code> functions have exactly the same signatures
and implementations as we used before, and the concern of actor hierarchy is 
completely separated from the business logic of the actors.</p>
<p>This hierarchy is handy whenever you need multiple instances of one actor type
(<code>f</code>-actor from the picture) and corresponding instances of another actor type
(<code>g</code>-actor):</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//multiparents.png" alt="Multiple Parents and Children actor"></p>
<hr>
<p><a name="RouterSupervisor" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/undefined"></a></p>
<h2 id="router-supervisor">Router-Supervisor</h2>
<p>Routers are the kind of actors which forward each incoming message to one
or more downstream actors. In this example the downstream actors are supervised
by the Router itself.
So, the Router-Supervisor can have multiple children and send the result of 
message processing to one or more of them:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//router.png" alt="Router actor"></p>
<p>To keep the spirit of functional actors, we represent the router logic with a function
of type <code>&#39;a -&gt; seq&lt;string * &#39;b&gt;</code>, where <code>&#39;a</code> is the type of incoming messages,
<code>&#39;b</code> is the type of outgoing messages, and <code>string</code> represents the identifier of the 
actor to get the message. Here is a sample implementation:</p>
<pre><code class="language-fsharp">let routeSensorData msg = 
  msg |&gt; Seq.map (fun x -&gt; (&quot;sensor-actor-&quot; + x.SensorId, x.Temperature))</code></pre>
<p>Based on the incoming metadata (sensor identifier) the actor forwards its
temperature to corresponding sensor-specific actor. </p>
<p>Here is the implementation of the generic actor function:</p>
<pre><code>let actorOfRouteToChildren f spawnChild (mailbox : Actor&lt;&#39;a&gt;) =

  let getActor id = 
    let actorRef = mailbox.Context.Child(id)
    if actorRef.IsNobody() then
      spawnChild id mailbox
    else 
      actorRef

  let rec imp () =
    actor {
      let! msg = mailbox.Receive()
      f msg |&gt; Seq.iter (fun (id, x) -&gt; (getActor id) &lt;! x) 
      return! imp ()
    }

  imp ()</code></pre><p>And a usage example:</p>
<pre><code class="language-fsharp">let sensorRouterRef = 
  actorOfRouteToChildren routeSensorData (spawnChild square)
  |&gt; spawn system &quot;route-sensor-actor&quot;</code></pre>
<p>Note that <code>spawnChild</code> does not accept the child ID anymore because it&#39;s being
controlled by the router itself.</p>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>With the patterns that we have so far we should be able to build quite powerful
hierarchies like the one shown below:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp//usecase.png" alt="Actor use case"></p>
<p>There might be many other scenarios and types of actors that would make sense
in your use case. I&#39;m just showing the basic patterns, but more importantly the way of 
reasoning about the code. Don&#39;t 
let the multitude of actor aspects push you into the world of poorly structured 
code.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/f#/'>F#</a>, <a href='/tags/akka-net/'>Akka.NET</a>, <a href='/tags/actor-model/'>Actor Model</a>, <a href='/tags/functional-programming/'>Functional Programming</a>, <a href='/tags/patterns/'>Patterns</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 11th, 2016</div>
    
    <h1><a href='/2016/03/aurelia-map-component-with-leaflet/'>Aurelia Map Component with Leaflet</a></h1>
    
    <div class="post-content">
        <p>This is a short tutorial on how to create a map control in <a href="http://aurelia.io">Aurelia.js</a> 
application. I am using the <a href="http://leafletjs.com">Leaflet</a> library with custom tile
source and I also show the way to implement your own overlay layer. Here is what
my map looks like:</p>
<p><img src="/2016/03/aurelia-map-component-with-leaflet//map.png" alt="Map"></p>
<p>So, I assume you already have an existing Aurelia application, and let&#39;s start.</p>
<h2 id="install-leaflet">Install Leaflet</h2>
<p>The following command will install Leaflet module to the application:</p>
<pre><code>jspm install leaflet</code></pre><p>If you are using TypeScript, don&#39;t forget to add type definitions</p>
<pre><code>tsd install leaflet</code></pre><h2 id="define-a-map-component">Define a Map Component</h2>
<p>Create a new <code>map.html</code> file and put the following contents there:</p>
<pre><code class="language-html">&lt;template&gt;
  &lt;require from=&quot;leaflet/dist/leaflet.css&quot;&gt;&lt;/require&gt;
  &lt;div id=&quot;mapid&quot; style=&quot;height: 100%&quot;&gt;&lt;/div&gt;
&lt;/template&gt;</code></pre>
<p>We import the CSS required by leaflet and define the <code>div</code> element to host
the map in. Then, create a new <code>map.js</code> file (or <code>map.ts</code> for typescript),
here is the minimum code:</p>
<pre><code class="language-js">export class Map {
}</code></pre>
<h2 id="load-the-map-with-tiles">Load the Map with Tiles</h2>
<p>First, import the leaflet module in your codebehind:</p>
<pre><code class="language-js">import * as L from &#39;leaflet&#39;;</code></pre>
<p>Now, define the <code>attached</code> function, which would be called by Aurelia when
control&#39;s HTML is loaded, and make a map there:</p>
<pre><code class="language-js">export class Map {
  attached() {
    let map = L.map(&#39;mapid&#39;).setView([51.505, -0.09], 13);

    let urlTemplate = &#39;http://{s}.tile.osm.org/{z}/{x}/{y}.png&#39;;
    map.addLayer(L.tileLayer(urlTemplate, { minZoom: 4 }));
  }
}</code></pre>
<p>The example above uses the URL template of Open Street Maps as per the Leaflet&#39;s
tutorial, but I needed to use our privately hosted maps, so I changed it to
something like:</p>
<pre><code class="language-js">let urlTemplate = &#39;http://www.mysite.com/tiles?layer=background&amp;level={z}&amp;x={x}&amp;y={y}&#39;;
map.addLayer(L.tileLayer(urlTemplate, { minZoom: 4, zoomOffset: 8 }));</code></pre>
<p>The <code>zoomOffset</code> parameter was required to fix impedance mismatch of zoom levels.</p>
<h2 id="custom-overlay-layer">Custom Overlay Layer</h2>
<p>For our custom maps we needed to show two layers on top of each other:</p>
<ul>
<li>The usual tile layer for the map background</li>
<li>The overlay layer for the map labels and additional information</li>
</ul>
<p>The overlay layer can&#39;t be broken down into tiles (not supported by our map provider),
so we need to show the whole layer as a single picture and then refresh it every
time user pans or zooms the map.</p>
<p>The overlay layer can be implemented with <code>onAdd</code> and <code>onRemove</code> functions
and then feeding an image element to the Leaflet as a layer. Here is the code:</p>
<pre><code class="language-js">import * as L from &#39;leaflet&#39;;

export class LabelOverlayLayer {
  map;
  image;

  onAdd(map) {
    this.map = map;

    this.image = L.DomUtil.create(&#39;img&#39;, &#39;leaflet-tile-loaded&#39;);
    map.getPanes().overlayPane.appendChild(this.image);

    map.on(&#39;moveend&#39;, this.render, this);
    this.render();
  }

  onRemove (map) {
    map.getPanes().overlayPane.removeChild(this.image);
    map.off(&#39;moveend&#39;, this.render, this);
  }

  render() {
    let bounds = this.map.getBounds(), mapSize = this.map.getSize();
    let se = bounds.getSouthEast(), nw = bounds.getNorthWest();

    let tileUrl = `http://www.mysite.com/tiles?layer=labels&amp;lonmin=${nw.lng}&amp;latmin=${se.lat}&amp;lonmax=${se.lng}&amp;latmax=${nw.lat}&amp;width=${Math.floor(mapSize.x)}&amp;height=${Math.floor(mapSize.y)}`;
    this.image.src = tileUrl;

    let pos = this.map.latLngToLayerPoint(nw);
    L.DomUtil.setPosition(this.image, pos, false);
  }
};</code></pre>
<p>The usage of this layer in the map component is trivial:</p>
<pre><code class="language-js">this.map.addLayer(new LabelOverlayLayer());</code></pre>
<h2 id="use-the-map-component">Use the Map Component</h2>
<p>The map component is ready to be used in the application:</p>
<pre><code class="language-html">&lt;require from=&quot;./components/map&quot;&gt;&lt;/require&gt;
&lt;div  style=&quot;height: 700px&quot;&gt;
  &lt;map&gt;&lt;/map&gt;
&lt;/div&gt;</code></pre>
<p>The container around the map should have a non-zero height, so I made it fixed
in the example above.</p>
<p>Don&#39;t forget to bundle the leaflet assets by including the following lines
into your <code>bundles.json</code>:</p>
<pre><code class="language-json">&quot;includes&quot;: [
  &quot;aurelia-framework&quot;,
  // ...
  &quot;leaflet&quot;,
  &quot;leaflet/dist/leaflet.css!text&quot;
],</code></pre>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/aurelia/'>Aurelia</a>, <a href='/tags/leaflet/'>Leaflet</a>, <a href='/tags/typescript/'>Typescript</a>, <a href='/tags/javascript/'>Javascript</a>, <a href='/tags/maps/'>Maps</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 1st, 2016</div>
    
    <h1><a href='/2016/03/building-a-poker-bot-mouse-movements/'>Building a Poker Bot: Mouse Movements</a></h1>
    
    <div class="post-content">
        <p><em>This is the third part of <strong>Building a Poker Bot</strong> series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here are the previous parts:</em></p>
<ul>
<li><a href="https://mikhail.io/2016/02/building-a-poker-bot-card-recognition/"><em>Building a Poker Bot: Card Recognition</em></a></li>
<li><a href="https://mikhail.io/2016/02/building-a-poker-bot-string-recognition/"><em>Building a Poker Bot: String and Number Recognition</em></a></li>
</ul>
<p>In this short post I write about the last step of the poker bot flow: clicking
the buttons. So, the screen is already recognized, the hand is understood,
the decisions are made and now the bot needs to execute the actions. Except for
the bet sizing, this simply means clicking the right button at the poker table.</p>
<p>The stealthiness of such clicks is a valid concern here. Ideally, we want all
the mouse movements to look as similar as possible to the movements produced
by a human being. For this post, I will simplify the task to the following steps:</p>
<ul>
<li>Identify where the mouse cursor is right now</li>
<li>Decide where the mouse should be moved to</li>
<li>Gradually move the mouse cursor</li>
<li>Click the button</li>
</ul>
<h2 id="cursor-position">Cursor Position</h2>
<p>It&#39;s really easy to understand where the mouse cursor currently is: just
use <code>Control.MousePosition</code> property from the standard library:</p>
<pre><code class="language-fsharp">let currentPosition () = 
  let mp = System.Windows.Forms.Control.MousePosition
  (mp.X, mp.Y)</code></pre>
<p>Note that your application doesn&#39;t have to be based on WinForms, just reference
the required assembly.</p>
<h2 id="move-the-cursor">Move the Cursor</h2>
<p>I use the third party <a href="https://inputsimulator.codeplex.com/">WindowsInput</a> 
library to control the mouse and the keyboard programmatically. It uses some
weird coordinate system, so the function to move the mouse cursor looks like this:</p>
<pre><code class="language-fsharp">let simulator = new InputSimulator()

let moveTo x y =
  let toX = 65535. * x / (Screen.PrimaryScreen.Bounds.Width |&gt; float)
  let toY = 65535. * y / (Screen.PrimaryScreen.Bounds.Height |&gt; float)
  simulator.Mouse.MoveMouseTo(toX, toY)</code></pre>
<p>The input parameters <code>x</code> and <code>y</code> are the pixel location starting at 
the top-left corner of the screen.</p>
<h2 id="move-it-smoothly">Move It Smoothly</h2>
<p>Now we want to simulate the human-like movements. It won&#39;t be perfect, but
at least it should look decent. For this gradual movement function I used
a nice F# feature called asynchronous workflows. Effectively, it looks like
a loop with async sleep statements inside.</p>
<pre><code class="language-fsharp">let moveToWorkflow step (toX, toY) = async {
  let (fromX, fromY) = currentPosition()
  let count = Math.Max(10, (Math.Abs (toX - fromX) + Math.Abs (toY - fromY)) / 20)
  for i = 0 to count do
    let x = step fromX toX count i |&gt; float
    let y = step fromY toY count i |&gt; float
    moveTo x y
    do! Async.Sleep 3
  }</code></pre>
<p>The key parameter here is the <code>step</code> function of obscure type <code>int -&gt; int -&gt; int -&gt; int -&gt; int</code>.
Basically, it calculates a coordinate for n-th step of the movement. We can
plug different implementations of this function to find the right balance of
the movement style. Here is the simplest linear implementation:</p>
<pre><code class="language-fsharp">let linearStep from until max i =
  from + (until - from) * i / max</code></pre>
<p>The sinus-based implementation is a bit more verbose because of float-int 
conversions:</p>
<pre><code class="language-fsharp">let sinStep (from:int) (until:int) (max:int) (index:int) =
  let fromf = from |&gt; float
  let untilf = until |&gt; float
  let maxf = max |&gt; float
  let indexf = index |&gt; float
  fromf + (untilf - fromf) * Math.Sin(Math.PI / 2. * indexf / maxf) |&gt; int</code></pre>
<p>The following animation illustrates the concept: </p>
<svg width="778" height="190" viewbox="0 0 500 190">
  <image id="mouse1" x="0" y="20" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>
  <image id="mouse2" x="0" y="90" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>
  <image id="mouse3" x="0" y="160" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>

  <animate xlink:href="#mouse1" attributename="x" from="0" to="0" values="0;450;0" keytimes="0;0.5;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" calcmode="discrete" id="img-anim1"></animate>
  <animate xlink:href="#mouse2" attributename="x" from="0" to="0" values="0;450;0" keytimes="0;0.5;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" id="img-anim2"></animate>
  <animate xlink:href="#mouse3" attributename="x" from="0" to="0" values="0;70;139;204;264;318;364;401;428;444;450;380;311;246;186;132;86;49;22;6;0" keytimes="0;0.05;0.1;0.15;0.2;0.25;0.3;0.35;0.4;0.45;0.5;0.55;0.6;0.65;0.7;0.75;0.8;0.85;0.9;0.95;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" id="img-anim3"></animate>  
</svg>

<p>The top mouse cursor just
jumps from left to right and back (no animation). The middle cursor moves with
linear speed (<code>linearStep</code> function above). The bottom cursor moves based on
the <code>sinStep</code> function derived from sinus of time.</p>
<h2 id="click-the-button">Click the Button</h2>
<p>A button is a rectangle and we want to click a random point inside it. So, all
we need is to pick random coordinates, move the mouse there and send a 
click event via the simulator:</p>
<pre><code class="language-fsharp">let clickButton (minX, minY, maxX, maxY) =
  let r = new Random()
  let p = (r.Next(minX, maxX), r.Next(minY, maxY))
  moveToWorkflow sinStep p |&gt; Async.RunSynchronously
  simulator.Mouse.LeftButtonClick()</code></pre>
<h2 id="demo-time">Demo Time</h2>
<p>Here is the demo of the mouse movements:</p>
<p><img src="/2016/03/building-a-poker-bot-mouse-movements//mouseclicking.gif" alt="Mouse clicking the button"></p>
<p>It looks fun, doesn&#39;t it? The full code for the mouse movements can be found in 
<a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/Clicker.fs">my github repo</a>.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>Poker Bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/human-like-behavior/'>Human-like Behavior</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 23rd, 2016</div>
    
    <h1><a href='/2016/02/unit-testing-dapper-repositories/'>Unit testing Dapper repositories</a></h1>
    
    <div class="post-content">
        <p><a href="https://github.com/StackExchange/dapper-dot-net">Dapper</a> is a micro-ORM library which is 
very simple and super fast. In our projects we use Dapper for the tasks where something like
EntityFramework or NHibernate would be an overkill.</p>
<p>Quite often the data access code is difficult to be unit tested. Objects like
database connections, commands, transactions and contexts are hard to mock, and
thus the data access code is not easily isolated. Dapper relies heavily on SQL
statements inside C# code, which gives an extra complication. Some people would
argue that unit tests are not warranted for data access layer, and integration
tests should be used instead. Let&#39;s have a look at another possibility.</p>
<h2 id="an-example-of-a-repository">An Example of a Repository</h2>
<p>Let&#39;s say we have a simple class and we want to populate instances of this class
from the database:</p>
<pre><code class="language-csharp">public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
}</code></pre>
<p>To be able to use Dapper for data access, we need an instance of <code>IDbConnection</code>.
As we want to be able to mock the connection for unit tests, we need to create
a factory interface to abstract it away:</p>
<pre><code class="language-csharp">public interface IDatabaseConnectionFactory
{
    IDbConnection GetConnection();
}</code></pre>
<p>Now the repository would get a connection from this factory and execute 
Dapper queries on it:</p>
<pre><code class="language-csharp">public class ProductRepository
{
    private readonly IDatabaseConnectionFactory connectionFactory;

    public ProductRepository(IDatabaseConnectionFactory connectionFactory)
    {
        this.connectionFactory = connectionFactory;
    }

    public Task&lt;IEnumerable&lt;Product&gt;&gt; GetAll()
    {
        return this.connectionFactory.GetConnection().QueryAsync&lt;Product&gt;(
            &quot;select * from Product&quot;);
    }
}</code></pre>
<h2 id="testing-without-a-real-database">Testing Without a real Database</h2>
<p>Here is my approach to testing the repository:</p>
<ol>
<li>Use an in-memory <a href="https://www.sqlite.org/">SQLite3</a> database.</li>
<li>Create a table there and put some data in.</li>
<li>Run the repository against this database.</li>
<li>Compare the result to the expected values.</li>
</ol>
<p>Here is a helper class which uses another micro-ORM library <a href="http://ormlite.com/">OrmLite</a> to talk
to SQLite database:</p>
<pre><code class="language-csharp">public class InMemoryDatabase
{
    private readonly OrmLiteConnectionFactory dbFactory = 
        new OrmLiteConnectionFactory(&quot;:memory:&quot;, SqliteOrmLiteDialectProvider.Instance);

    public IDbConnection OpenConnection() =&gt; this.dbFactory.OpenDbConnection();

    public void Insert&lt;T&gt;(IEnumerable&lt;T&gt; items)
    {
        using (var db = this.OpenConnection())
        {
            db.CreateTableIfNotExists&lt;T&gt;();
            foreach (var item in items)
            {
                db.Insert(item);
            }
        }
    }
}</code></pre>
<p>And here is the test for our <code>ProductRepository</code> class:</p>
<pre><code class="language-csharp">[Test]
public async Task QueryTest()
{
    // Arrange
    var products = new List&lt;Product&gt;
    {
        new Product { ... },
        new Product { ... }
    };
    var db = new InMemoryDatabase();
    db.Insert(products);
    connectionFactoryMock.Setup(c =&gt; c.GetConnection()).Returns(db.OpenConnection());

    // Act
    var result = await new ProductRepository(connectionFactoryMock.Object).GetAll();

    // Assert
    result.ShouldBeEquivalentTo(products);
}</code></pre>
<h2 id="is-it-a-unit-test-">Is It a Unit Test?</h2>
<p>Well, not completely. This approach does not mock the database, but instead puts
an in-memory database in place of the normal one. The problem is that we don&#39;t 
control all the details how it works, so it might not be as flexible as we need.
For instance, SQLite type system is quite simplistic, so while <code>INT</code> and <code>BIGINT</code>
are different column types in SQL Server, they are the same <code>INTEGER</code> type in
SQLite. This can lead to false positive or false negative tests in edge cases.</p>
<p>Nevertheless, the concept is simple and requires very little amount of code,
so it&#39;s useful to have it in the toolbox anyway. The resulting tests are fast,
have no external dependencies and are always consistent between multiple runs.
That makes them better than real integration tests for the simple scenarios 
during TDD development.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/unit-testing/'>Unit Testing</a>, <a href='/tags/dapper/'>Dapper</a>, <a href='/tags/orm/'>ORM</a>, <a href='/tags/tdd/'>TDD</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 10th, 2016</div>
    
    <h1><a href='/2016/02/building-a-poker-bot-string-recognition/'>Building a Poker Bot: String and Number Recognition</a></h1>
    
    <div class="post-content">
        <p><em>This is the second part of *</em>Building a Poker Bot** series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here is the first part:
<a href="https://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">Building a Poker Bot: Card Recognition</a>
*</p>
<h2 id="why-string-recognition">Why string recognition</h2>
<p>Reading cards and other fixed images was the first step. The bot should also
be able to read different text-based information from the screen, e.g.</p>
<ul>
<li>Current blind levels</li>
<li>Current pot size</li>
<li>The size of bets made by each player</li>
<li>Player names</li>
<li>Stack sizes</li>
<li>Chat messages (for advanced scenarios)</li>
</ul>
<p>We need this vital information to make proper decisions, so let&#39;s look at
how to parse the textual data.</p>
<h2 id="new-challenges">New challenges</h2>
<p>String recognition has some specific difficulties when compared to fixed
images like cards:</p>
<ul>
<li>The size of a string is not predefined. Obviously, the longer the string, the
more space it takes on the screen</li>
<li>The position of a string is not fixed either. Some strings are aligned to
the center, others may diverge based on other variable parts like stakes or blinds</li>
<li>Different strings might be rendered in different font size</li>
</ul>
<p>Here is what needs to be done to overcome these complications:</p>
<ul>
<li>Pick the layout which makes your life easier </li>
<li>Adjust fonts and positions if possible </li>
<li>Make sure that all important strings are always visible and not overlapping to other information</li>
<li>For each string define a region where it belongs to in 100% cases. The background
of this region should be more or less evenly filled with a color in contrast to the font color.</li>
</ul>
<h2 id="string-recognition-steps">String recognition steps</h2>
<p>We start with a screenshot of a poker table again:</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition//table.png" alt="Poker table screenshot"></p>
<p>We know our fixed regions where our labels are located, so we take those
regions for processing:</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition//regions.png" alt="Regions of string recognition"></p>
<p>For each region we trim away the blank margins around the text (i.e. left,
top, right and bottom padding):</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition//nomargin.png" alt="Margins being removed"></p>
<p>We find dark lines between bright symbols and we consider them as gaps
between characters:</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition//splitchars.png" alt="Split to characters"></p>
<p>The final step is to compare each symbol to the known patterns and find the best
match (in case of my layout the match for symbols is always 100% perfect). Let&#39;s 
look how these steps are implemented.</p>
<h2 id="removing-padding-around-the-text">Removing padding around the text</h2>
<p>Because the padding is removed from all 4 sides of the region, I decided to use
<code>Array2D</code> data type to be able to iterate in different order. The whole algorithm operates
with black or white points defined as a helper type:</p>
<pre><code class="language-fsharp">type BW = B | W</code></pre>
<p>So the <code>removePadding</code> function has type of <code>BW[,] -&gt; BW[,]</code> and looks
like this:</p>
<pre><code class="language-fsharp">let removePadding pixels =
  let allBlack s = Seq.exists ((=) W) s
  let maxWidth = Array2D.length1 pixels - 1
  let maxHeight = Array2D.length2 pixels - 1
  let firstX = [0..maxWidth] 
    |&gt; Seq.tryFindIndex (fun y -&gt; allBlack pixels.[y, 0..maxHeight])
  let lastX = [0..maxWidth] 
    |&gt; Seq.tryFindIndexBack (fun y -&gt; allBlack pixels.[y, 0..maxHeight])
  let firstY = [0..maxHeight] 
    |&gt; Seq.tryFindIndex (fun x -&gt; allBlack pixels.[0..maxWidth, x])
  let lastY = [0..maxHeight] 
    |&gt; Seq.tryFindIndexBack (fun x -&gt; allBlack pixels.[0..maxWidth, x])

  match (firstX, lastX, firstY, lastY) with
  | (Some fx, Some lx, Some fy, Some ly) -&gt; pixels.[fx..lx, fy..ly]
  | _ -&gt; Array2D.init 0 0 (fun _ _ -&gt; B)</code></pre>
<p>The first part finds the amount of fully-black columns and rows in the array.
Then, if white points are found, the second part returns a sub array based on
the indices, otherwise empty array is returned.</p>
<h2 id="split-the-text-into-characters">Split the text into characters</h2>
<p>First, we convert our 2D array into the list of lists, where each item in the
top-level list represents a single column of pixels:</p>
<pre><code class="language-fsharp">let pixelColumns =
  [0..Array2D.length1 pixels - 1] 
  |&gt; Seq.map (fun x -&gt; pixels.[x, 0..Array2D.length2 pixels - 1] |&gt; List.ofArray)</code></pre>
<p>Then we can fold this list of columns into the symbols, where each symbol itself
is the list of columns:</p>
<pre><code class="language-fsharp">let splitIntoSymbols (e : BW list) (state: BW list list list) = 
  match state with
  | cur::rest -&gt;
      if isSeparator e then
        match cur with
        | _::_ -&gt; []::state // add new list
        | _ -&gt; state        // skip if we already have empty item
      else (e::cur)::rest   // add e to current list
  | _ -&gt; [[e]]

Seq.foldBack splitIntoSymbols pixelColumns []</code></pre>
<p>The type of <code>state</code> is a bit of brain teaser, I guess it could be improved
by introducing some intermediate type with descriptive name, but I decided
to leave that part for now. Read it as list of symbols, which are lists of
columns, which are lists of pixels.</p>
<h2 id="match-the-symbols-vs-the-known-patterns">Match the symbols vs the known patterns</h2>
<p>This part was already described in <a href="https://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">my first article</a>.
Basically we compare the list of black or white points to the patterns of
the known symbols:</p>
<pre><code class="language-fsharp">let getChar patterns bws =
  let samePatterns h p =
    Seq.zip h p
    |&gt; Seq.forall (fun (v1, v2) -&gt; v1 = v2)
  let matchingPattern = 
    patterns 
      |&gt; Array.filter (fun p -&gt; List.length p.Pattern = List.length bws)
      |&gt; Array.filter (fun p -&gt; samePatterns bws p.Pattern)
      |&gt; Array.tryHead
  defaultArg (Option.map (fun p -&gt; p.Char) matchingPattern) &#39;?&#39;</code></pre>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>The <code>recognizeString</code> function accepts lower-order functions to match 
symbols and get pixels together with width and height of the region:</p>
<pre><code class="language-fsharp">recognizeString: (BW list list -&gt; char) -&gt; (int -&gt; int -&gt; color) -&gt; int -&gt; int -&gt; string</code></pre>
<p>It builds an array of pixels, removes padding and folds with recognition.</p>
<pre><code class="language-fsharp">let recognizeString matchSymbol getPixel width height =

  let pixels = 
    Array2D.init width height (fun x y -&gt; isWhite (getPixel x y))
    |&gt; removePadding

  let pixelColumns =
    [0..Array2D.length1 pixels - 1] 
    |&gt; Seq.map (fun x -&gt; pixels.[x, 0..Array2D.length2 pixels - 1] |&gt; List.ofArray)      

  Seq.foldBack splitIntoSymbols pixelColumns []
  |&gt; List.map matchSymbol
  |&gt; Array.ofSeq
  |&gt; String.Concat</code></pre>
<p>Then we use it with a specific recognition patterns, e.g. known digits in case
of numbers recognition:</p>
<pre><code class="language-fsharp">let recognizeNumber x =
  recognizeString (getChar numberPatterns) x</code></pre>
<p>A way to produce these patterns is discussed in <a href="https://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">the previous part</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>String recognition takes a bit more steps to execute comparing to the recognition
of fixed objects. Nevertheless it&#39;s pretty straightforward to implement once
we split it into small and well-understood conversion steps. The full code 
for card recognition can be found in <a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/StringRecognition.fs">my github repo</a>.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>Poker Bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/image-recognition/'>Image Recognition</a>, <a href='/tags/ocr/'>OCR</a>
    </div>
    
</article>


<div class="page-nav">
    
    <a class="page-nav-newer" href="/9/index.html">&lt;&lt; Previous page</a>
    
    
    <a class="page-nav-older" href="/11/index.html">Next page &gt;&gt;</span></a>
    
</div>

<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy F#, C#, Javascript and SQL development, reasoning about distributed systems, data processing pipelines, cloud and web apps. I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="https://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="https://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>
</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2018 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/prism.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>