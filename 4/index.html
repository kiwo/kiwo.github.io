<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.4" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">F#, C#, JS, SQL, Azure programmer</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                <li><a href="/">Blog</a></li>
                <li><a href="/about">About</a></li>
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="http://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Apr 9th, 2016</div>
    
    <h1><a href='/2016/04/building-a-poker-bot-with-akka-net-actors'>Building a Poker Bot with Akka.NET Actors</a></h1>
    
    <div class="post-content">
        <p><em>This is the fourth part of <strong>Building a Poker Bot</strong> series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here are the previous parts:</em></p>
<ul>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/"><em>Building a Poker Bot: Card Recognition</em></a></li>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/"><em>Building a Poker Bot: String and Number Recognition</em></a></li>
<li><a href="http://mikhail.io/2016/03/building-a-poker-bot-mouse-movements/"><em>Building a Poker Bot: Mouse Movements</em></a></li>
</ul>
<p>This post lays out the most exciting part of the bot. I&#39;ll compose the recognition, flow, decision and mouse clicking
parts together into the bot application. The application is a console executable interacting with multiple 
windows of poker room software.</p>
<h2 id="flow">Flow</h2>
<p>The following picture shows the outline of the application data flow:</p>
<p><img src="/2016/04/building-a-poker-bot-with-akka-net-actors/pokeractors.png" alt="Actor Diagram"></p>
<p><strong>Find Tables</strong> - Every half a second or so we scan all the windows and search for open poker tables among them.
For each poker table we make a screenshot and send those to recognition.</p>
<p><strong>Recognize Screen</strong> - Parse the data from the screenshot. Check whether it&#39;s our turn to make a play now, what
the <a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">hole cards</a> and 
<a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/">stacks</a> are, produce the detailed
screen information and send it to decision maker.</p>
<p><strong>Make Decision</strong> - Understand if that&#39;s a new hand or there was a past history before. See
what the villains did and which new cards we got. Here the secret sauce comes to play and produces 
a move to be made. Send the action to the mouse clicker.</p>
<p><strong>Click Buttons</strong> - Based on the decision made, click the right buttons. It should be done with proper delays
and <a href="http://mikhail.io/2016/03/building-a-poker-bot-mouse-movements/">human-like movements</a> so that the villain
and poker room don&#39;t understand that it&#39;s bot who is playing.</p>
<hr>
<h2 id="let-the-actors-play">Let the Actors Play</h2>
<p>Because of the multi-tabling, the application is intrinsically multi-threaded. At the same time,
the different parts of the flow are executed at different cadence:</p>
<ul>
<li>Finding tables is triggered by time and is single-threaded</li>
<li>Screen recognition, history detection and decision making run in sequence and can be executed in parallel
for multiple tables</li>
<li>Clicking the buttons is again single-threaded, as it must synchronize the outputs from the previous steps,
put them in sequence with appropriate delays</li>
</ul>
<p>Here are the other treats of the flow:</p>
<ul>
<li>It is reactive and event based</li>
<li>The flow is unidirectional, the output of one step goes to the input of the next step</li>
<li>Most steps are stateless, but the history state needs to be preserved and, ideally, isolated from the other
steps</li>
</ul>
<p>This list of features made me pick the Actor-based <a href="http://getakka.net">Akka.NET</a> framework to implement the flow.</p>
<p>For sure, the application could be done with a bunch of procedural code instead. 
But I found actors to be a useful modeling technique to be employed. 
It goes well with reactive nature of the application and builds the nice 
foundation for more complicated scenarios in the future.</p>
<p>Also, I was curious how F# and Akka.NET would work together.</p>
<h2 id="supervision-hierachy">Supervision Hierachy</h2>
<p>In Akka.NET each actor has a supervisor actor who is managing its lifecycle. All actors together form a
supervision tree. Here is the tree shown for the Player application:</p>
<p><img src="/2016/04/building-a-poker-bot-with-akka-net-actors/actorhierachy.png" alt="Actor Hierachy"></p>
<p>There is just one copy of both Table Finder and Button Clicker actors and they are supervised by the root
User actor. </p>
<p>For each poker table a Recognizer actor gets created. These actors are managed by Table 
Finder. </p>
<p>Each Recognizer actor creates an instance of Decision actor who keeps the hand history
and makes decisions. </p>
<p>Finally, all decisions are sent to one centralized Button Clicker actor whose job is 
to click all the tables with proper delays and in order.</p>
<hr>
<h2 id="implementation-patterns">Implementation Patterns</h2>
<p>All actors are implemented with <a href="http://mikhail.io/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/">Functional Actor Patterns</a>
which are described in <a href="http://mikhail.io/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/">my previous post</a>.</p>
<p>The basic idea is that each actor is defined in functional style with these
building blocks:</p>
<ul>
<li>Type of incoming and, if needed, outgoing messages</li>
<li>A domain function with business logic</li>
<li>Actor function which puts those parts together</li>
<li>Expression to spawn an actor based on actor function</li>
</ul>
<p>Let&#39;s look at the examples to understand this structure better.</p>
<h2 id="table-finder">Table Finder</h2>
<p>Table Finder does not have any meaningful input message. It gets a message from
Akka.NET scheduling system just to be periodically activated.</p>
<p>The domain function is called <code>findWindows</code> and has the type <code>unit -&gt; WindowInfo seq</code>.
It returns the poker window screenshots and titles.</p>
<p>Actor function of type <code>int -&gt; seq&lt;string * WindowInfo&gt;</code> is used by the 
<a href="http://mikhail.test/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/#RouterSupervisor">Router-Supervisor</a> pattern to 
define the behavior. The ouput tuple defines an ID of an output actor and a
message to send to it:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> findActor msg = 
  findWindows ()
  |&gt; Seq.map (<span class="hljs-keyword">fun</span> x -&gt; (<span class="hljs-string">"recognizer-actor-"</span> + x.TableName, x))
</code></pre>
<p>Here is how I spawn the singleton instance of this actor:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> tableFinderRef = 
  actorOfRouteToChildren findActor (spawnChild recognizer)
  |&gt; spawn system <span class="hljs-string">"table-finder-actor"</span>
</code></pre>
<p>Where <code>spawnChild</code> is a helper function - essentially an adapter of standard
<code>spawn</code> function with proper parameter order:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> spawnChild childActor name (mailbox : Actor&lt;<span class="hljs-attribute">'a</span>&gt;) = 
  spawn mailbox.Context name childActor
</code></pre>
<p>We can also extend it to debug messages when new actors get created.</p>
<h2 id="recognizer">Recognizer</h2>
<p>Recognizer receives the <code>WindowInfo</code> produced by the Table Finder.</p>
<p>The domain function has the type of <code>Bitmap -&gt; Screen</code>. You can read more about table
recognition in <a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">Part 1</a> and
<a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/">Part 2</a>
of these series.</p>
<p>Actor function is an implementation of 
<a href="http://mikhail.test/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/#ConverterSupervisor">Converter-Supervisor</a> pattern. 
The output is a decision message for Decision Maker actor which is a supervised 
child of the Recognizer. Here is the actor function:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> recognizeActor (window : WindowInfo) =
  <span class="hljs-keyword">let</span> result = recognize window.Bitmap
  { WindowTitle = window.Title 
    TableName = window.TableName 
    Screen = result 
    Bitmap = window.Bitmap }
</code></pre>
<p>And here is the spawn function:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> recognizer = actorOfConvertToChild recognizeActor (spawnChild decider <span class="hljs-string">"decider"</span>)
</code></pre>
<p>Notice how this expression was used in Table Finder instantiation above.</p>
<h2 id="decision-maker">Decision Maker</h2>
<p>Decision Maker actor function is an implementation of 
<a href="http://mikhail.test/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/#StatefulConverter">Stateful Converter</a> pattern. It receives
a decision message from a Recognizer. The output is a click message for a 
singleton Clicker actor. It also needs to preserve some state between two calls.
In the minimalistic implementation this state holds the previous screen that
it received, so that if the same message is received twice, the later message is 
ignored.</p>
<p>This way the actor function has the type of 
<code>DecisionMessage -&gt; Screen option -&gt; ClickerMessage * Screen option</code> 
and looks like this:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> decisionActor msg lastScreen =
  <span class="hljs-keyword">let</span> screen = msg.Screen
  <span class="hljs-keyword">match</span> lastScreen <span class="hljs-keyword">with</span>
  | Some s <span class="hljs-keyword">when</span> s = screen -&gt; (None, lastScreen)
  | _ -&gt;
    <span class="hljs-keyword">let</span> action = decide screen
    <span class="hljs-keyword">let</span> outMsg = { WindowTitle = msg.WindowTitle; Clicks = action }
    (Some outMsg, Some screen)
</code></pre>
<p>Here is the spawn function:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> decider = actorOfStatefulConvert decisionActor None clickerRef
</code></pre>
<p>where <code>None</code> represents the initial state.</p>
<h2 id="button-clicker">Button Clicker</h2>
<p>Clicker actor has the simplest implementation because it does not send messages to other actors.
Here is the message that it receives from Decision Maker:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ClickTarget</span> </span>= (int * int * int * int)
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ClickerMessage</span> </span>= {
  WindowTitle: string
  Clicks: ClickTarget[]
}
</code></pre>
<p>The domain function has the simple type <code>ClickerMessage -&gt; unit</code> with mouse
clicks as side effect. You can read more about the mouse movements in 
<a href="http://mikhail.io/2016/03/building-a-poker-bot-mouse-movements/">Part 3</a>
of these series.</p>
<p><a href="http://mikhail.test/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/#MessageSink">Message Sink</a>
pattern is used for this actor, so actor function isn&#39;t
really needed. We spawn the singleton instance with the following statement:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> clickerRef = actorOfSink click |&gt; spawn system <span class="hljs-string">"clicker-actor"</span>
</code></pre>
<p>Actor goes under supervision by actor system with <code>click</code> as message handler.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The top layer of poker player application is composed of small single-purpose
actors which talk to each other by sending messages. </p>
<p>Thanks to succinct F# language and functional actor patterns this layer is
very thin, and thus easy to understand and maintain. </p>
<p>The business logic is isolated and by itself has no dependency on Akka.NET.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>poker bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/akka-net/'>akka.net</a>, <a href='/tags/actor-model/'>actor model</a>, <a href='/tags/functional-programming/'>functional programming</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 21st, 2016</div>
    
    <h1><a href='/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp'>Functional Actor Patterns with Akka.NET and F#</a></h1>
    
    <div class="post-content">
        <p>My exploration of Actor model started with <a href="http://getakka.net">Akka.NET</a> framework - a .NET port of
JVM-based <a href="http://akka.io">Akka</a>. Actor programming model made a lot of sense to me, but once
I started playing with it, some questions arose. Most of those questions were related to the
following <a href="http://doc.akka.io/docs/akka/2.4.2/general/actors.html">definition</a>:</p>
<blockquote>
<p>An actor is a container for <code>State</code>, <code>Behavior</code>, a <code>Mailbox</code>, <code>Children</code> and a <code>Supervisor Strategy</code>.</p>
</blockquote>
<p>So, based on the <a href="https://github.com/petabridge/akka-bootcamp">Akka.NET Bootcamp</a> course I understood that
an Actor</p>
<ul>
<li>knows what kind of messages it can accept</li>
<li>does some processing of each message</li>
<li>holds some state which is changed during message processing</li>
<li>potentially changes its behavior based on the current state</li>
<li>creates and stores references to child actors</li>
<li>obtains references to other actors</li>
<li>sends messages to children and other actors</li>
</ul>
<p>While it&#39;s nice that the framework enables us to develop for different aspects of actor 
behavior, it might also be dangerous in case you do all the things in one place. Ball of spaghetti mud
was where I ended up during my first attempt. My actors were doing all the things from 
the above list and the code got messy very quick. So, the following questions popped up
in my head:</p>
<p><em>How do I avoid mixing several concerns in one piece of code?</em></p>
<p><em>How do I make the code easily testable?</em></p>
<p><em>How do I minimize the usage of mutable state?</em></p>
<p><em>How do I avoid boilerplate code when it&#39;s not needed?</em></p>
<h2 id="functional-actors">Functional Actors</h2>
<p>I am now developing the actor-based application in F#, the functional first
language. Functions are easy to reason about, reusable and testable. But the
actors are usually defined in terms of objects and classes. F# supports classes
but that&#39;s not the path that I&#39;m willing to go.</p>
<p>How do we make actors out of functions? Well, most of the time actors don&#39;t 
need all the features of the framework. In this case we can define the required actor
behavior in terms of a minimal function and then use creational patterns to
spawn actor instances out of it.</p>
<p>Let&#39;s look at some common patterns that I identified. For each pattern, I will
define </p>
<ul>
<li>an example of a core function which implements the business logic</li>
<li>a generic function to create actors with behavior of a core function</li>
<li>an example of actor instantiation using the two functions above</li>
</ul>
<hr>
<p><a name="MessageSink" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharpundefined"></a></p>
<h2 id="message-sink">Message Sink</h2>
<p>Stateless Message Sink is the simplest type of actor.</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/messagesink.png" alt="Message Sink actor"></p>
<p>It receives a message and executes some action on it. The action is not related
to any other actors, and there is no state, so the processing of each message
is always the same. Obviously, it&#39;s related to some kind of side effects:
logging the message, saving the data to the external storage and so on.</p>
<p>So, we don&#39;t need the majority of actor features in this case. The whole actor
processing could be represented by a function of type <code>&#39;a -&gt; unit</code>. Here 
is an example of a core function:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> print msg =
  printn <span class="hljs-string">"Message received: %A"</span> msg
</code></pre>
<p>So how do we make an actor out of this function? Well, it&#39;s already implemented
as <code>actorOf</code> helper function in Akka.NET F# extensions:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> actorOfSink (f : <span class="hljs-attribute">'a</span> -&gt; unit) = actorOf f
</code></pre>
<p>And here is how we spawn an actor instance:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> printActorRef = 
  actorOfSink print 
  |&gt; spawn system <span class="hljs-string">"print-actor"</span>

printActorRef &lt;! <span class="hljs-number">3</span>
<span class="hljs-comment">// "Message received: 3" is printed</span>
</code></pre>
<p>That&#39;s the simplicity that I&#39;m searching for. Let&#39;s look at a slightly more
complex example.</p>
<hr>
<p><a name="Converter" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharpundefined"></a></p>
<h2 id="converter">Converter</h2>
<p>Stateless Converter maps the incoming message into another message and sends
it to another predefined actor.</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/converter.png" alt="Converter actor"></p>
<p>The core of this actor is a classic function with one input and one output
parameter (type <code>&#39;a - &#39;b</code>):</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> square msg =
  msg * msg
</code></pre>
<p>The actor function is similar to the one of Message Sink, but it also accepts
a reference to the output actor and knows how to send messages to it:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> actorOfConvert f outputRef =
  actorOf2 (<span class="hljs-keyword">fun</span> _ msg -&gt; outputRef &lt;! f msg)
</code></pre>
<p>Here is how we spawn an instance of a Converter using our <code>print-actor</code> as the
output:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> squareActorRef = 
  actorOfConvert square printActorRef 
  |&gt; spawn system <span class="hljs-string">"square-actor"</span>

squareActorRef &lt;! <span class="hljs-number">3</span>
<span class="hljs-comment">// "Message received: 9" is printed</span>
</code></pre>
<p>Both actor patterns had no notion of state so far. Let&#39;s see how we can 
treat the statefulness in a functional way.</p>
<hr>
<h2 id="stateful-sink">Stateful Sink</h2>
<p>Let&#39;s get back to our Message Sink actor with side-effects, and make it
dependent on its internal state. The state is affected by the incoming 
messages and is preserved until the next message comes in.</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/statefulsink.png" alt="Stateful Sink actor"></p>
<p>Does not look very functional, right? But this impression is wrong in fact.
We can represent the state before a message came in - as an extra input parameter, 
and  the state after the message got processed - as an output parameter. 
We start with an initial state and the output of the
first message becomes the input state of the second message:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/statefulsinkfunctional.png" alt="Stateful Sink functional actor"></p>
<p>Here is an example of a function which prints out the index of a message together
with the message contents:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> printIndex index msg =
  printn <span class="hljs-string">"Message [%i] received: %A"</span> index msg
  index + <span class="hljs-number">1</span>
</code></pre>
<p>For the actor implementation we need a recursive function so we can&#39;t use 
<code>actorOf2</code> anymore. Actor workflow is a bit more lines but still very simple:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> actorOfStatefulSink f initialState (mailbox : Actor&lt;<span class="hljs-attribute">'a</span>&gt;) =

  <span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> imp lastState =
    actor {
      <span class="hljs-keyword">let</span>! msg = mailbox.Receive()
      <span class="hljs-keyword">let</span> newState = f msg lastState
      <span class="hljs-keyword">return</span>! imp newState
    }

  imp initialState
</code></pre>
<p>And here is a usage example:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> printIndexActorRef = 
  actorOfSink printIndex <span class="hljs-number">1</span>
  |&gt; spawn system <span class="hljs-string">"print-ix-actor"</span>

printActorRef &lt;! <span class="hljs-number">3</span>
<span class="hljs-comment">// "Message [1] received: 3" is printed</span>

printActorRef &lt;! <span class="hljs-number">4</span>
<span class="hljs-comment">// "Message [2] received: 4" is printed</span>
</code></pre>
<hr>
<p><a name="StatefulConverter" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharpundefined"></a></p>
<h2 id="stateful-converter">Stateful Converter</h2>
<p>By now, the core function of the Stateful Converter actor should be a no-brainer for you. The actor
would have two input parameters and two outputs (in a tuple). One of the outputs
is a message and goes to another actor, the other output becomes an input for the
next actor:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/statefulconverter.png" alt="Stateful Converter actor"></p>
<p>Here is a function which squares the messaged number, then calculates the running total
and sends it forward:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> squareAndSum sum msg =
  <span class="hljs-keyword">let</span> result = sum + msg*msg
  (result, result)
</code></pre>
<p>In this particular case the output message and state are equal, but they don&#39;t
have to be. Here is the actor implementation:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> actorOfStatefulConvert f initialState outputRef (mailbox : Actor&lt;<span class="hljs-attribute">'a</span>&gt;) =

  <span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> imp lastState =
    actor {
      <span class="hljs-keyword">let</span>! msg = mailbox.Receive()
      <span class="hljs-keyword">let</span> (result, newState) = f msg lastState
      outputRef &lt;! result
      <span class="hljs-keyword">return</span>! imp newState
    }

  imp initialState
</code></pre>
<p>And a usage example:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> squareAndSumActorRef = 
  actorOfConvert square <span class="hljs-number">0</span> printIndexActorRef 
  |&gt; spawn system <span class="hljs-string">"square-sum-actor"</span>

squareAndSumActorRef &lt;! <span class="hljs-number">3</span>
<span class="hljs-comment">// "Message [1] received: 9" is printed</span>

squareAndSumActorRef &lt;! <span class="hljs-number">4</span>
<span class="hljs-comment">// "Message [2] received: 25" is printed</span>
</code></pre>
<hr>
<p><a name="ConverterSupervisor" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharpundefined"></a></p>
<h2 id="converter-supervisor">Converter-Supervisor</h2>
<p>In the previous patterns the Converter actors were sending messages 
to predefined actor references which were not managed (or supervised in Akka terms)
by those actors. Now, let&#39;s say that the actor needs to create a child
to send converted messages to it afterwards: </p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/supervisedchild.png" alt="Supervised Child actor"></p>
<p>We can treat such child reference as the state and instantiate it when the first message
comes in. (We can&#39;t spawn it before the first message because the
<code>mailbox</code> object is required.) The message goes to the actor
reference that we store in the state, something like this:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/childasstate.png" alt="Supervised Child as State"></p>
<p>Here is the generic actor implementation:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> actorOfConvertToChild f spawnChild (mailbox : Actor&lt;<span class="hljs-attribute">'a</span>&gt;) =

  <span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> imp state =
    actor {
      <span class="hljs-keyword">let</span> newstate =
        <span class="hljs-keyword">match</span> state <span class="hljs-keyword">with</span>
        | Some s -&gt; s
        | None -&gt; spawnChild mailbox

      <span class="hljs-keyword">let</span>! msg = mailbox.Receive()
      newstate &lt;! f msg
      <span class="hljs-keyword">return</span>! imp (Some newstate)
    }

  imp None
</code></pre>
<p>The only difference is that we accept a <code>spawnChild</code> function instead of
pre-baked actor reference. Here is the first calculator example refactored
to Print actor being a child of Square actor.</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> squareWithChildRef = 
  actorOfConvertToChild print (spawnChild square <span class="hljs-string">"print-actor"</span>)
  |&gt; spawn system <span class="hljs-string">"square-with-child-actor"</span>
</code></pre>
<p>Notice that the <code>square</code> and <code>print</code> functions have exactly the same signatures
and implementations as we used before, and the concern of actor hierarchy is 
completely separated from the business logic of the actors.</p>
<p>This hierarchy is handy whenever you need multiple instances of one actor type
(<code>f</code>-actor from the picture) and corresponding instances of another actor type
(<code>g</code>-actor):</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/multiparents.png" alt="Multiple Parents and Children actor"></p>
<hr>
<p><a name="RouterSupervisor" href="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharpundefined"></a></p>
<h2 id="router-supervisor">Router-Supervisor</h2>
<p>Routers are the kind of actors which forward each incoming message to one
or more downstream actors. In this example the downstream actors are supervised
by the Router itself.
So, the Router-Supervisor can have multiple children and send the result of 
message processing to one or more of them:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/router.png" alt="Router actor"></p>
<p>To keep the spirit of functional actors, we represent the router logic with a function
of type <code>&#39;a -&gt; seq&lt;string * &#39;b&gt;</code>, where <code>&#39;a</code> is the type of incoming messages,
<code>&#39;b</code> is the type of outgoing messages, and <code>string</code> represents the identifier of the 
actor to get the message. Here is a sample implementation:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> routeSensorData msg = 
  msg |&gt; Seq.map (<span class="hljs-keyword">fun</span> x -&gt; (<span class="hljs-string">"sensor-actor-"</span> + x.SensorId, x.Temperature))
</code></pre>
<p>Based on the incoming metadata (sensor identifier) the actor forwards its
temperature to corresponding sensor-specific actor. </p>
<p>Here is the implementation of the generic actor function:</p>
<pre class="highlight"><code class="hljs fsharp"><span class="hljs-keyword">let</span> actorOfRouteToChildren f spawnChild (mailbox : Actor&lt;<span class="hljs-attribute">'a</span>&gt;) =

  <span class="hljs-keyword">let</span> getActor id = 
    <span class="hljs-keyword">let</span> actorRef = mailbox.Context.Child(id)
    <span class="hljs-keyword">if</span> actorRef.IsNobody() <span class="hljs-keyword">then</span>
      spawnChild id mailbox
    <span class="hljs-keyword">else</span> 
      actorRef

  <span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> imp () =
    actor {
      <span class="hljs-keyword">let</span>! msg = mailbox.Receive()
      f msg |&gt; Seq.iter (<span class="hljs-keyword">fun</span> (id, x) -&gt; (getActor id) &lt;! x) 
      <span class="hljs-keyword">return</span>! imp ()
    }

  imp ()
</code></pre><p>And a usage example:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> sensorRouterRef = 
  actorOfRouteToChildren routeSensorData (spawnChild square)
  |&gt; spawn system <span class="hljs-string">"route-sensor-actor"</span>
</code></pre>
<p>Note that <code>spawnChild</code> does not accept the child ID anymore because it&#39;s being
controlled by the router itself.</p>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>With the patterns that we have so far we should be able to build quite powerful
hierarchies like the one shown below:</p>
<p><img src="/2016/03/functional-actor-patterns-with-akkadotnet-and-fsharp/usecase.png" alt="Actor use case"></p>
<p>There might be many other scenarios and types of actors that would make sense
in your use case. I&#39;m just showing the basic patterns, but more importantly the way of 
reasoning about the code. Don&#39;t 
let the multitude of actor aspects push you into the world of poorly structured 
code.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/f#/'>F#</a>, <a href='/tags/akka-net/'>akka.net</a>, <a href='/tags/actor-model/'>actor model</a>, <a href='/tags/functional-programming/'>functional programming</a>, <a href='/tags/patterns/'>patterns</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 11th, 2016</div>
    
    <h1><a href='/2016/03/aurelia-map-component-with-leaflet'>Aurelia Map Component with Leaflet</a></h1>
    
    <div class="post-content">
        <p>This is a short tutorial on how to create a map control in <a href="http://aurelia.io">Aurelia.js</a> 
application. I am using the <a href="http://leafletjs.com">Leaflet</a> library with custom tile
source and I also show the way to implement your own overlay layer. Here is what
my map looks like:</p>
<p><img src="/2016/03/aurelia-map-component-with-leaflet/map.png" alt="Map"></p>
<p>So, I assume you already have an existing Aurelia application, and let&#39;s start.</p>
<h2 id="install-leaflet">Install Leaflet</h2>
<p>The following command will install Leaflet module to the application:</p>
<pre class="highlight"><code class="hljs cmake">jspm <span class="hljs-keyword">install</span> leaflet
</code></pre><p>If you are using TypeScript, don&#39;t forget to add type definitions</p>
<pre class="highlight"><code class="hljs cmake">tsd <span class="hljs-keyword">install</span> leaflet
</code></pre><h2 id="define-a-map-component">Define a Map Component</h2>
<p>Create a new <code>map.html</code> file and put the following contents there:</p>
<pre class="highlight"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">require</span> <span class="hljs-attribute">from</span>=<span class="hljs-value">"leaflet/dist/leaflet.css"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">require</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"mapid"</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"height: 100%"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">template</span>&gt;</span>
</code></pre>
<p>We import the CSS required by leaflet and define the <code>div</code> element to host
the map in. Then, create a new <code>map.js</code> file (or <code>map.ts</code> for typescript),
here is the minimum code:</p>
<pre class="highlight"><code class="hljs javascript">export <span class="hljs-keyword">class</span> Map {
}
</code></pre>
<h2 id="load-the-map-with-tiles">Load the Map with Tiles</h2>
<p>First, import the leaflet module in your codebehind:</p>
<pre class="highlight"><code class="hljs javascript">import * as L from <span class="hljs-string">'leaflet'</span>;
</code></pre>
<p>Now, define the <code>attached</code> function, which would be called by Aurelia when
control&#39;s HTML is loaded, and make a map there:</p>
<pre class="highlight"><code class="hljs javascript">export <span class="hljs-keyword">class</span> Map {
  attached() {
    <span class="hljs-keyword">let</span> map = L.map(<span class="hljs-string">'mapid'</span>).setView([<span class="hljs-number">51.505</span>, -<span class="hljs-number">0.09</span>], <span class="hljs-number">13</span>);

    <span class="hljs-keyword">let</span> urlTemplate = <span class="hljs-string">'http://{s}.tile.osm.org/{z}/{x}/{y}.png'</span>;
    map.addLayer(L.tileLayer(urlTemplate, { minZoom: <span class="hljs-number">4</span> }));
  }
}
</code></pre>
<p>The example above uses the URL template of Open Street Maps as per the Leaflet&#39;s
tutorial, but I needed to use our privately hosted maps, so I changed it to
something like:</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-keyword">let</span> urlTemplate = <span class="hljs-string">'http://www.mysite.com/tiles?layer=background&amp;level={z}&amp;x={x}&amp;y={y}'</span>;
map.addLayer(L.tileLayer(urlTemplate, { minZoom: <span class="hljs-number">4</span>, zoomOffset: <span class="hljs-number">8</span> }));
</code></pre>
<p>The <code>zoomOffset</code> parameter was required to fix impedance mismatch of zoom levels.</p>
<h2 id="custom-overlay-layer">Custom Overlay Layer</h2>
<p>For our custom maps we needed to show two layers on top of each other:</p>
<ul>
<li>The usual tile layer for the map background</li>
<li>The overlay layer for the map labels and additional information</li>
</ul>
<p>The overlay layer can&#39;t be broken down into tiles (not supported by our map provider),
so we need to show the whole layer as a single picture and then refresh it every
time user pans or zooms the map.</p>
<p>The overlay layer can be implemented with <code>onAdd</code> and <code>onRemove</code> functions
and then feeding an image element to the Leaflet as a layer. Here is the code:</p>
<pre class="highlight"><code class="hljs javascript">import * as L from <span class="hljs-string">'leaflet'</span>;

export <span class="hljs-keyword">class</span> LabelOverlayLayer {
  map;
  image;

  onAdd(map) {
    <span class="hljs-keyword">this</span>.map = map;

    <span class="hljs-keyword">this</span>.image = L.DomUtil.create(<span class="hljs-string">'img'</span>, <span class="hljs-string">'leaflet-tile-loaded'</span>);
    map.getPanes().overlayPane.appendChild(<span class="hljs-keyword">this</span>.image);

    map.on(<span class="hljs-string">'moveend'</span>, <span class="hljs-keyword">this</span>.render, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.render();
  }

  onRemove (map) {
    map.getPanes().overlayPane.removeChild(<span class="hljs-keyword">this</span>.image);
    map.off(<span class="hljs-string">'moveend'</span>, <span class="hljs-keyword">this</span>.render, <span class="hljs-keyword">this</span>);
  }

  render() {
    <span class="hljs-keyword">let</span> bounds = <span class="hljs-keyword">this</span>.map.getBounds(), mapSize = <span class="hljs-keyword">this</span>.map.getSize();
    <span class="hljs-keyword">let</span> se = bounds.getSouthEast(), nw = bounds.getNorthWest();

    <span class="hljs-keyword">let</span> tileUrl = `http:<span class="hljs-comment">//www.mysite.com/tiles?layer=labels&amp;lonmin=${nw.lng}&amp;latmin=${se.lat}&amp;lonmax=${se.lng}&amp;latmax=${nw.lat}&amp;width=${Math.floor(mapSize.x)}&amp;height=${Math.floor(mapSize.y)}`;</span>
    <span class="hljs-keyword">this</span>.image.src = tileUrl;

    <span class="hljs-keyword">let</span> pos = <span class="hljs-keyword">this</span>.map.latLngToLayerPoint(nw);
    L.DomUtil.setPosition(<span class="hljs-keyword">this</span>.image, pos, <span class="hljs-literal">false</span>);
  }
};
</code></pre>
<p>The usage of this layer in the map component is trivial:</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-keyword">this</span>.map.addLayer(<span class="hljs-keyword">new</span> LabelOverlayLayer());
</code></pre>
<h2 id="use-the-map-component">Use the Map Component</h2>
<p>The map component is ready to be used in the application:</p>
<pre class="highlight"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">require</span> <span class="hljs-attribute">from</span>=<span class="hljs-value">"./components/map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">require</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">div</span>  <span class="hljs-attribute">style</span>=<span class="hljs-value">"height: 700px"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">map</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">map</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
</code></pre>
<p>The container around the map should have a non-zero height, so I made it fixed
in the example above.</p>
<p>Don&#39;t forget to bundle the leaflet assets by including the following lines
into your <code>bundles.json</code>:</p>
<pre class="highlight"><code class="hljs undefined">"includes": [
  "aurelia-framework",
  // ...
  "leaflet",
  "leaflet/dist/leaflet.css!text"
],
</code></pre>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/aurelia/'>Aurelia</a>, <a href='/tags/leaflet/'>leaflet</a>, <a href='/tags/typescript/'>typescript</a>, <a href='/tags/javascript/'>javascript</a>, <a href='/tags/maps/'>maps</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 1st, 2016</div>
    
    <h1><a href='/2016/03/building-a-poker-bot-mouse-movements'>Building a Poker Bot: Mouse Movements</a></h1>
    
    <div class="post-content">
        <p><em>This is the third part of <strong>Building a Poker Bot</strong> series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here are the previous parts:</em></p>
<ul>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/"><em>Building a Poker Bot: Card Recognition</em></a></li>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/"><em>Building a Poker Bot: String and Number Recognition</em></a></li>
</ul>
<p>In this short post I write about the last step of the poker bot flow: clicking
the buttons. So, the screen is already recognized, the hand is understood,
the decisions are made and now the bot needs to execute the actions. Except for
the bet sizing, this simply means clicking the right button at the poker table.</p>
<p>The stealthiness of such clicks is a valid concern here. Ideally, we want all
the mouse movements to look as similar as possible to the movements produced
by a human being. For this post, I will simplify the task to the following steps:</p>
<ul>
<li>Identify where the mouse cursor is right now</li>
<li>Decide where the mouse should be moved to</li>
<li>Gradually move the mouse cursor</li>
<li>Click the button</li>
</ul>
<h2 id="cursor-position">Cursor Position</h2>
<p>It&#39;s really easy to understand where the mouse cursor currently is: just
use <code>Control.MousePosition</code> property from the standard library:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> currentPosition () = 
  <span class="hljs-keyword">let</span> mp = System.Windows.Forms.Control.MousePosition
  (mp.X, mp.Y)
</code></pre>
<p>Note that your application doesn&#39;t have to be based on WinForms, just reference
the required assembly.</p>
<h2 id="move-the-cursor">Move the Cursor</h2>
<p>I use the third party <a href="https://inputsimulator.codeplex.com/">WindowsInput</a> 
library to control the mouse and the keyboard programmatically. It uses some
weird coordinate system, so the function to move the mouse cursor looks like this:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> simulator = <span class="hljs-keyword">new</span> InputSimulator()

<span class="hljs-keyword">let</span> moveTo x y =
  <span class="hljs-keyword">let</span> toX = <span class="hljs-number">65535.</span> * x / (Screen.PrimaryScreen.Bounds.Width |&gt; float)
  <span class="hljs-keyword">let</span> toY = <span class="hljs-number">65535.</span> * y / (Screen.PrimaryScreen.Bounds.Height |&gt; float)
  simulator.Mouse.MoveMouseTo(toX, toY)
</code></pre>
<p>The input parameters <code>x</code> and <code>y</code> are the pixel location starting at 
the top-left corner of the screen.</p>
<h2 id="move-it-smoothly">Move It Smoothly</h2>
<p>Now we want to simulate the human-like movements. It won&#39;t be perfect, but
at least it should look decent. For this gradual movement function I used
a nice F# feature called asynchronous workflows. Effectively, it looks like
a loop with async sleep statements inside.</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> moveToWorkflow step (toX, toY) = async {
  <span class="hljs-keyword">let</span> (fromX, fromY) = currentPosition()
  <span class="hljs-keyword">let</span> count = Math.Max(<span class="hljs-number">10</span>, (Math.Abs (toX - fromX) + Math.Abs (toY - fromY)) / <span class="hljs-number">20</span>)
  <span class="hljs-keyword">for</span> i = <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> count <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">let</span> x = step fromX toX count i |&gt; float
    <span class="hljs-keyword">let</span> y = step fromY toY count i |&gt; float
    moveTo x y
    <span class="hljs-keyword">do</span>! Async.Sleep <span class="hljs-number">3</span>
  }
</code></pre>
<p>The key parameter here is the <code>step</code> function of obscure type <code>int -&gt; int -&gt; int -&gt; int -&gt; int</code>.
Basically, it calculates a coordinate for n-th step of the movement. We can
plug different implementations of this function to find the right balance of
the movement style. Here is the simplest linear implementation:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> linearStep from until max i =
  from + (until - from) * i / max
</code></pre>
<p>The sinus-based implementation is a bit more verbose because of float-int 
conversions:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> sinStep (from:int) (until:int) (max:int) (index:int) =
  <span class="hljs-keyword">let</span> fromf = from |&gt; float
  <span class="hljs-keyword">let</span> untilf = until |&gt; float
  <span class="hljs-keyword">let</span> maxf = max |&gt; float
  <span class="hljs-keyword">let</span> indexf = index |&gt; float
  fromf + (untilf - fromf) * Math.Sin(Math.PI / <span class="hljs-number">2.</span> * indexf / maxf) |&gt; int
</code></pre>
<p>The following animation illustrates the concept: </p>
<svg width="778" height="190" viewbox="0 0 500 190">
  <image id="mouse1" x="0" y="20" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>
  <image id="mouse2" x="0" y="90" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>
  <image id="mouse3" x="0" y="160" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>

  <animate xlink:href="#mouse1" attributename="x" from="0" to="0" values="0;450;0" keytimes="0;0.5;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" calcmode="discrete" id="img-anim1"></animate>
  <animate xlink:href="#mouse2" attributename="x" from="0" to="0" values="0;450;0" keytimes="0;0.5;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" id="img-anim2"></animate>
  <animate xlink:href="#mouse3" attributename="x" from="0" to="0" values="0;70;139;204;264;318;364;401;428;444;450;380;311;246;186;132;86;49;22;6;0" keytimes="0;0.05;0.1;0.15;0.2;0.25;0.3;0.35;0.4;0.45;0.5;0.55;0.6;0.65;0.7;0.75;0.8;0.85;0.9;0.95;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" id="img-anim3"></animate><br></svg>

<p>The top mouse cursor just
jumps from left to right and back (no animation). The middle cursor moves with
linear speed (<code>linearStep</code> function above). The bottom cursor moves based on
the <code>sinStep</code> function derived from sinus of time.</p>
<h2 id="click-the-button">Click the Button</h2>
<p>A button is a rectangle and we want to click a random point inside it. So, all
we need is to pick random coordinates, move the mouse there and send a 
click event via the simulator:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> clickButton (minX, minY, maxX, maxY) =
  <span class="hljs-keyword">let</span> r = <span class="hljs-keyword">new</span> Random()
  <span class="hljs-keyword">let</span> p = (r.Next(minX, maxX), r.Next(minY, maxY))
  moveToWorkflow sinStep p |&gt; Async.RunSynchronously
  simulator.Mouse.LeftButtonClick()
</code></pre>
<h2 id="demo-time">Demo Time</h2>
<p>Here is the demo of the mouse movements:</p>
<p><img src="/2016/03/building-a-poker-bot-mouse-movements/mouseclicking.gif" alt="Mouse clicking the button"></p>
<p>It looks fun, doesn&#39;t it? The full code for the mouse movements can be found in 
<a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/Clicker.fs">my github repo</a>.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>poker bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/human-like-behavior/'>human-like behavior</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 23rd, 2016</div>
    
    <h1><a href='/2016/02/unit-testing-dapper-repositories'>Unit testing Dapper repositories</a></h1>
    
    <div class="post-content">
        <p><a href="https://github.com/StackExchange/dapper-dot-net">Dapper</a> is a micro-ORM library which is 
very simple and super fast. In our projects we use Dapper for the tasks where something like
EntityFramework or NHibernate would be an overkill.</p>
<p>Quite often the data access code is difficult to be unit tested. Objects like
database connections, commands, transactions and contexts are hard to mock, and
thus the data access code is not easily isolated. Dapper relies heavily on SQL
statements inside C# code, which gives an extra complication. Some people would
argue that unit tests are not warranted for data access layer, and integration
tests should be used instead. Let&#39;s have a look at another possibility.</p>
<h2 id="an-example-of-a-repository">An Example of a Repository</h2>
<p>Let&#39;s say we have a simple class and we want to populate instances of this class
from the database:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Product</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Description { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
<p>To be able to use Dapper for data access, we need an instance of <code>IDbConnection</code>.
As we want to be able to mock the connection for unit tests, we need to create
a factory interface to abstract it away:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDatabaseConnectionFactory</span>
{
    <span class="hljs-function">IDbConnection <span class="hljs-title">GetConnection</span><span class="hljs-params">()</span></span>;
}
</code></pre>
<p>Now the repository would get a connection from this factory and execute 
Dapper queries on it:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductRepository</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDatabaseConnectionFactory connectionFactory;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProductRepository</span><span class="hljs-params">(IDatabaseConnectionFactory connectionFactory)</span>
    </span>{
        <span class="hljs-keyword">this</span>.connectionFactory = connectionFactory;
    }

    <span class="hljs-keyword">public</span> Task&lt;IEnumerable&lt;Product&gt;&gt; GetAll()
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connectionFactory.GetConnection().QueryAsync&lt;Product&gt;(
            <span class="hljs-string">"select * from Product"</span>);
    }
}
</code></pre>
<h2 id="testing-without-a-real-database">Testing Without a real Database</h2>
<p>Here is my approach to testing the repository:</p>
<ol>
<li>Use an in-memory <a href="https://www.sqlite.org/">SQLite3</a> database.</li>
<li>Create a table there and put some data in.</li>
<li>Run the repository against this database.</li>
<li>Compare the result to the expected values.</li>
</ol>
<p>Here is a helper class which uses another micro-ORM library <a href="http://ormlite.com/">OrmLite</a> to talk
to SQLite database:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InMemoryDatabase</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrmLiteConnectionFactory dbFactory = 
        <span class="hljs-keyword">new</span> OrmLiteConnectionFactory(<span class="hljs-string">":memory:"</span>, SqliteOrmLiteDialectProvider.Instance);

    <span class="hljs-function"><span class="hljs-keyword">public</span> IDbConnection <span class="hljs-title">OpenConnection</span><span class="hljs-params">()</span> </span>=&gt; <span class="hljs-keyword">this</span>.dbFactory.OpenDbConnection();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> Insert&lt;T&gt;(IEnumerable&lt;T&gt; items)
    {
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">this</span>.OpenConnection())
        {
            db.CreateTableIfNotExists&lt;T&gt;();
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)
            {
                db.Insert(item);
            }
        }
    }
}
</code></pre>
<p>And here is the test for our <code>ProductRepository</code> class:</p>
<pre class="highlight"><code class="hljs cs">[Test]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">QueryTest</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// Arrange</span>
    <span class="hljs-keyword">var</span> products = <span class="hljs-keyword">new</span> List&lt;Product&gt;
    {
        <span class="hljs-keyword">new</span> Product { ... },
        <span class="hljs-keyword">new</span> Product { ... }
    };
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> InMemoryDatabase();
    db.Insert(products);
    connectionFactoryMock.Setup(c =&gt; c.GetConnection()).Returns(db.OpenConnection());

    <span class="hljs-comment">// Act</span>
    <span class="hljs-keyword">var</span> result = <span class="hljs-function"><span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title">ProductRepository</span><span class="hljs-params">(connectionFactoryMock.Object)</span>.<span class="hljs-title">GetAll</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// Assert</span>
    result.ShouldBeEquivalentTo(products);
}
</code></pre>
<h2 id="is-it-a-unit-test-">Is It a Unit Test?</h2>
<p>Well, not completely. This approach does not mock the database, but instead puts
an in-memory database in place of the normal one. The problem is that we don&#39;t 
control all the details how it works, so it might not be as flexible as we need.
For instance, SQLite type system is quite simplistic, so while <code>INT</code> and <code>BIGINT</code>
are different column types in SQL Server, they are the same <code>INTEGER</code> type in
SQLite. This can lead to false positive or false negative tests in edge cases.</p>
<p>Nevertheless, the concept is simple and requires very little amount of code,
so it&#39;s useful to have it in the toolbox anyway. The resulting tests are fast,
have no external dependencies and are always consistent between multiple runs.
That makes them better than real integration tests for the simple scenarios 
during TDD development.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/unit-testing/'>unit testing</a>, <a href='/tags/dapper/'>Dapper</a>, <a href='/tags/orm/'>ORM</a>, <a href='/tags/tdd/'>TDD</a>
    </div>
    
</article>


<div class="page-nav">
    
    <a class="page-nav-newer" href="/3"><span class="icon icon-arrow-left-2"></span> Next page</a>
    
    
    <a class="page-nav-older" href="/5">Previous page <span class="icon icon-arrow-right-2"></span></a>
    
</div>

<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy F#, C#, Javascript and SQL development, reasoning about distributed systems, data processing pipelines, cloud and web apps. I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="http://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="http://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2016 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>