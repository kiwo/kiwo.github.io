<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.4" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">F#, C#, JS, SQL, Azure programmer</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                    <li><a href="/tags">Topics</a></li>
                
                    <li><a href="/archives">Archives</a></li>
                
                    <li><a href="/about">About</a></li>
                
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="http://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Nov 18th, 2016</div>
    
    <h1><a href='/2016/11/event-sourcing-and-io-complexity'>Event Sourcing and IO Complexity</a></h1>
    
    <div class="post-content">
        <p><strong>Event Sourcing</strong> is an approach, when an append-only store is used to record the full series of events that 
describe actions taken on a particular domain entity. This event store becomes the main source of truth 
to reconstruct the current state of the entity and its complete history.</p>
<p>In essence, that means that we store the log of all business events that occurred in the system, and then
we use them to make new decisions and produce new events. </p>
<h2 id="how-event-souring-works">How Event Souring Works</h2>
<p>Event Sourcing is usually used in combination with <strong>Command-Query Responsibility Segregation</strong>, when all writes 
to the event store are initiated by commands. </p>
<p>The following picture illustrates the storage and command handling:</p>
<p><img src="/2016/11/event-sourcing-and-io-complexity/event-store.png" alt="Event Store Command Handler"></p>
<p>Every time a new command comes in (1), the command handler understands 
which entity is affected and retrieves all the previous events from the store (2).</p>
<p>The handler aggregates the events and derives the current state of the entity (3). If command is valid given that 
state, the command handler produces a new event or several events (4), and writes them back to the event store (5).</p>
<h2 id="disk-space-usage">Disk Space Usage</h2>
<p>It&#39;s quite obvious that Event Sourcing requires more storage space than traditional approach of only storing 
the current state. The storage size is proportional to the total amount of events in the system, 
i.e. it&#39;s <code>O(n)</code> or <code>O(e * l)</code> where <code>e</code> is the count of entities in the system and <code>l</code> is the average 
amount of events per entity.</p>
<p>Here is the chart of disk space usage in a simplified situation of events of equal size:</p>
<p><img src="/2016/11/event-sourcing-and-io-complexity/disk-space.png" alt="Disk space simulation"></p>
<p>We saved 1000 events and consumed 1000 storage units. The disk space is cheap, so we are willing to take 
the trade-off of extra storage for the benefits that Event Sourcing provides.</p>
<h2 id="disk-io-usage">Disk IO Usage</h2>
<p>Let&#39;s look at how much IO operations we are going to perform over time. Let&#39;s say that reading or writing of
one event consumes one unit of IO capacity.</p>
<p>Every time a new event is received, we consume one write operation: it&#39;s still linear. The storage is append-only, 
so it makes sense that disk space and writes are essentially the same thing.</p>
<p>Reads are a different beast. Every time we receive a command, we need to perform <code>i</code> reads, where <code>i</code> 
is the amount of events so far for the entity. Let&#39;s have a look at several examples, each one is a
simulation of saving a thousand of new events.</p>
<p>In the <strong>first scenario</strong> we have a steady flow of incoming events. Events belong to different entities (aggregates) 
with <strong>10</strong> events per entity on average:</p>
<p><img src="/2016/11/event-sourcing-and-io-complexity/reads-low.png" alt="Reads for low amount of events per entity"></p>
<p>We can see that we do 5x more reads than writes. That is because for each event written we have to read 
all the previous events for the same entity, and on average there are 5 of them.</p>
<p>In the <strong>second scenario</strong> we receive the same amount of events in total. While most entities still have 
10 events on average, there is just one outlier entity which received <strong>100</strong> events, all in this time period.</p>
<p><img src="/2016/11/event-sourcing-and-io-complexity/reads-outlier.png" alt="Reads with an outlier entity"></p>
<p>Hey, the amount of reads almost doubled! The line also doesn&#39;t look linear anymore...</p>
<p>Let&#39;s look at the <strong>third extreme scenario</strong> when all 1000 events were generated by the <strong>same entity</strong>:</p>
<p><img src="/2016/11/event-sourcing-and-io-complexity/reads-single.png" alt="Reads from single entity"></p>
<p>The amount of reads skyrockets to <strong>100 times more</strong> compared to the first scenario. It&#39;s clearly quadratic!
The amount of reads for a single entity is <code>O(l)</code> where <code>l</code> is the event count for that entity.</p>
<h2 id="real-life-scenario">Real-Life Scenario</h2>
<p>In many use cases it&#39;s unlikely that you get outlier entities which have orders of magnitude difference in amount 
of events per entity. E.g. if your entity is an order in a webshop, there&#39;s just a few events that humans can 
generate about it.</p>
<p>However, if the events are generated from telemetry data or IoT devices, or if the entities tend to live for very 
long time (like bank accounts), that&#39;s a good sign you should not ignore the potential problem. A handful of anomaly 
devices can bring the whole storage to its knees, if protection is not carefully designed.</p>
<p>If your domain has a chance to belong to the second group, you better get prepared.</p>
<h2 id="capacity-planning-and-monitoring">Capacity Planning and Monitoring</h2>
<p>It&#39;s not enough to know just the total number of events in your store, nor is the incoming rate of new events
descriptive enough. </p>
<p>Start with modeling your Event Store against real data. Put some monitoring in place to see the distribution of 
event density per entity. Average number is not descriptive enough, so you need to build percentiles and 
know the maximum too.</p>
<p>Monitor the amount of reads on your data store. Set the baseline based on the real data
pattern, not imaginary numbers.</p>
<h2 id="throttling-sampling">Throttling / Sampling</h2>
<p>In IoT scenarios the easiest way out could be to discard events if they arrive too frequently from the same device, 
or use some sampling/aggregation at the ingress point. Only your business domain can define what kind of
data loss is acceptable, if any.</p>
<h2 id="snapshots">Snapshots</h2>
<p>Event Sourcing concept provides the solution for the reads problem in form of Snapshots. Once in every <code>x</code> events, 
you should produce a snapshot of the entity state. The next time an event comes in, you just read
the snapshot and the events which happened after the latest snapshot time (amount is less than <code>x</code>).</p>
<p>It might be tricky to come up with a good snapshot strategy in some cases, especially when the business domain
requires multiple projections to be built. </p>
<p>The snapshot size might also grow over time, if entity keeps some internal event-based lists. But snapshots 
seem to be the only real solution when the amount of events gets out of control. Choose your Event Store 
technology with this consideration in mind.</p>
<p>Happy Event Sourcing!</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/event-sourcing/'>Event Sourcing</a>, <a href='/tags/cqrs/'>CQRS</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Oct 17th, 2016</div>
    
    <h1><a href='/2016/10/leaflet-plugin-to-render-geographic-corridors'>Leaflet plugin to render geographic corridors</a></h1>
    
    <div class="post-content">
        <p>Yesterday I&#39;ve published a simple <a href="http://leafletjs.com/">Leaflet</a> plugin called
<a href="https://github.com/mikhailshilkov/leaflet-corridor">leaflet-corridor</a>. 
The plugin defines a new Leaflet primitive <code>L.Corridor</code>.</p>
<p>When initialized with an array of geo points and width, it renders a polyline 
with width fixed in meters, not in pixels. That means that line width changes whenever 
zoom level changes. </p>
<p><img src="/2016/10/leaflet-plugin-to-render-geographic-corridors/leaflet-corridor.gif" alt="Leaflet-corridor animation"></p>
<p>The plugin is handy to denote geographic corridors: ranges of specified width around 
a polyline. In our project we used it to show a predefined vehicle route from Origin to
Destination, with only limited allowed violation from this predefined route. Whenever
vehicle&#39;s position falls out of this corridor, the event of Out-of-corridor violation
is recorded and shown on the map.</p>
<p>Here are all the links for the corridor plugin:</p>
<ul>
<li><a href="https://github.com/mikhailshilkov/leaflet-corridor">Github repository</a> with source code, documentation and usage example</li>
<li><a href="http://mikhail.io/demos/leaflet-corridor/">Demo page</a> to try it out</li>
<li><a href="http://stackoverflow.com/questions/26206636/is-there-any-method-to-draw-path-polyline-on-leaflet-with-constant-width-strok/40064379">Stackoverflow question</a> which inspired me to open-source the implementation</li>
</ul>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/leaflet/'>Leaflet</a>, <a href='/tags/maps/'>Maps</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Oct 11th, 2016</div>
    
    <h1><a href='/2016/10/azure-sql-databases-backups-disaster-recovery-import-export'>Azure SQL Databases: Backups, Disaster Recovery, Import and Export</a></h1>
    
    <div class="post-content">
        <p>Azure SQL Database is a managed cloud database-as-a-service. It provides
application developers with SQL Server databases which are hosted in the
cloud and fully managed by Microsoft.</p>
<p>The service is very easy to start with. Several clicks in the portal and
you have a database running. Now you can copy the connection string to
your application config file, and boom - you have all up and running.
No installation, no license to buy - just pay the hourly fee.</p>
<p>Any production database is a very important asset, so we are used to 
give it a good care in self-hosted scenario. A number of questions appear
when you try to apply those practices to the cloud offering:</p>
<ul>
<li>How do I make a backup of my database? Where should I store it?</li>
<li>How do I move my database including schema and data from on-premise 
to the cloud?</li>
<li>How do I move it from the cloud to my local server?</li>
<li>What is a point-in-time restore offered by Azure?</li>
<li>Should I use geo-replication? What is geo-restore?</li>
</ul>
<p>In this post I&#39;ll give the short answers to these questions and the links
for further reading. </p>
<h2 id="what-is-point-in-time-restore-">What is Point-in-time Restore?</h2>
<p>All your databases are always automatically backed-up by Azure. They take
full, differential and log backups in the background to guarantee you always
have your data safe.</p>
<p>These backups are retained for 7 days for Basic, 14 days for Standard and 
35 days for Premium tier.</p>
<p>Within this period, you can choose any <em>minute</em> and restore your database
to that point in time. The restore always happens to a <strong>new</strong> database,
it does not overwrite your current database. </p>
<p><img src="/2016/10/azure-sql-databases-backups-disaster-recovery-import-export/PointInTimeRestore.png" alt="Point-in-time Restore"></p>
<p>That&#39;s very handy to recover from &quot;oops&quot; operations when data was deleted 
from one or more tables by a human or code error. In this case, you restore 
a copy of the database, and then move the data missing without stopping
the original database.</p>
<p>If the restored database must replace the current one, be prepared to change
connection strings once the restore operation is done. Alternatively, you
can rename both databases to point applications to the new database without
any other configuration changes.</p>
<p>Depending on the database size, the restore may take long time, up to several
hours, 12 hours max guaranteed. So, point-in-time restore is very flexible 
but not instant.</p>
<p>Further reading: 
<a href="https://azure.microsoft.com/en-us/blog/azure-sql-database-point-in-time-restore/">Azure SQL Database Point in Time Restore</a></p>
<h2 id="what-about-disaster-recovery-">What about disaster recovery?</h2>
<p>The same Point-in-time Restore can be used for disaster recovery. The backups
are automatically replicated to other Azure regions, and can be restored
in <em>any</em> Azure region. This is called <strong>Geo Restore</strong>.</p>
<p>In case of failure of the primary region, you can immediately start restoring
the database in another region. Remember that the restore might still take
up to several hours depending on the database size.</p>
<p>Also, because the replication is done asynchronously, the geo-restore will 
probably lead to some data loss. Usually it will be under 5 minutes of data,
but guarantee is 1 hour at max.</p>
<p>Further reading: 
<a href="https://azure.microsoft.com/en-us/blog/azure-sql-database-geo-restore/">Azure SQL Database Geo-Restore</a></p>
<h2 id="can-i-reduce-the-downtime-and-data-loss-">Can I reduce the downtime and data loss?</h2>
<p>If you want to be prepared to the failure of the database&#39;s Azure region
and be able to fail over much faster, you can use <strong>Active Geo Replication</strong>. 
Effectively, you are creating other (up to 5 in total) database(s) which
would be replicated from the primary database.</p>
<p><img src="/2016/10/azure-sql-databases-backups-disaster-recovery-import-export/GeoReplication.png" alt="Geo Replication"></p>
<p>The replication happens asynchronously, which means that the latency
of the primary database does not increase. That also means that some data
may be lost when replica database is promoted to be the new primary.
Microsoft guarantees that the loss will be limited to 5 seconds worth of data.</p>
<p>The failover can be done any time, manually or by your script.</p>
<p>Having replica databases means that you pay for them too. The performance
level (and the fee) is configurable per database.</p>
<p>As a bonus, you can use secondary databases as read-only replicas. Just
remember that the data might be slightly stale.</p>
<p>Geo Replication is only available for Standard and Premium pricing tiers.</p>
<p>Further reading: 
<a href="https://azure.microsoft.com/ru-ru/blog/spotlight-on-sql-database-active-geo-replication/">Spotlight on SQL Database Active Geo-Replication</a>,
<a href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-geo-replication-overview/">Overview: SQL Database Active Geo-Replication</a></p>
<h2 id="do-i-still-need-to-make-manual-backups-">Do I still need to make manual backups?</h2>
<p>Well, it&#39;s possible that you don&#39;t have to.</p>
<p>But there are at least two scenarios when you might still need to make 
manual backups:</p>
<ol>
<li><p>You need to keep a copy of your database for longer period than 
Point-in-time restore allows (7 to 35 days depending on the service tier).</p>
</li>
<li><p>You need a copy of your Azure database to be restored on premise.</p>
</li>
</ol>
<p>Let&#39;s look at manual backups.</p>
<h2 id="how-do-i-make-a-bak-file-from-my-azure-database-">How do I make a BAK file from my Azure Database?</h2>
<p>The <code>BAK</code> backup files are not directly supported by Azure SQL Databases. 
Instead, there is a feature called <code>Export Data tier application</code>, which
creates a <code>BACPAC</code> file in Azure Storage account.</p>
<p>The easiest way to do that is to use SQL Server Management Studio, connect to
Azure SQL Database, then right-click and select <code>Tasks -&gt; Export Data tier application</code>
in the menu. </p>
<p><img src="/2016/10/azure-sql-databases-backups-disaster-recovery-import-export/ExportDataTier.png" alt="Export Data Tier Application"></p>
<p>You can export the file to the local storage name or Azure Storage account. </p>
<p><img src="/2016/10/azure-sql-databases-backups-disaster-recovery-import-export/ExportSettings.png" alt="Export Settings"></p>
<p>Export will take some time and will consume your database DTUs, so you shouldn&#39;t
do it too often.</p>
<p>Export can also be triggered from Azure Portal and PowerShell scripts.</p>
<h2 id="how-do-i-restore-a-copy-of-my-cloud-database-to-a-local-server-">How do I restore a copy of my cloud database to a local server?</h2>
<p>Now, when you have a <code>BACPAC</code> file, it&#39;s really easy to restore it to any
SQL server instance. Right-click <code>Databases</code> node in SQL Server Management
Studio and select <code>Import Data-tier Application...</code>. </p>
<p><img src="/2016/10/azure-sql-databases-backups-disaster-recovery-import-export/ImportDataTier.png" alt="Import Data Tier Application"></p>
<p>Then pick the location of the saved file.</p>
<h2 id="how-do-i-move-my-existing-database-to-azure-sql-database-">How do I move my existing database to Azure SQL Database?</h2>
<p>The process is exactly the same as described above, just the other direction:</p>
<ul>
<li>Export Data-tier Application from your local SQL Server to Azure Storage</li>
<li>Import Data-tier Application to a new Azure SQL Database</li>
</ul>
<h2 id="summary">Summary</h2>
<p>Azure SQL Database is a production-ready fully managed service, which can
dramatically reduce the amount of manual administration compared to on-premise
setup. You can choose between several disaster recovery scenarios based on
your objectives and budget. Import and export of databases are available,
allowing operators to move databases between the cloud and self-hosted servers.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/azure/'>Azure</a>, <a href='/tags/azure-sql-database/'>Azure SQL Database</a>, <a href='/tags/disaster-recovery/'>Disaster Recovery</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Aug 21st, 2016</div>
    
    <h1><a href='/2016/08/getting-started-with-azure-application-insights-in-aurelia'>Getting started with Azure Application Insights in Aurelia</a></h1>
    
    <div class="post-content">
        <p><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-overview/">Azure Application Insights</a>
is an analytics service to monitor live web applications,
diagnose performance issues, and understand what users actually do with the app. 
<a href="http://aurelia.io">Aurelia</a> is a modern and slick single-page application framework.
Unfortunately, there&#39;s not much guidance on the web about how to use AppInsights and
Aurelia together in a proper manner. The task gets even more challenging in case you are
using TypeScript and want to stay in type-safe land. This post will set you up and
running in no time.</p>
<h2 id="get-your-appinsights-instrumentation-key">Get Your AppInsights Instrumentation Key</h2>
<p>If not done yet, go register in Azure Application Insights portal. To start sending
telemetry data from your application you would need a unique identifier of 
your web application, which is called an Instrumentation Key (it&#39;s just a guid). 
See <a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-javascript/">Application Insights for web pages</a>
walk-through.</p>
<h2 id="install-a-jspm-package">Install a JSPM Package</h2>
<p>I&#39;m using JSPM as a front-end package manager for Aurelia applications. If you use it
as well, run the following command to install AppInsights package:</p>
<pre class="highlight"><code class="hljs cmake">jspm <span class="hljs-keyword">install</span> github:Microsoft/ApplicationInsights-js
</code></pre><p>it will add a line to <code>config.js</code> file:</p>
<pre class="highlight"><code class="hljs r">map: {
  <span class="hljs-string">"Microsoft/ApplicationInsights-js"</span>: <span class="hljs-string">"github:Microsoft/ApplicationInsights-js@1.0.0"</span>,
<span class="hljs-keyword">...</span>
</code></pre><p>To keep the names simple, change the line to </p>
<pre class="highlight"><code class="hljs perl">  <span class="hljs-string">"ApplicationInsights"</span>: <span class="hljs-string">"github:Microsoft/ApplicationInsights-js<span class="hljs-variable">@1</span>.0.0"</span>,
</code></pre><p>Do exactly the same change in <code>project.json</code> file, <code>jspm</code> -&gt; <code>dependencies</code> section.</p>
<h2 id="create-an-aurelia-plugin">Create an Aurelia Plugin</h2>
<p>In order to track Aurelia page views, we are going to plug into the routing pipeline
with a custom plugin. Here is how my plugin looks like in JavaScript (see TypeScript
version below):</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-comment">// app-insights.js</span>
export <span class="hljs-keyword">class</span> AppInsights {
  client;

  constructor() {
    <span class="hljs-keyword">let</span> snippet = {
      config: {
        instrumentationKey: <span class="hljs-string">'YOUR INSTRUMENTATION KEY GUID'</span>
      }
    };
    <span class="hljs-keyword">let</span> init = <span class="hljs-keyword">new</span> Microsoft.ApplicationInsights.Initialization(snippet);
    <span class="hljs-keyword">this</span>.client = init.loadAppInsights();
  }

  run(routingContext, next) {
    <span class="hljs-keyword">this</span>.client.trackPageView(routingContext.fragment, <span class="hljs-built_in">window</span>.location.href);
    <span class="hljs-keyword">return</span> next();
  }
}
</code></pre>
<p>The constructor instantiates an AppInsights client. It is used inside a <code>run</code> method,
which would be called by Aurelia pipeline during page navigation.</p>
<h2 id="add-the-plugin-to-aurelia-pipeline">Add the Plugin to Aurelia Pipeline</h2>
<p>Go the the <code>App</code> class of your Aurelia application. Import the new plugin</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-comment">// app.js</span>
import {AppInsights} from <span class="hljs-string">'./app-insights'</span>;
</code></pre>
<p>and change the <code>configureRouter</code> method to register a new pipeline step:</p>
<pre class="highlight"><code class="hljs javascript">configureRouter(config, router): <span class="hljs-keyword">void</span> {
  config.addPipelineStep(<span class="hljs-string">'modelbind'</span>, AppInsights);
  config.map(<span class="hljs-comment">/*routes are initialized here*/</span>);
}
</code></pre>
<p>After re-building the application, you should be all set to go. Navigate several pages
and wait for events to appear in Application Insights portal.</p>
<h2 id="typescript-obtain-the-definition-file">TypeScript: Obtain the Definition File</h2>
<p>If you are using TypeScript, you are not done yet. In order to compile the <code>AppInsights</code>
plugin you need the type definitions for <code>ApplicationInsights</code> package. Unfortunately,
at the time of writing there is no canonical definition in <code>typings</code> registry, so
you will have to provide a custom <code>.d.ts</code> file. You can download mine from
<a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/aurelia-app-insights/applicationinsights.d.ts">my github</a>. 
I created it based on a file from 
<a href="https://www.nuget.org/packages/Microsoft.ApplicationInsights.TypeScript">this NuGet repository</a>.</p>
<p>I&#39;ve put it into the <code>custom_typings</code> folder and then made the following adjustment
to <code>build/paths.js</code> file of Aurelia setup:</p>
<pre class="highlight"><code class="hljs gherkin">  dtsSrc: [
    'typings/<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>/<span class="hljs-keyword">*</span>.d.ts',
    'custom_typings/<span class="hljs-keyword">*</span><span class="hljs-keyword">*</span>/<span class="hljs-keyword">*</span>.d.ts'
  ],
</code></pre><p>For the reference, here is my TypeScript version of the <code>AppInsights</code> plugin:</p>
<pre class="highlight"><code class="hljs ts"><span class="hljs-keyword">import</span> {NavigationInstruction, Next} from <span class="hljs-string">'aurelia-router'</span>;
<span class="hljs-keyword">import</span> {Microsoft} from <span class="hljs-string">'ApplicationInsights'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppInsights {
  <span class="hljs-keyword">private</span> client: Microsoft.ApplicationInsights.AppInsights;

  <span class="hljs-constructor"><span class="hljs-keyword">constructor</span>() </span>{
    <span class="hljs-keyword">let</span> snippet = {
      config: {
        instrumentationKey: <span class="hljs-string">'YOUR INSTRUMENTATION KEY GUID'</span>
      },
      queue: []
    };
    <span class="hljs-keyword">let</span> init = <span class="hljs-keyword">new</span> Microsoft.ApplicationInsights.Initialization(snippet);
    <span class="hljs-keyword">this</span>.client = init.loadAppInsights();
  }

  run(routingContext: NavigationInstruction, next: Next): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">this</span>.client.trackPageView(routingContext.fragment, <span class="hljs-built_in">window</span>.location.href);
    <span class="hljs-keyword">return</span> next();
  }
}
</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>This walk-through should get you started with Azure Application Insights in your
Aurelia application. Once you have page view metrics coming into the dashboard,
spend more time to discover all the exciting ways to improve your application
with Application Insights.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/azure/'>Azure</a>, <a href='/tags/appliction-insights/'>Appliction Insights</a>, <a href='/tags/aurelia/'>Aurelia</a>, <a href='/tags/javascript/'>Javascript</a>, <a href='/tags/typescript/'>Typescript</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Aug 5th, 2016</div>
    
    <h1><a href='/2016/08/comparing-scala-to-fsharp'>Comparing Scala to F#</a></h1>
    
    <div class="post-content">
        <p>F# and Scala are quite similar languages from 10.000 feet view. Both are
functional-first languages developed for the virtual machines where imperative
languages dominate. C# for .NET and Java for JVM are still <em>lingua franca</em>, 
but alternatives are getting stronger.</p>
<p>My background is in .NET ecosystem, so F# was the first of the two that I started
learning. At the same time, Scala seems to have more traction, largely due to
successful products and frameworks like Spark, Akka and Play. That&#39;s why I decided
to broaden my skill set and pick up some Scala knowledge. I&#39;ve started with 
<a href="https://www.coursera.org/specializations/scala">Functional Programming in Scala Specialization</a> at Coursera.
While following the coursera, I&#39;m doing some notes about which language features
in Scala I find interesting, or vice versa - missing compared to F#.</p>
<p>In no particular order, I want to share my notes of Scala vs F# in this blog post.</p>
<p><em>Post updated based on comments by Mark Lewis and Giacomo Citi.</em></p>
<h2 id="implicit-parameters">Implicit Parameters</h2>
<p>A parameter of a function can be marked as implicit</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">work</span>(</span><span class="hljs-keyword">implicit</span> i:<span class="hljs-type">Int</span>) = print(i)
</code></pre>
<p>and that means you can call the function without specifying the value for this parameter
and the compiler will try to figure out that value you (according to
the extensive set of rules), e.g.</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-keyword">implicit</span> <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">v</span> =</span> <span class="hljs-number">2</span>;
<span class="hljs-comment">// ... somewhere below</span>
work <span class="hljs-comment">// prints '2'</span>
</code></pre>
<p>I am not aware of any similar features in other language that I know, so I&#39;m pretty sure
I don&#39;t understand it well enough yet :) At the same time, I think implicits are
very characteristic for Scala: they are a powerful tool, which can be used in many
valid scenarios, or can be abused to shoot in one&#39;s feet.</p>
<h2 id="underscore-in-lambdas">Underscore In Lambdas</h2>
<p>Underscores <code>_</code> can be used to represent parameters in lambda expressions
without explicitly naming them:</p>
<pre class="highlight"><code class="hljs scala">employees.sortBy(_.dateOfBirth)
</code></pre>
<p>I think that&#39;s brilliant - very short and readable. Tuple values are represented
by <code>_1</code> and <code>_2</code>, so we can sort an array of tuples like</p>
<pre class="highlight"><code class="hljs scala">profitByYear.sortBy(_._1)
</code></pre>
<p>This looks a bit hairy and should probably be used only when the meaning is obvious.
(In the example above I&#39;m not sure if we sort by year or by profit...)</p>
<p>In F# underscore is used in a different sense - as &quot;something to ignore&quot;. That makes
sense, but I would love to have a shorter way of writing lambda in</p>
<pre class="highlight"><code class="hljs fs">empoyees |&gt; List.sort (<span class="hljs-keyword">fun</span> e -&gt; e.dateOfBirth)
</code></pre>
<p>Any hint how?</p>
<h2 id="tail-recursion-mark">Tail-Recursion Mark</h2>
<p>Any recursive function in Scala can be marked with <code>@tailrec</code> annotation,
which would result in compilation error if the function is not tail-recursive.
This guarantees that you won&#39;t get a nasty stack overflow exception. </p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-annotation">@tailrec</span> 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">boom</span>(</span>x: <span class="hljs-type">Int</span>): <span class="hljs-type">Int</span> = {
  <span class="hljs-keyword">if</span> (x == <span class="hljs-number">0</span>) <span class="hljs-number">0</span>
  <span class="hljs-keyword">else</span> boom(x-<span class="hljs-number">1</span>) + <span class="hljs-number">1</span>
}
</code></pre>
<p>The code above won&#39;t compile, as the recursion can&#39;t be optimized by the
compiler.</p>
<p>The feature sounds very reasonable, although I must admit that I have 
never needed it in <em>my</em> F# code yet.</p>
<h2 id="call-by-name">Call By Name</h2>
<p>When you call a function in F#, the parameter values are evaluated before
the function body. This style of function substitution model is known as
Call by Value.</p>
<p>Same is the default in Scala. But there is an alternative: you can defer the
evaluation of parameters by marking them with an <code>=&gt;</code> symbol:</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">callByName</span>(</span>x: =&gt; <span class="hljs-type">Int</span>) = {
  println(<span class="hljs-string">"x is "</span> + x)
}
</code></pre>
<p>This style is known as Call by Name, and the evaluation is defered until the
parameter is actually used. So, if parameter is never used, its value
will never be evaluated. This code:</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">a</span>:</span><span class="hljs-type">Option</span>[<span class="hljs-type">Int</span>] = <span class="hljs-type">Some</span>(<span class="hljs-number">1</span>)
<span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">b</span> =</span> a getOrElse (<span class="hljs-number">2</span>/<span class="hljs-number">0</span>)
</code></pre>
<p>will set <code>b</code> to <code>1</code>, and no error will be thrown, even though we are dividing by zero 
in function parameter. This is because the parameter of <code>getOrElse</code> is passed
by name.</p>
<p>The F# alternative <code>defaultArg</code> doesn&#39;t work this way, so the following code
will blow up:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> a = Some(<span class="hljs-number">1</span>)
<span class="hljs-keyword">let</span> b = defaultArg b (<span class="hljs-number">2</span>/<span class="hljs-number">0</span>) <span class="hljs-comment">// boom</span>
</code></pre>
<p>You can get deferred evaluation by passing a function:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> defaultArgFunc o (f: unit -&gt; <span class="hljs-attribute">'a</span>) = 
  <span class="hljs-keyword">match</span> o <span class="hljs-keyword">with</span> | Some v -&gt; v | None -&gt; f()

<span class="hljs-keyword">let</span> b2 = defaultArgFunc a (<span class="hljs-keyword">fun</span> () -&gt; <span class="hljs-number">2</span> / <span class="hljs-number">0</span>)
</code></pre>
<p>That&#39;s essentially what happens in Scala too, but the Scala syntax is 
arguably cleaner.</p>
<h2 id="lack-of-type-inference">Lack of Type Inference</h2>
<p>Slowly moving towards language design flavours, I&#39;ll start with Type Inference.
In Scala, type inference seems to be quite limited. Yes, you don&#39;t have to
explicitly define the types of local values or (most of the time) function return
types, but that&#39;s about it.</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">max</span> (</span>a: <span class="hljs-type">Int</span>, b:<span class="hljs-type">Int</span>) = <span class="hljs-keyword">if</span> (a &gt; b) a <span class="hljs-keyword">else</span> b
</code></pre>
<p>You have to specify the types of all input parameters, and that&#39;s quite a bummer
for people who are used to short type-less code of F# (or Haskell, OCaml and others, 
for that matter).</p>
<p>Type inference in F# plays another significant role: automatic type generalization.
F# compiler would make types as generic as possible, based on implementation.</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> max a b = <span class="hljs-keyword">if</span> a &gt; b <span class="hljs-keyword">then</span> a <span class="hljs-keyword">else</span> b
</code></pre>
<p>The type of the function above is <code>&#39;a -&gt; &#39;a -&gt; &#39;a</code>. Most people wouldn&#39;t make
it generic from get-go, but compiler helps in this case.</p>
<h2 id="functional-vs-object-oriented-style">Functional vs Object-Oriented Style</h2>
<p>Both F# and Scala are running on top of managed object-oriented virtual machines,
and at the same time both languages enable developers to write functional code.
Functional programming means operating immutable data structures in pure, free of
side effects operations. Without questioning all this, I find pure functional 
Scala code to be written in much more object-oriented <em>style</em> compared to F#.</p>
<p>Classes and objects are ubiquitous in Scala: they are in each example given 
in Martin Odersky&#39;s courses. Most F# examples refrain from classes unless needed.
F# official guidance is to never expose non-abstract classes from F# API!</p>
<p>Scala is really heavy about inheritance. They even introduced quasi-multiple inheritance:
traits. <code>Stream</code> inherits from <code>List</code>, and <code>Nothing</code> is a subtype of every other type, 
to be used for some covariance tricks.</p>
<p>Operations are usually defined as class methods instead of separate functions. For
example the following Scala code</p>
<pre class="highlight"><code class="hljs scala">word filter (c =&gt; c.isLetter)
</code></pre>
<p>would filter a string to letters only. Why is <code>isLetter</code> defined as a method of 
<code>Char</code>? I don&#39;t think it&#39;s essential for the type itself...</p>
<h2 id="usage-of-operators">Usage of Operators</h2>
<p>It looks like Scala culture inclines more towards the usage of different
operators, not only for arithmetic operations but also for different classes
from standard library and domain-specific code too. The basic ones are nice,
e.g. list concatenation:</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) ++ <span class="hljs-type">List</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
</code></pre>
<p>but others look awkward to me, e.g. stream concatenation:</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-type">Stream</span>(<span class="hljs-number">1</span>) #::: <span class="hljs-type">Stream</span>(<span class="hljs-number">2</span>)
</code></pre>
<p>Akka streams sweetness:</p>
<pre class="highlight"><code class="hljs scala">in ~&gt; f1 ~&gt; bcast ~&gt; f2 ~&gt; merge ~&gt; f3 ~&gt; out
            bcast ~&gt; f4 ~&gt; merge
</code></pre>
<p>This can go to quite an extreme, similar to what <code>scalaz</code> library does.</p>
<p>My default would be not to use operators unless you are sure that every 
reader is able to instantly understand what it means.</p>
<h2 id="partial-application">Partial Application</h2>
<p>Not a huge difference, but F# functions are curried by default, while Scala
functions aren&#39;t. Thus, in F# partial application just works, all the time</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> add a b = a + b
<span class="hljs-keyword">let</span> add3 = add <span class="hljs-number">3</span>
<span class="hljs-keyword">let</span> sum = add3 <span class="hljs-number">5</span> <span class="hljs-comment">// 8</span>
</code></pre>
<p>Scala function </p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span> (</span>a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>) = a + b
</code></pre>
<p>is not curried, but Underscore comes to the rescue</p>
<pre class="highlight"><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">add3</span>:</span> (<span class="hljs-type">Int</span>) =&gt; <span class="hljs-type">Int</span> = add(<span class="hljs-number">3</span>, _)
<span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">sum</span> =</span> add3(<span class="hljs-number">5</span>) <span class="hljs-comment">// 8</span>
</code></pre>
<p>Note how I miss the type inference again.</p>
<p>The parameter order is very important in F#: the short syntax
will partially apply parameters from left to right. In Scala, you can
put <code>_</code> at any position, which gives you some flexibility.</p>
<h2 id="single-direction-dependency">Single-Direction Dependency</h2>
<p>F# compiler doesn&#39;t allow circular dependencies. You can&#39;t use a function 
before you&#39;ve defined it. Here is what Expert F# book has to say about
that:</p>
<blockquote>
<p>Managing dependencies and circularity is one of the most difficult 
and fundamental problems in good software design. The files in 
an F# project are presented to the F# compiler in a compilation 
order: constructs in the earlier files can&#39;t refer to declarations 
in the later files. This is a mechanism to enforce layered design, 
where software is carefully organized into layers, and where one 
layer doesn&#39;t refer to other layers in a cyclic way (...) to help you 
write code that is reusable and organized 
into components that are, where possible, independent and not 
combined into a &quot;tangle&quot; of &quot;spaghetti code&quot;.</p>
</blockquote>
<p>I think this is huge. F# forces you to structure your code in a way that
avoid mutual dependencies between different functions, types and modules.
This reduces the complexity and coupling, makes the developers avoid some
of the design pitfalls.</p>
<p>There&#39;s nothing like that in Scala. You are on your own.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Of course I did not cover all the distinctions, for instance active patterns, 
type providers, computation expressions in F# and type classes, higher 
kinded types, macros in Scala.</p>
<p>Obviously, both Scala and F# are very capable languages, and I am still
picking up the basics of them. While similar in many aspects, they made
several different choices along the language design trade-offs.</p>
<p>P.S. Overheard on Twitter:</p>
<blockquote>
<p>F# isn&#39;t a bad language, it&#39;s just attached to a bad platform... 
The opposite of Scala actually.</p>
</blockquote>
<p>UPDATE: Thanks everyone for the great comments; please check out
<a href="https://redd.it/4whxhj">this reddit</a> and <a href="https://lobste.rs/s/ewhrpt">lobste.rs</a>
to see more of them.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/f#/'>F#</a>, <a href='/tags/scala/'>Scala</a>, <a href='/tags/functional-programming/'>Functional Programming</a>, <a href='/tags/coursera/'>Coursera</a>
    </div>
    
</article>


<div class="page-nav">
    
    <a class="page-nav-newer" href="/2"><span class="icon icon-arrow-left-2"></span> Next page</a>
    
    
    <a class="page-nav-older" href="/4">Previous page <span class="icon icon-arrow-right-2"></span></a>
    
</div>

<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy F#, C#, Javascript and SQL development, reasoning about distributed systems, data processing pipelines, cloud and web apps. I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="http://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="http://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2017 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>